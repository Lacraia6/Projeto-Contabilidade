{% extends "base.html" %}

{% block title %}Gerenciamento de Tarefas{% endblock %}

{% block content %}
    <style>
        /* Reset apenas para elementos dentro do conte√∫do */
        .gerenciamento-tarefas-container * {
            box-sizing: border-box;
        }
        
        .gerenciamento-tarefas-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .badge-version {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background-color: rgba(75, 181, 67, 0.15);
            border: 1px solid rgba(75, 181, 67, 0.4);
            border-radius: 999px;
            color: #9ae6b4;
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .badge-version i {
            color: #4bb543;
        }
        
        .header {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #38507f;
        }
        
        .header h1 {
            color: #f7fafc;
            margin-bottom: 10px;
            font-size: 28px;
        }
        
        .header p {
            color: #b8c2d3;
            font-size: 16px;
        }
        
        .button-group {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s ease;
        }
        
        .btn-success {
            background-color: #4bb543;
            color: white;
        }
        
        .btn-success:hover {
            background-color: #3a9d35;
            transform: translateY(-1px);
        }
        
        .btn-primary {
            background-color: #9eb6d8;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #4f6b99;
            transform: translateY(-1px);
        }
        
        .btn-secondary {
            background-color: #aeb8c7;
            color: white;
        }
        
        .card {
            background-color: #243b69;
            border: 1px solid #38507f;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .card h3 {
            margin-bottom: 20px;
            color: #f7fafc;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th {
            background-color: #2a4477;
            color: #f7fafc;
            padding: 12px;
            text-align: left;
            border: 1px solid #38507f;
            font-weight: 600;
        }
        
        td {
            background-color: #243b69;
            color: #f7fafc;
            padding: 12px;
            border: 1px solid #38507f;
        }
        
        tr:hover td {
            background-color: #2f4a82;
        }
        
        .badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .badge-info {
            background-color: #9eb6d8;
            color: white;
        }
        
        /* MODAL - ESTILO SIMPLES E FUNCIONAL */
        .modal {
            display: none !important;
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            height: 100% !important;
            background-color: rgba(0, 0, 0, 0.8) !important;
            z-index: 9999 !important;
            align-items: center !important;
            justify-content: center !important;
            visibility: hidden !important;
            opacity: 0 !important;
            transition: opacity 0.3s ease !important;
        }
        
        .modal.active {
            display: flex !important;
            visibility: visible !important;
            opacity: 1 !important;
        }
        
        .modal-content {
            background-color: #1f3558;
            border: 2px solid #9eb6d8;
            border-radius: 12px;
            width: 95%;
            max-width: 1300px;
            max-height: 95vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 25px 45px rgba(0, 0, 0, 0.4);
        }
        
        .modal-header {
            background-color: #243b69;
            padding: 20px;
            border-bottom: 1px solid #38507f;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h3 {
            color: #f7fafc;
            margin: 0;
        }
        
        .btn-close {
            background: none;
            border: none;
            color: #f7fafc;
            font-size: 28px;
            cursor: pointer;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }
        
        .btn-close:hover {
            background-color: #2f4a82;
            border-radius: 4px;
        }
        
        .modal-body {
            padding: 0;
            flex: 1;
            overflow: hidden;
        }
        
        .painel-vinculacao {
            display: flex;
            height: 100%;
            min-height: 60vh;
        }
        
        .painel-sidebar {
            width: 28%;
            padding: 20px;
            background: #1a2b4a;
            border-right: 1px solid #2e4777;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .painel-sidebar h4 {
            margin: 0;
            font-size: 16px;
            color: #f7fafc;
        }
        
        .painel-sidebar .input-with-icon,
        .painel-main .input-with-icon {
            position: relative;
        }
        
        .input-with-icon i {
            position: absolute;
            top: 50%;
            left: 12px;
            transform: translateY(-50%);
            color: #8ea2c6;
        }
        
        .input-with-icon input {
            padding-left: 36px;
        }
        
        .lista-empresas {
            flex: 1;
            overflow-y: auto;
            border: 1px solid #2e4777;
            border-radius: 8px;
            background: #1f3558;
        }
        
        .empresa-item {
            padding: 12px 14px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            cursor: pointer;
            transition: background 0.2s ease;
        }
        
        .empresa-item:hover {
            background: rgba(158, 182, 216, 0.08);
        }
        
        .empresa-item.active {
            background: rgba(79, 107, 153, 0.35);
            border-left: 3px solid #9eb6d8;
        }
        
        .painel-main {
            flex: 1;
            padding: 20px 24px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .painel-main-header {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .empresa-selecionada-chip {
            background: rgba(79, 107, 153, 0.2);
            border: 1px solid rgba(158, 182, 216, 0.4);
            border-radius: 999px;
            padding: 8px 16px;
            color: #9eb6d8;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }
        
        .painel-main-filtros {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .painel-main-filtros > * {
            flex: 1;
            min-width: 220px;
        }
        
        .tarefas-lista {
            flex: 1;
            border: 1px solid #2e4777;
            border-radius: 8px;
            background: #1a2b4a;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .tarefas-lista-header {
            padding: 12px 16px;
            border-bottom: 1px solid #2e4777;
            color: #9eb6d8;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .tarefas-lista-body {
            flex: 1;
            overflow-y: auto;
        }
        
        .tarefa-card {
            padding: 16px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            display: flex;
            gap: 12px;
        }
        
        .tarefa-card:hover {
            background: rgba(79, 107, 153, 0.12);
        }
        
        .tarefa-card .checkbox-wrapper {
            display: flex;
            align-items: flex-start;
        }
        
        .tarefa-card input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: #4bb543;
        }
        
        .tarefa-card-details {
            flex: 1;
        }
        
        .tarefa-card-details h5 {
            margin: 0;
            color: #f7fafc;
            font-size: 15px;
        }
        
        .tarefa-meta {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 6px;
            font-size: 12px;
            color: #9eb6d8;
        }
        
        .tarefa-meta span {
            background: rgba(255,255,255,0.08);
            padding: 4px 8px;
            border-radius: 6px;
        }
        
        .painel-selecao-resumo {
            border-top: 1px solid #2e4777;
            padding-top: 15px;
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        
        .resumo-tarefas-selecionadas {
            flex: 1;
            min-width: 240px;
            color: #9eb6d8;
            font-size: 14px;
        }
        
        .responsavel-selector {
            width: 320px;
            max-width: 100%;
        }
        
        .responsavel-resultados {
            margin-top: 8px;
            border: 1px solid #2e4777;
            border-radius: 8px;
            max-height: 200px;
            overflow-y: auto;
            display: none;
            background: #1f3558;
        }
        
        .responsavel-item {
            padding: 10px 14px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            cursor: pointer;
        }
        
        .responsavel-item:hover {
            background: rgba(158, 182, 216, 0.12);
        }
        
        .modal-footer {
            background-color: #243b69;
            padding: 18px 24px;
            border-top: 1px solid #38507f;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .modal-footer span {
            color: #9eb6d8;
            font-size: 14px;
        }
        
        .modal-footer {
            background-color: #243b69;
            padding: 15px 20px;
            border-top: 1px solid #38507f;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            color: #f7fafc;
            font-weight: 500;
            margin-bottom: 6px;
            display: block;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 10px;
            background-color: #243b69;
            color: #f7fafc;
            border: 1px solid #38507f;
            border-radius: 4px;
            font-size: 14px;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #9eb6d8;
            box-shadow: 0 0 0 2px rgba(158, 182, 216, 0.2);
        }
    </style>
    
    <div class="gerenciamento-tarefas-container">
        
        <!-- Header -->
        <div class="header">
            <h1><i class="fas fa-tasks"></i> Gerenciamento de Tarefas</h1>
            <p>Sistema LIMPO e FUNCIONAL - Teste Real</p>
            <p style="font-size: 12px; color: #aeb8c7;">Usu√°rio: {{ usuario.nome }} ({{ usuario.tipo }})</p>
        </div>

        <!-- Bot√µes -->
        <div class="button-group">
            <button class="btn btn-success" onclick="abrirModalTarefa()">
                <i class="fas fa-plus"></i> Nova Tarefa
            </button>
            <button class="btn btn-primary" onclick="abrirModalVincular()">
                <i class="fas fa-link"></i> Vincular Respons√°vel
            </button>
            <a href="/gerenciamento/" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Voltar
            </a>
        </div>

        <!-- Lista de Tarefas -->
        <div class="card">
            <h3><i class="fas fa-list"></i> Tarefas do Setor</h3>
            
            <table>
                <thead>
                    <tr>
                        <th>Nome</th>
                        <th>Tipo</th>
                        <th>Setor</th>
                    </tr>
                </thead>
                <tbody id="listaTarefas">
                    <tr>
                        <td colspan="3" style="text-align: center; padding: 30px;">
                            <i class="fas fa-spinner fa-spin"></i> Carregando tarefas...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

    </div>

    <!-- MODAL CRIAR TAREFA (100% INDEPENDENTE) -->
    <div id="modalTarefa" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-plus"></i> Nova Tarefa</h3>
                <button class="btn-close" onclick="fecharModalTarefa()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Nome da Tarefa *</label>
                    <input type="text" id="tarefaNome" placeholder="Ex: Apura√ß√£o ICMS">
                </div>
                
                <div class="form-group">
                    <label>Tipo *</label>
                    <select id="tarefaTipo">
                        <option value="">Selecione</option>
                        <option value="Mensal">Mensal</option>
                        <option value="Trimestral">Trimestral</option>
                        <option value="Anual">Anual</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Setor *</label>
                    <select id="tarefaSetor">
                        <option value="">Selecione</option>
                        {% for setor in setores %}
                        <option value="{{ setor.id }}">{{ setor.nome }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Tributa√ß√£o</label>
                    <select id="tarefaTributacao">
                        <option value="">Deixe vazio para tarefa comum</option>
                        <option value="1">Simples Nacional</option>
                        <option value="2">Regime Normal</option>
                    </select>
                    <small style="color: #b8c2d3; font-size: 12px;">Deixe vazio se a tarefa aplicar a ambas tributa√ß√µes</small>
                </div>
                
                <div class="form-group">
                    <label>Descri√ß√£o</label>
                    <textarea id="tarefaDescricao" rows="3" placeholder="Descri√ß√£o opcional..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="fecharModalTarefa()">Cancelar</button>
                <button class="btn btn-success" onclick="salvarTarefa()">
                    <i class="fas fa-save"></i> Criar Tarefa
                </button>
            </div>
        </div>
    </div>

    <!-- MODAL VINCULAR - VISUALIZA√á√ÉO AMPLIADA -->
    <div id="modalVincular" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div>
                <h3><i class="fas fa-link"></i> Vincular Respons√°vel</h3>
                    <p style="color: #9eb6d8; margin: 5px 0 0;">Visualize todas as tarefas dispon√≠veis, filtre por empresa, tributa√ß√£o ou descri√ß√£o e fa√ßa a vincula√ß√£o em lote.</p>
                </div>
                <div style="display: flex; align-items: center; gap: 12px;">
                    <span class="badge-version"><i class="fas fa-plug"></i> Painel Standalone v2</span>
                <button class="btn-close" onclick="fecharModalVincular()">&times;</button>
                </div>
            </div>
            <div class="modal-body">
                <div class="painel-vinculacao">
                    <aside class="painel-sidebar">
                        <div>
                            <h4><i class="fas fa-building"></i> Empresas</h4>
                            <p style="color: #9eb6d8; font-size: 13px; margin-top: 4px;">Busque ou filtre as empresas do seu setor.</p>
                    </div>
                        <div class="input-with-icon">
                            <i class="fas fa-search"></i>
                            <input type="text" id="filtroEmpresaPainel" placeholder="Buscar empresa..." autocomplete="off" oninput="buscarEmpresasPainel(this.value)">
                </div>
                        <div class="lista-empresas" id="listaEmpresasPainel">
                            <p style="color: #9eb6d8; padding: 16px;">Digite no campo de busca para listar as empresas.</p>
                        </div>
                    </aside>
                    <section class="painel-main">
                        <div class="painel-main-header">
                            <div class="empresa-selecionada-chip" id="chipEmpresaSelecionada" style="display: none;">
                                <i class="fas fa-building"></i>
                                <span id="chipEmpresaNome"></span>
                                <small id="chipEmpresaTributacao" style="color: #9ae6b4;"></small>
                                <button onclick="limparEmpresaSelecionada()" style="background: none; border: none; color: #f87171; cursor: pointer;">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div class="painel-main-filtros">
                                <div class="input-with-icon">
                                    <i class="fas fa-search"></i>
                                    <input type="text" id="filtroTarefaPainel" placeholder="Filtrar por tarefa..." autocomplete="off" oninput="aplicarFiltroLocalTarefas()">
                                </div>
                                <select id="filtroTributacaoPainel" onchange="aplicarFiltroLocalTarefas()" style="background-color: #243b69; color: #f7fafc; border: 1px solid #2e4777;">
                                    <option value="">Todas as tributa√ß√µes</option>
                                    <option value="common">Apenas tarefas comuns</option>
                                    {% for trib in tributacoes %}
                                    <option value="{{ trib.id }}">{{ trib.nome }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="tarefas-lista">
                            <div class="tarefas-lista-header">
                                <span id="totalTarefasDisponiveis">Selecione uma empresa para visualizar as tarefas dispon√≠veis</span>
                            </div>
                            <div class="tarefas-lista-body" id="listaTarefasPainel">
                                <p style="padding: 20px; color: #9eb6d8;">Escolha uma empresa na coluna da esquerda para carregar as tarefas.</p>
                            </div>
                        </div>
                        <div class="painel-selecao-resumo">
                            <div class="resumo-tarefas-selecionadas">
                                <strong style="color: #f7fafc;">Tarefas selecionadas</strong>
                                <div id="resumoSelecaoTarefas" style="margin-top: 8px;">Nenhuma tarefa selecionada.</div>
                            </div>
                            <div class="responsavel-selector">
                                <label>Respons√°vel *</label>
                                <div class="input-with-icon">
                                    <i class="fas fa-user"></i>
                                    <input type="text" id="responsavelPainelInput" placeholder="Buscar respons√°vel..." autocomplete="off" oninput="buscarResponsavelPainel(this.value)">
                                </div>
                                <div class="responsavel-resultados" id="responsavelPainelResultados"></div>
                                <div id="responsavelSelecionadoResumo" style="margin-top: 10px; color: #9ae6b4;"></div>
                                <input type="hidden" id="responsavelSelecionadoId" value="">
                            </div>
                        </div>
                    </section>
                </div>
            </div>
            <div class="modal-footer">
                <span id="quantidadeTarefasSelecionadas">0 tarefas selecionadas</span>
                <div style="display: flex; gap: 10px;">
                <button class="btn btn-secondary" onclick="fecharModalVincular()">Cancelar</button>
                    <button class="btn btn-primary" onclick="salvarVinculacao()" id="btnConfirmarVinculacao" disabled>
                    <i class="fas fa-save"></i> Vincular
                </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        console.log('Painel Standalone v2 carregado');
        console.log('‚úÖ P√ÅGINA STANDALONE CARREGADA');
        
        // ===== MODAL TAREFA =====
        function abrirModalTarefa() {
            console.log('üìù Abrindo modal tarefa');
            const modal = document.getElementById('modalTarefa');
            console.log('Modal encontrado:', modal);
            if (modal) {
                modal.classList.add('active');
                modal.style.display = 'flex';
                modal.style.visibility = 'visible';
                modal.style.opacity = '1';
                modal.style.zIndex = '9999';
                console.log('‚úÖ Modal ativado');
            } else {
                console.error('‚ùå Modal n√£o encontrado!');
                alert('Erro: Modal n√£o encontrado. Verifique o HTML.');
            }
        }
        
        function fecharModalTarefa() {
            console.log('üö™ Fechando modal tarefa');
            const modal = document.getElementById('modalTarefa');
            if (modal) {
                modal.classList.remove('active');
                modal.style.display = 'none';
                modal.style.visibility = 'hidden';
                modal.style.opacity = '0';
            }
        }
        
        function salvarTarefa() {
            console.log('üíæ Salvando tarefa');
            
            const nome = document.getElementById('tarefaNome').value;
            const tipo = document.getElementById('tarefaTipo').value;
            const setor = document.getElementById('tarefaSetor').value;
            const tributacao = document.getElementById('tarefaTributacao').value;
            const descricao = document.getElementById('tarefaDescricao').value;
            
            if (!nome || !tipo || !setor) {
                alert('Preencha os campos obrigat√≥rios: Nome, Tipo e Setor');
                return;
            }
            
            const dados = {
                nome: nome,
                tipo: tipo,
                setor_id: parseInt(setor),
                tributacao_id: tributacao ? parseInt(tributacao) : null,
                descricao: descricao,
                tarefa_comum: tributacao ? false : true  // Se n√£o selecionou tributa√ß√£o, √© tarefa comum
            };
            
            console.log('üì§ Enviando dados:', dados);
            
            fetch('/tarefas-melhoradas/api/tarefas', {
                method: 'POST',
                credentials: 'same-origin',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(dados)
            })
            .then(r => r.json())
            .then(data => {
                console.log('üì• Resposta:', data);
                if (data.success) {
                    alert('‚úÖ Tarefa criada com sucesso!');
                    fecharModalTarefa();
                    // Limpar campos
                    document.getElementById('tarefaNome').value = '';
                    document.getElementById('tarefaTipo').value = '';
                    document.getElementById('tarefaSetor').value = '';
                    document.getElementById('tarefaTributacao').value = '';
                    document.getElementById('tarefaDescricao').value = '';
                    carregarTarefas();
                } else {
                    alert('‚ùå Erro: ' + data.message);
                }
            })
            .catch(error => {
                console.error('‚ùå Erro:', error);
                alert('‚ùå Erro ao criar tarefa');
            });
        }
        
        // ===== MODAL VINCULA√á√ÉO AVAN√áADA =====
        const painelVinculacaoState = {
            empresas: [],
            empresaSelecionada: null,
            tarefasDisponiveis: [],
            tarefasFiltradas: [],
            tarefasSelecionadas: new Map(),
            responsavelSelecionado: null,
            filtros: {
                empresa: '',
                tarefa: '',
                tributacao: ''
            }
        };
        let filtroTarefaTimeout = null;

        function abrirModalVincular() {
            console.log('üìù Abrindo modal vincular');
            const modal = document.getElementById('modalVincular');
            if (!modal) {
                console.error('‚ùå Modal n√£o encontrado!');
                alert('Modal n√£o encontrado. Atualize a p√°gina e tente novamente.');
                return;
            }
                modal.classList.add('active');
            modal.style.display = 'flex';
            modal.style.visibility = 'visible';
            modal.style.opacity = '1';
            modal.style.zIndex = '9999';
                console.log('‚úÖ Modal ativado');
            resetPainelVinculacao();
            buscarEmpresasPainel('');
        }
        
        function fecharModalVincular() {
            console.log('üö™ Fechando modal vincular');
            const modal = document.getElementById('modalVincular');
            if (modal) {
                modal.classList.remove('active');
                modal.style.display = 'none';
                modal.style.visibility = 'hidden';
                modal.style.opacity = '0';
            }
            resetPainelVinculacao();
        }

        function resetPainelVinculacao() {
            painelVinculacaoState.empresaSelecionada = null;
            painelVinculacaoState.tarefasDisponiveis = [];
            painelVinculacaoState.tarefasFiltradas = [];
            painelVinculacaoState.tarefasSelecionadas = new Map();
            painelVinculacaoState.responsavelSelecionado = null;
            painelVinculacaoState.filtros = { empresa: '', tarefa: '', tributacao: '' };

            const empresaInput = document.getElementById('filtroEmpresaPainel');
            if (empresaInput) empresaInput.value = '';
            const tarefaInput = document.getElementById('filtroTarefaPainel');
            if (tarefaInput) tarefaInput.value = '';
            const tribInput = document.getElementById('filtroTributacaoPainel');
            if (tribInput) tribInput.value = '';

            const listaEmpresas = document.getElementById('listaEmpresasPainel');
            if (listaEmpresas) listaEmpresas.innerHTML = '<p style="color:#9eb6d8; padding:16px;">Digite no campo de busca para listar as empresas.</p>';

            const chip = document.getElementById('chipEmpresaSelecionada');
            if (chip) chip.style.display = 'none';

            const listaTarefas = document.getElementById('listaTarefasPainel');
            if (listaTarefas) listaTarefas.innerHTML = '<p style="padding:20px; color:#9eb6d8;">Escolha uma empresa para visualizar as tarefas.</p>';

            const total = document.getElementById('totalTarefasDisponiveis');
            if (total) total.textContent = 'Selecione uma empresa para visualizar as tarefas dispon√≠veis';

            const resumo = document.getElementById('resumoSelecaoTarefas');
            if (resumo) resumo.textContent = 'Nenhuma tarefa selecionada.';

            const qtd = document.getElementById('quantidadeTarefasSelecionadas');
            if (qtd) qtd.textContent = '0 tarefas selecionadas';

            const respInput = document.getElementById('responsavelPainelInput');
            if (respInput) respInput.value = '';
            const respResumo = document.getElementById('responsavelSelecionadoResumo');
            if (respResumo) respResumo.textContent = '';
            const respResultados = document.getElementById('responsavelPainelResultados');
            if (respResultados) {
                respResultados.innerHTML = '';
                respResultados.style.display = 'none';
            }
            const respHidden = document.getElementById('responsavelSelecionadoId');
            if (respHidden) respHidden.value = '';

            const btn = document.getElementById('btnConfirmarVinculacao');
            if (btn) btn.disabled = true;
        }

        function buscarEmpresasPainel(query = '') {
            painelVinculacaoState.filtros.empresa = query;
            const lista = document.getElementById('listaEmpresasPainel');
            if (!lista) return;

            lista.innerHTML = '<p style="color:#9eb6d8; padding:16px;"><i class="fas fa-spinner fa-spin"></i> Carregando empresas...</p>';

            fetch(`/tarefas-melhoradas/api/empresas?search=${encodeURIComponent(query)}&limit=100`, {
                credentials: 'same-origin'
            })
                .then(response => response.json())
            .then(data => {
                    if (data.success) {
                        renderEmpresasPainel(data.empresas || []);
                    } else {
                        lista.innerHTML = `<p style="color:#ff6b6b; padding:16px;">${data.message || 'Erro ao carregar empresas.'}</p>`;
                    }
            })
            .catch(error => {
                    console.error('Erro ao carregar empresas:', error);
                    lista.innerHTML = '<p style="color:#ff6b6b; padding:16px;">Erro ao carregar empresas.</p>';
                });
        }

        function renderEmpresasPainel(empresas) {
            painelVinculacaoState.empresas = empresas;
            const lista = document.getElementById('listaEmpresasPainel');
            if (!lista) return;

            if (!empresas.length) {
                lista.innerHTML = '<p style="color:#9eb6d8; padding:16px;">Nenhuma empresa encontrada.</p>';
                return;
            }
            
            lista.innerHTML = empresas.map(empresa => `
                <div class="empresa-item ${painelVinculacaoState.empresaSelecionada && painelVinculacaoState.empresaSelecionada.id === empresa.id ? 'active' : ''}"
                     onclick="selecionarEmpresaPainel(${empresa.id})">
                    <strong>${empresa.nome}</strong>
                    <div style="font-size:12px; color:#9eb6d8;">${empresa.tributacao_nome || 'Tributa√ß√£o n√£o definida'}</div>
                </div>
            `).join('');
        }
        
        function selecionarEmpresaPainel(empresaId) {
            const empresa = painelVinculacaoState.empresas.find(e => e.id === empresaId);
            if (!empresa) return;

            painelVinculacaoState.empresaSelecionada = empresa;
            painelVinculacaoState.tarefasSelecionadas.clear();
            atualizarResumoSelecao();

            const chip = document.getElementById('chipEmpresaSelecionada');
            if (chip) {
                chip.style.display = 'inline-flex';
                document.getElementById('chipEmpresaNome').textContent = empresa.nome;
                document.getElementById('chipEmpresaTributacao').textContent = empresa.tributacao_nome || 'Tributa√ß√£o n√£o definida';
            }

            const total = document.getElementById('totalTarefasDisponiveis');
            if (total) total.textContent = 'Carregando tarefas...';

            carregarTarefasDisponiveisPainel();
        }

        function limparEmpresaSelecionada() {
            painelVinculacaoState.empresaSelecionada = null;
            painelVinculacaoState.tarefasDisponiveis = [];
            painelVinculacaoState.tarefasFiltradas = [];
            painelVinculacaoState.tarefasSelecionadas.clear();
            atualizarResumoSelecao();

            const chip = document.getElementById('chipEmpresaSelecionada');
            if (chip) chip.style.display = 'none';

            const total = document.getElementById('totalTarefasDisponiveis');
            if (total) total.textContent = 'Selecione uma empresa para visualizar as tarefas dispon√≠veis';

            const lista = document.getElementById('listaTarefasPainel');
            if (lista) lista.innerHTML = '<p style="padding:20px; color:#9eb6d8;">Escolha uma empresa para visualizar as tarefas.</p>';

            const btn = document.getElementById('btnConfirmarVinculacao');
            if (btn) btn.disabled = true;
        }

        function carregarTarefasDisponiveisPainel() {
            const empresa = painelVinculacaoState.empresaSelecionada;
            const lista = document.getElementById('listaTarefasPainel');
            
            if (!empresa) {
                console.error('‚ùå Nenhuma empresa selecionada');
                if (lista) lista.innerHTML = '<p style="padding:20px; color:#ff6b6b;">Erro: Nenhuma empresa selecionada.</p>';
                return;
            }
            
            if (!lista) {
                console.error('‚ùå Elemento listaTarefasPainel n√£o encontrado');
                return;
            }
            
            if (!empresa.id) {
                console.error('‚ùå Empresa sem ID:', empresa);
                lista.innerHTML = '<p style="padding:20px; color:#ff6b6b;">Erro: ID da empresa inv√°lido.</p>';
                return;
            }

            lista.innerHTML = '<p style="padding:20px; color:#9eb6d8;"><i class="fas fa-spinner fa-spin"></i> Carregando tarefas...</p>';

            const url = `/tarefas-melhoradas/api/empresas/${empresa.id}/tarefas-disponiveis`;
            console.log('üîç Buscando tarefas dispon√≠veis:', url);
            console.log('üìä Empresa selecionada:', empresa);
            
            fetch(url, {
                credentials: 'same-origin',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                }
            })
                .then(response => {
                    console.log('üì° Response status tarefas:', response.status);
                    console.log('üì° Response headers:', response.headers.get('content-type'));
                    
                    if (!response.ok) {
                        return response.text().then(text => {
                            console.error('‚ùå Resposta de erro tarefas:', text.substring(0, 200));
                            throw new Error(`HTTP ${response.status}: ${text.substring(0, 100)}`);
                        });
                    }
                    
                    // Verificar se a resposta √© JSON
                    const contentType = response.headers.get('content-type');
                    if (!contentType || !contentType.includes('application/json')) {
                        return response.text().then(text => {
                            console.error('‚ùå Resposta n√£o √© JSON:', text.substring(0, 200));
                            throw new Error(`Resposta inv√°lida do servidor. Status: ${response.status}`);
                        });
                    }
                    
                    return response.json();
                })
                .then(data => {
                    console.log('üìä Dados recebidos da API:', data);
                    if (data.success) {
                        painelVinculacaoState.tarefasDisponiveis = data.tarefas || [];
                        painelVinculacaoState.tarefasFiltradas = [...painelVinculacaoState.tarefasDisponiveis];
                        const total = document.getElementById('totalTarefasDisponiveis');
                        const totalTarefas = data.total || painelVinculacaoState.tarefasDisponiveis.length;
                        
                        if (total) {
                            if (totalTarefas === 0) {
                                total.textContent = 'Nenhuma tarefa dispon√≠vel para esta empresa';
                            } else {
                                total.textContent = `${totalTarefas} tarefa(s) dispon√≠vel(eis)`;
                            }
                        }
                        
                        if (totalTarefas === 0) {
                            lista.innerHTML = '<p style="padding:20px; color:#9eb6d8; text-align:center;"><i class="fas fa-info-circle"></i> Todas as tarefas do seu setor j√° est√£o vinculadas a esta empresa.</p>';
                        } else {
                            aplicarFiltroLocalTarefas(true);
                        }
                    } else {
                        console.error('‚ùå API retornou erro:', data.message);
                        lista.innerHTML = `<p style="padding:20px; color:#ff6b6b;"><i class="fas fa-exclamation-triangle"></i> ${data.message || 'Erro ao carregar tarefas.'}</p>`;
                    }
                })
                .catch(error => {
                    console.error('‚ùå Erro ao carregar tarefas:', error);
                    lista.innerHTML = `<p style="padding:20px; color:#ff6b6b;"><i class="fas fa-exclamation-triangle"></i> Erro ao carregar tarefas: ${error.message || 'Erro desconhecido'}</p>`;
                });
        }

        function aplicarFiltroLocalTarefas(forceRender = false) {
            const termo = (document.getElementById('filtroTarefaPainel')?.value || '').trim().toLowerCase();
            const filtroTrib = document.getElementById('filtroTributacaoPainel')?.value || '';

            painelVinculacaoState.filtros.tarefa = termo;
            painelVinculacaoState.filtros.tributacao = filtroTrib;

            const executarFiltro = () => {
                painelVinculacaoState.tarefasFiltradas = painelVinculacaoState.tarefasDisponiveis.filter(tarefa => {
                    const matchNome = !termo || tarefa.nome.toLowerCase().includes(termo);
                    let matchTrib = true;
                    if (filtroTrib === 'common') {
                        matchTrib = tarefa.tarefa_comum;
                    } else if (filtroTrib) {
                        matchTrib = String(tarefa.tributacao_id || '') === filtroTrib;
                    }
                    return matchNome && matchTrib;
                });
                atualizarListaTarefasPainel();
            };

            if (forceRender) {
                executarFiltro();
            } else {
                clearTimeout(filtroTarefaTimeout);
                filtroTarefaTimeout = setTimeout(executarFiltro, 250);
            }
        }

        function atualizarListaTarefasPainel() {
            const lista = document.getElementById('listaTarefasPainel');
            if (!lista) return;

            const tarefas = painelVinculacaoState.tarefasFiltradas;
            if (!tarefas.length) {
                lista.innerHTML = '<p style="padding:20px; color:#9eb6d8;">Nenhuma tarefa dispon√≠vel com os filtros atuais.</p>';
                return;
            }

            lista.innerHTML = tarefas.map(tarefa => `
                <div class="tarefa-card">
                    <div class="checkbox-wrapper">
                        <input type="checkbox" ${painelVinculacaoState.tarefasSelecionadas.has(tarefa.id) ? 'checked' : ''}
                               onchange="toggleSelecaoTarefa(${tarefa.id}, this.checked)">
                    </div>
                    <div class="tarefa-card-details">
                        <h5>${tarefa.nome}</h5>
                        <div class="tarefa-meta">
                            <span>${tarefa.tipo || 'Tipo n√£o definido'}</span>
                            <span>${tarefa.setor || 'Setor n√£o definido'}</span>
                            <span>${tarefa.tarefa_comum ? 'Tarefa Comum' : (tarefa.tributacao || 'Tributa√ß√£o n√£o definida')}</span>
                        </div>
                        ${tarefa.descricao ? `<p style="margin-top:8px; color:#b8c2d3; font-size:13px;">${tarefa.descricao}</p>` : ''}
                    </div>
                </div>
            `).join('');
        }

        function toggleSelecaoTarefa(tarefaId, marcado) {
            const id = Number(tarefaId);
            const tarefa = painelVinculacaoState.tarefasDisponiveis.find(t => t.id === id);
            if (!tarefa) return;

            if (marcado) {
                painelVinculacaoState.tarefasSelecionadas.set(id, tarefa);
            } else {
                painelVinculacaoState.tarefasSelecionadas.delete(id);
            }

            atualizarResumoSelecao();
        }

        function atualizarResumoSelecao() {
            const totalSelecionadas = painelVinculacaoState.tarefasSelecionadas.size;
            const resumo = document.getElementById('resumoSelecaoTarefas');
            const quantidade = document.getElementById('quantidadeTarefasSelecionadas');
            const btn = document.getElementById('btnConfirmarVinculacao');

            if (quantidade) quantidade.textContent = `${totalSelecionadas} tarefa(s) selecionada(s)`;

            if (resumo) {
                if (totalSelecionadas === 0) {
                    resumo.textContent = 'Nenhuma tarefa selecionada.';
                } else {
                    const nomes = Array.from(painelVinculacaoState.tarefasSelecionadas.values()).map(t => `‚Ä¢ ${t.nome}`);
                    const preview = nomes.slice(0, 4).join('<br>');
                    resumo.innerHTML = preview + (nomes.length > 4 ? `<br><small style="color:#9eb6d8;">+ ${nomes.length - 4} outras</small>` : '');
                }
            }

            const pronto = totalSelecionadas > 0 && !!painelVinculacaoState.responsavelSelecionado && !!painelVinculacaoState.empresaSelecionada;
            if (btn) btn.disabled = !pronto;
        }

        function buscarResponsavelPainel(query) {
            const resultadosDiv = document.getElementById('responsavelPainelResultados');
            if (!resultadosDiv) return;

            const termo = query ? query.trim() : '';
            // Permitir busca mesmo com 1 caractere para facilitar
            if (termo.length < 1) {
                resultadosDiv.style.display = 'none';
                resultadosDiv.innerHTML = '';
                return;
            }

            resultadosDiv.style.display = 'block';
            resultadosDiv.innerHTML = '<p style="color:#9eb6d8; padding:10px;"><i class="fas fa-spinner fa-spin"></i> Buscando respons√°veis...</p>';

            const url = `/tarefas-melhoradas/api/responsaveis?q=${encodeURIComponent(termo)}&limit=30`;
            console.log('üîç Buscando respons√°veis:', url);
            
            fetch(url, {
                credentials: 'same-origin',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                }
            })
                .then(response => {
                    console.log('üì• Response status respons√°veis:', response.status);
                    console.log('üì• Response headers:', response.headers.get('content-type'));
                    
                    if (!response.ok) {
                        return response.text().then(text => {
                            console.error('‚ùå Resposta de erro:', text.substring(0, 200));
                            throw new Error(`HTTP ${response.status}: ${text.substring(0, 100)}`);
                        });
                    }
                    
                    const contentType = response.headers.get('content-type');
                    if (!contentType || !contentType.includes('application/json')) {
                        return response.text().then(text => {
                            console.error('‚ùå Resposta n√£o √© JSON:', text.substring(0, 200));
                            throw new Error(`Resposta inv√°lida do servidor. Status: ${response.status}`);
                        });
                    }
                    
                    return response.json();
                })
                .then(data => {
                    console.log('üìä Dados recebidos respons√°veis:', data);
                    console.log('üìä Total de respons√°veis:', data.responsaveis ? data.responsaveis.length : 0);
                    if (data.success && data.responsaveis && data.responsaveis.length > 0) {
                        console.log('‚úÖ Renderizando', data.responsaveis.length, 'respons√°veis');
                        resultadosDiv.innerHTML = data.responsaveis.map(resp => {
                            const nome = (resp.nome || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
                            const setor = (resp.setor || 'N/A').replace(/'/g, "\\'").replace(/"/g, '&quot;');
                            return `
                                <div class="responsavel-item" onclick="selecionarResponsavelPainel(${resp.id}, '${nome}', '${setor}')">
                                    <strong>${resp.nome}</strong><br>
                                    <small>${resp.setor || 'N/A'}</small>
                                </div>
                            `;
                        }).join('');
                    } else {
                        console.log('‚ö†Ô∏è Nenhum respons√°vel encontrado. Success:', data.success, 'Responsaveis:', data.responsaveis);
                        resultadosDiv.innerHTML = '<p style="color:#9eb6d8; padding:10px;">Nenhum respons√°vel encontrado. Verifique se h√° colaboradores do seu setor cadastrados.</p>';
                    }
                })
                .catch(error => {
                    console.error('‚ùå Erro ao buscar respons√°veis:', error);
                    resultadosDiv.innerHTML = `<p style="color:#ff6b6b; padding:10px;">Erro ao buscar respons√°veis: ${error.message || 'Erro desconhecido'}</p>`;
                });
        }

        function selecionarResponsavelPainel(id, nome, setor) {
            painelVinculacaoState.responsavelSelecionado = { id, nome, setor };
            const input = document.getElementById('responsavelPainelInput');
            if (input) input.value = nome;

            const resumo = document.getElementById('responsavelSelecionadoResumo');
            if (resumo) resumo.textContent = `Respons√°vel selecionado: ${nome} (${setor || 'Setor n√£o informado'})`;

            const resultadosDiv = document.getElementById('responsavelPainelResultados');
            if (resultadosDiv) {
                resultadosDiv.style.display = 'none';
                resultadosDiv.innerHTML = '';
            }

            const hidden = document.getElementById('responsavelSelecionadoId');
            if (hidden) hidden.value = id;

            atualizarResumoSelecao();
        }

        document.addEventListener('click', function(event) {
            const resultados = document.getElementById('responsavelPainelResultados');
            const input = document.getElementById('responsavelPainelInput');
            if (resultados && input && !resultados.contains(event.target) && !input.contains(event.target)) {
                resultados.style.display = 'none';
            }
        });
        
        function salvarVinculacao() {
            const empresa = painelVinculacaoState.empresaSelecionada;
            const responsavel = painelVinculacaoState.responsavelSelecionado;
            const tarefasSelecionadas = Array.from(painelVinculacaoState.tarefasSelecionadas.keys());

            if (!empresa) {
                alert('Selecione uma empresa.');
                return;
            }
            if (!tarefasSelecionadas.length) {
                alert('Selecione pelo menos uma tarefa para vincular.');
                return;
            }
            if (!responsavel) {
                alert('Selecione um respons√°vel.');
                return;
            }

            const btn = document.getElementById('btnConfirmarVinculacao');
            if (btn) {
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Vinculando';
            }

            fetch('/tarefas-melhoradas/api/vincular-responsavel', {
                method: 'POST',
                credentials: 'same-origin',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    empresa_id: empresa.id,
                    responsavel_id: responsavel.id,
                    tarefas: tarefasSelecionadas
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('‚úÖ ' + (data.message || 'Vincula√ß√£o realizada com sucesso!'));
                        painelVinculacaoState.tarefasSelecionadas.clear();
                        atualizarResumoSelecao();
                        carregarTarefasDisponiveisPainel();
                    } else {
                        alert('‚ùå ' + (data.message || 'Erro ao salvar vincula√ß√£o.'));
                    }
                })
                .catch(error => {
                    console.error('Erro ao salvar vincula√ß√£o:', error);
                    alert('‚ùå Erro ao salvar vincula√ß√£o.');
                })
                .finally(() => {
                    if (btn) {
                        btn.disabled = false;
                        btn.innerHTML = '<i class="fas fa-save"></i> Vincular';
                    }
                });
        }
        
        // ===== CARREGAR TAREFAS =====
        function carregarTarefas() {
            console.log('üìã Carregando tarefas');
            
            fetch('/tarefas-melhoradas/api/tarefas', {
                credentials: 'same-origin'
            })
            .then(r => r.json())
            .then(data => {
                console.log('Tarefas recebidas:', data);
                if (data.success && data.tarefas) {
                    mostrarTarefas(data.tarefas);
                } else {
                    document.getElementById('listaTarefas').innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 30px; color: #b8c2d3;">Nenhuma tarefa encontrada</td></tr>';
                }
            })
            .catch(error => {
                console.error('Erro ao carregar tarefas:', error);
                document.getElementById('listaTarefas').innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 30px; color: #ff6b6b;">Erro ao carregar tarefas</td></tr>';
            });
        }
        
        function mostrarTarefas(tarefas) {
            const tbody = document.getElementById('listaTarefas');
            
            if (tarefas.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 30px; color: #b8c2d3;">Nenhuma tarefa encontrada</td></tr>';
                return;
            }
            
            tbody.innerHTML = tarefas.map(tarefa => `
                <tr>
                    <td>${tarefa.nome}</td>
                    <td><span class="badge badge-info">${tarefa.tipo}</span></td>
                    <td>${tarefa.setor || 'N/A'}</td>
                </tr>
            `).join('');
        }
        
        // Carregar ao iniciar
        window.addEventListener('load', function() {
            console.log('üöÄ Window loaded - carregando tarefas');
            carregarTarefas();
        });
        
        console.log('‚úÖ SCRIPT COMPLETO CARREGADO');
    </script>
{% endblock %}
