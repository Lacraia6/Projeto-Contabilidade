{% extends "base.html" %}

{% block title %}Mudan√ßas de Tributa√ß√£o - Sistema DP & Contabilidade{% endblock %}

{% block content %}
<section class="dashboard-section">
  <div class="dashboard-header">
    <h1><i class="fas fa-exchange-alt"></i> Mudan√ßas de Tributa√ß√£o Pendentes</h1>
    <p>Revise e atribua respons√°veis √†s tarefas das novas tributa√ß√µes</p>
  </div>

  {% if error %}
    <div class="alert alert-danger">
      <i class="fas fa-exclamation-triangle"></i>
      <strong>Erro:</strong> {{ error }}
    </div>
  {% endif %}

  <div class="dashboard-content">
    {% if mudancas %}
      <div class="mudancas-container">
        {% for mudanca_data in mudancas %}
          {% set mudanca = mudanca_data.mudanca %}
          {% set empresa = mudanca_data.empresa %}
          {% set trib_anterior = mudanca_data.tributacao_anterior %}
          {% set trib_nova = mudanca_data.tributacao_nova %}
          {% set tarefas_sem_responsavel = mudanca_data.tarefas_sem_responsavel %}
          
          <div class="mudanca-card">
            <div class="card-header-mudanca">
              <div class="empresa-info-mudanca">
                <h3><i class="fas fa-building"></i> {{ empresa.nome }}</h3>
                <p class="empresa-codigo"><i class="fas fa-barcode"></i> C√≥digo: {{ empresa.codigo }}</p>
              </div>
              <div class="tributacao-info">
                <span class="badge badge-old">{{ trib_anterior.nome if trib_anterior else 'N/A' }}</span>
                <i class="fas fa-arrow-right"></i>
                <span class="badge badge-new">{{ trib_nova.nome }}</span>
              </div>
            </div>
            
            <div class="card-body-mudanca">
              <div class="info-row">
                <span><i class="fas fa-calendar"></i> {{ mudanca.data_mudanca.strftime('%d/%m/%Y') }}</span>
                <span class="status-badge status-{{ mudanca.status }}">{{ mudanca.status.title() }}</span>
              </div>
              
              <div class="motivo-mudanca">
                <strong>Motivo:</strong> {{ mudanca.motivo }}
              </div>
              
              <div class="tarefas-preview">
                <strong><i class="fas fa-tasks"></i> {{ tarefas_sem_responsavel|length }} tarefa(s) sem respons√°vel</strong>
              </div>
              
              <div class="card-actions">
                <button class="btn btn-primary" onclick="abrirModal({{ mudanca.id }})">
                  <i class="fas fa-link"></i> Vincular Respons√°veis
                </button>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <div class="empty-message">
        <i class="fas fa-check-circle"></i>
        <h3>Nenhuma mudan√ßa pendente</h3>
        <p>Todas as mudan√ßas de tributa√ß√£o foram processadas.</p>
      </div>
    {% endif %}
  </div>
</section>

<!-- Modal de Vincula√ß√£o -->
<div id="modalVinculacao" class="modal-overlay">
  <div class="modal-box">
    <div class="modal-header-custom">
      <h3><i class="fas fa-link"></i> Vincular Respons√°veis</h3>
      <button class="btn-close-modal" onclick="fecharModal()">&times;</button>
    </div>
    
    <div class="modal-body-custom" id="modalBody">
      <div class="loading-spinner">
        <i class="fas fa-spinner fa-spin"></i> Carregando...
      </div>
    </div>
  </div>
</div>

<style>
/* === CORES PADR√ÉO DO SISTEMA === */
:root {
  --cor-primaria: #007bff;
  --cor-primaria-escura: #0056b3;
  --cor-primaria-hover: #0069d9;
  --cor-primaria-clara: #e7f1ff;
  --cor-sucesso: #28a745;
  --cor-sucesso-hover: #218838;
  --cor-perigo: #dc3545;
  --cor-perigo-hover: #c82333;
  --cor-aviso: #ffc107;
  --cor-aviso-hover: #e0a800;
  --cor-cinza-claro: #f8f9fa;
  --cor-cinza-medio: #6c757d;
  --cor-cinza-escuro: #343a40;
  --cor-texto: #212529;
}

/* Container das mudan√ßas */
.mudancas-container {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(450px, 1fr));
  gap: 20px;
  margin-top: 20px;
}

.mudanca-card {
  background: white;
  border-radius: 10px;
  box-shadow: 0 2px 10px rgba(0, 123, 255, 0.15);
  overflow: hidden;
  border-left: 5px solid var(--cor-primaria);
  transition: transform 0.2s, box-shadow 0.2s;
}

.mudanca-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 20px rgba(0, 123, 255, 0.25);
}

.card-header-mudanca {
  background: linear-gradient(135deg, var(--cor-primaria-clara) 0%, #ffffff 100%);
  padding: 20px;
  border-bottom: 2px solid var(--cor-primaria);
}

.empresa-info-mudanca h3 {
  margin: 0 0 5px 0;
  color: var(--cor-primaria);
  font-size: 1.25rem;
  font-weight: 600;
}

.empresa-codigo {
  margin: 0;
  color: var(--cor-cinza-medio);
  font-size: 0.9rem;
}

.tributacao-info {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-top: 12px;
}

.badge {
  padding: 6px 14px;
  border-radius: 20px;
  font-size: 0.85rem;
  font-weight: 600;
}

.badge-old {
  background: #ffe5e5;
  color: var(--cor-perigo);
  border: 1px solid var(--cor-perigo);
}

.badge-new {
  background: #e7f9e7;
  color: var(--cor-sucesso);
  border: 1px solid var(--cor-sucesso);
}

.card-body-mudanca {
  padding: 20px;
}

.info-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
  font-size: 0.9rem;
  color: var(--cor-cinza-medio);
}

.status-badge {
  padding: 5px 14px;
  border-radius: 15px;
  font-size: 0.8rem;
  font-weight: 600;
  text-transform: uppercase;
}

.status-pendente {
  background: #fff3cd;
  color: #856404;
  border: 1px solid var(--cor-aviso);
}

.status-em_revisao {
  background: var(--cor-primaria-clara);
  color: var(--cor-primaria);
  border: 1px solid var(--cor-primaria);
}

.motivo-mudanca {
  padding: 12px;
  background: var(--cor-cinza-claro);
  border-radius: 6px;
  margin-bottom: 15px;
  font-size: 0.9rem;
  border-left: 3px solid var(--cor-primaria);
}

.tarefas-preview {
  margin-bottom: 15px;
  color: var(--cor-texto);
  font-weight: 500;
}

.card-actions {
  display: flex;
  gap: 10px;
}

.btn {
  padding: 10px 20px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-size: 0.95rem;
  font-weight: 500;
  transition: all 0.3s;
  display: inline-flex;
  align-items: center;
  gap: 8px;
}

.btn-primary {
  background: var(--cor-primaria);
  color: white;
}

.btn-primary:hover {
  background: var(--cor-primaria-hover);
  box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
}

.btn-success {
  background: var(--cor-sucesso);
  color: white;
}

.btn-success:hover {
  background: var(--cor-sucesso-hover);
  box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
}

.btn-secondary {
  background: var(--cor-cinza-medio);
  color: white;
}

.btn-secondary:hover {
  background: var(--cor-cinza-escuro);
}

.empty-message {
  text-align: center;
  padding: 60px 20px;
  color: var(--cor-cinza-medio);
}

.empty-message i {
  font-size: 4rem;
  color: var(--cor-sucesso);
  margin-bottom: 20px;
}

/* === MODAL === */
.modal-overlay {
  display: none;
  position: fixed;
  z-index: 9999;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.6);
  align-items: center;
  justify-content: center;
}

.modal-overlay.show {
  display: flex !important;
}

.modal-box {
  background: white;
  border-radius: 12px;
  width: 90%;
  max-width: 900px;
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: 0 10px 40px rgba(0, 123, 255, 0.3);
  animation: slideIn 0.3s ease;
  border-top: 5px solid var(--cor-primaria);
}

@keyframes slideIn {
  from {
    transform: translateY(-50px);
    opacity: 0;
  }
  to {
    transform: translateY(0);
    opacity: 1;
  }
}

.modal-header-custom {
  background: var(--cor-primaria);
  color: white;
  padding: 20px 25px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-radius: 12px 12px 0 0;
}

.modal-header-custom h3 {
  margin: 0;
  font-size: 1.3rem;
  font-weight: 600;
}

.btn-close-modal {
  background: rgba(255, 255, 255, 0.2);
  border: none;
  color: white;
  font-size: 1.8rem;
  cursor: pointer;
  line-height: 1;
  padding: 5px 12px;
  border-radius: 50%;
  width: 40px;
  height: 40px;
  transition: all 0.3s;
}

.btn-close-modal:hover {
  background: rgba(255, 255, 255, 0.3);
  transform: rotate(90deg);
}

.modal-body-custom {
  padding: 30px;
}

.loading-spinner {
  text-align: center;
  padding: 40px;
  font-size: 1.2rem;
  color: var(--cor-primaria);
}

.loading-spinner i {
  font-size: 2rem;
  margin-bottom: 15px;
}

.empresa-header-modal {
  background: var(--cor-primaria-clara);
  padding: 20px;
  border-radius: 8px;
  margin-bottom: 25px;
  border-left: 4px solid var(--cor-primaria);
}

.empresa-header-modal h4 {
  margin: 0 0 10px 0;
  color: var(--cor-primaria);
  font-weight: 600;
}

.tarefa-vinculacao {
  background: var(--cor-cinza-claro);
  padding: 15px;
  border-radius: 8px;
  margin-bottom: 15px;
  border-left: 4px solid var(--cor-primaria);
  transition: all 0.2s;
}

.tarefa-vinculacao:hover {
  box-shadow: 0 2px 8px rgba(0, 123, 255, 0.15);
}

.tarefa-vinculacao-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 10px;
}

.tarefa-nome-modal {
  font-weight: 600;
  color: var(--cor-texto);
  font-size: 1.05rem;
}

.tarefa-meta {
  font-size: 0.85rem;
  color: var(--cor-cinza-medio);
  margin-top: 5px;
}

.tarefa-select-group {
  margin-top: 12px;
}

.tarefa-select-group label {
  display: block;
  margin-bottom: 8px;
  font-weight: 600;
  color: var(--cor-texto);
}

.tarefa-select-group select {
  width: 100%;
  padding: 10px 12px;
  border: 2px solid #ced4da;
  border-radius: 6px;
  font-size: 0.95rem;
  background: white;
  cursor: pointer;
  transition: all 0.2s;
}

.tarefa-select-group select:focus {
  outline: none;
  border-color: var(--cor-primaria);
  box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
}

/* Op√ß√£o especial de n√£o vincular */
.tarefa-select-group select option[value="-1"] {
  color: var(--cor-perigo);
  font-weight: 600;
  background: #ffe5e5;
}

.modal-actions {
  display: flex;
  gap: 10px;
  justify-content: flex-end;
  margin-top: 25px;
  padding-top: 20px;
  border-top: 2px solid var(--cor-primaria-clara);
}

.alert-info {
  background: var(--cor-primaria-clara);
  border: 1px solid var(--cor-primaria);
  color: var(--cor-primaria);
  padding: 15px;
  border-radius: 6px;
  margin-bottom: 20px;
}

.alert-warning {
  background: #fff3cd;
  border: 1px solid var(--cor-aviso);
  color: #856404;
  padding: 12px 15px;
  border-radius: 6px;
  margin-top: 15px;
  font-size: 0.9rem;
}

.alert-warning i {
  margin-right: 8px;
}

@media (max-width: 768px) {
  .mudancas-container {
    grid-template-columns: 1fr;
  }
  
  .modal-box {
    width: 95%;
    max-height: 95vh;
  }
}
</style>

<script>
console.log('‚úÖ Script de Mudan√ßas de Tributa√ß√£o carregado');

let mudancaAtualId = null;

function abrirModal(mudancaId) {
  console.log('üîµ Abrindo modal para mudan√ßa ID:', mudancaId);
  mudancaAtualId = mudancaId;
  
  const modal = document.getElementById('modalVinculacao');
  const modalBody = document.getElementById('modalBody');
  
  // Mostrar modal com loading
  modal.classList.add('show');
  modalBody.innerHTML = '<div class="loading-spinner"><i class="fas fa-spinner fa-spin"></i><br>Carregando tarefas...</div>';
  
  // Buscar dados da API
  fetch(`/gerenciamento/api/mudanca-tributacao/${mudancaId}/tarefas`)
    .then(response => response.json())
    .then(data => {
      console.log('üìä Dados recebidos:', data);
      
      if (!data.success) {
        alert('Erro: ' + data.message);
        fecharModal();
        return;
      }
      
      // Renderizar conte√∫do do modal
      let html = `
        <div class="empresa-header-modal">
          <h4><i class="fas fa-building"></i> ${data.empresa.nome}</h4>
          <p><strong>Nova Tributa√ß√£o:</strong> ${data.tributacao_nova.nome}</p>
        </div>
        
        <div class="alert-warning">
          <i class="fas fa-info-circle"></i>
          <strong>Importante:</strong> Selecione um respons√°vel para cada tarefa ou escolha "N√£o vincular" para tarefas que n√£o ser√£o executadas nesta empresa.
        </div>
      `;
      
      if (data.tarefas && data.tarefas.length > 0) {
        data.tarefas.forEach(tarefa => {
          html += `
            <div class="tarefa-vinculacao">
              <div class="tarefa-vinculacao-header">
                <div>
                  <div class="tarefa-nome-modal">${tarefa.nome}</div>
                  <div class="tarefa-meta">
                    <span><i class="fas fa-tag"></i> ${tarefa.tipo}</span> | 
                    <span><i class="fas fa-sitemap"></i> ${tarefa.setor}</span>
                  </div>
                </div>
              </div>
              
              <div class="tarefa-select-group">
                <label for="select-${tarefa.relacionamento_id}">Respons√°vel:</label>
                <select id="select-${tarefa.relacionamento_id}" 
                        class="responsavel-select" 
                        data-rel-id="${tarefa.relacionamento_id}">
                  <option value="">Selecione um respons√°vel</option>
                  <option value="-1" style="color: #dc3545; font-weight: bold;">‚ùå N√£o vincular esta tarefa</option>
                </select>
              </div>
            </div>
          `;
        });
        
        html += `
          <div class="modal-actions">
            <button class="btn btn-success" onclick="salvarVinculacoes()">
              <i class="fas fa-save"></i> Salvar Vincula√ß√µes
            </button>
            <button class="btn btn-secondary" onclick="fecharModal()">
              <i class="fas fa-times"></i> Cancelar
            </button>
          </div>
        `;
      } else {
        html += `
          <div class="alert-info">
            <i class="fas fa-info-circle"></i>
            Todas as tarefas j√° possuem respons√°veis definidos.
          </div>
          <div class="modal-actions">
            <button class="btn btn-secondary" onclick="fecharModal()">Fechar</button>
          </div>
        `;
      }
      
      modalBody.innerHTML = html;
      
      // Carregar funcion√°rios nos selects
      carregarFuncionarios();
    })
    .catch(error => {
      console.error('‚ùå Erro ao carregar:', error);
      alert('Erro ao carregar tarefas: ' + error);
      fecharModal();
    });
}

function carregarFuncionarios() {
  console.log('üì• Carregando funcion√°rios...');
  
  fetch('/gerenciamento/api/colaboradores')
    .then(response => response.json())
    .then(data => {
      console.log('üë• Colaboradores recebidos:', data);
      
      if (data.success) {
        const selects = document.querySelectorAll('.responsavel-select');
        const usuarios = data.usuarios || data.colaboradores || [];
        
        console.log(`‚úÖ Populando ${selects.length} select(s) com ${usuarios.length} usu√°rio(s)`);
        
        selects.forEach(select => {
          // Adicionar usu√°rios (mantendo as 2 primeiras op√ß√µes: "Selecione" e "N√£o vincular")
          usuarios.forEach(usuario => {
            const option = document.createElement('option');
            option.value = usuario.id;
            option.textContent = usuario.nome;
            select.appendChild(option);
          });
        });
        
        console.log('‚úÖ Selects populados com sucesso!');
      } else {
        console.error('‚ùå API retornou erro:', data.message);
      }
    })
    .catch(error => {
      console.error('‚ùå Erro ao carregar funcion√°rios:', error);
    });
}

function salvarVinculacoes() {
  console.log('üíæ Salvando vincula√ß√µes...');
  
  const selects = document.querySelectorAll('.responsavel-select');
  const vinculacoes = [];
  const naoVincular = []; // Tarefas que n√£o ser√£o vinculadas
  
  let semSelecao = 0;
  
  selects.forEach(select => {
    const valor = select.value;
    const relId = parseInt(select.dataset.relId);
    
    if (!valor) {
      semSelecao++;
      return;
    }
    
    if (valor === '-1') {
      // Marcar para desativar
      naoVincular.push(relId);
    } else {
      // Vincular ao respons√°vel
      vinculacoes.push({
        relacionamento_id: relId,
        responsavel_id: parseInt(valor)
      });
    }
  });
  
  if (semSelecao === selects.length) {
    alert('‚ùå Selecione pelo menos uma a√ß√£o para cada tarefa (vincular ou n√£o vincular)!');
    return;
  }
  
  console.log('üì¶ Enviando:', { vinculacoes, naoVincular });
  
  // Enviar vincula√ß√µes normais
  const promises = [];
  
  if (vinculacoes.length > 0) {
    promises.push(
      fetch('/gerenciamento/api/atualizar-responsavel-relacionamentos', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ relacionamentos: vinculacoes })
      }).then(r => r.json())
    );
  }
  
  // Enviar tarefas para desativar
  if (naoVincular.length > 0) {
    promises.push(
      fetch('/gerenciamento/api/desativar-tarefas', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ relacionamentos_ids: naoVincular })
      }).then(r => r.json())
    );
  }
  
  Promise.all(promises)
    .then(results => {
      console.log('‚úÖ Respostas:', results);
      
      const mensagens = [];
      results.forEach(data => {
        if (data.success) {
          mensagens.push(data.message);
        } else {
          mensagens.push('‚ùå Erro: ' + data.message);
        }
      });
      
      alert(mensagens.join('\n'));
      fecharModal();
      location.reload();
    })
    .catch(error => {
      console.error('‚ùå Erro:', error);
      alert('Erro ao salvar: ' + error);
    });
}

function fecharModal() {
  console.log('‚úñÔ∏è Fechando modal');
  document.getElementById('modalVinculacao').classList.remove('show');
  mudancaAtualId = null;
}

// Fechar modal ao clicar fora
document.addEventListener('click', function(event) {
  const modal = document.getElementById('modalVinculacao');
  if (event.target === modal) {
    fecharModal();
  }
});
</script>
{% endblock %}
