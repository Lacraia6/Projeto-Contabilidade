{% extends "base.html" %}

{% block title %}Mudan√ßas de Tributa√ß√£o - Sistema DP & Contabilidade{% endblock %}

{% block content %}
<section class="dashboard-section">
  <div class="dashboard-header">
    <h1><i class="fas fa-exchange-alt"></i> Mudan√ßas de Tributa√ß√£o Pendentes</h1>
    <p>Revise e atribua respons√°veis √†s tarefas das novas tributa√ß√µes</p>
  </div>

  {% if error %}
    <div class="alert alert-danger">
      <i class="fas fa-exclamation-triangle"></i>
      <strong>Erro:</strong> {{ error }}
    </div>
  {% endif %}

  <div class="dashboard-content">
    {% if mudancas %}
      <div class="mudancas-container">
        {% for mudanca_data in mudancas %}
          {% set mudanca = mudanca_data.mudanca %}
          {% set empresa = mudanca_data.empresa %}
          {% set trib_anterior = mudanca_data.tributacao_anterior %}
          {% set trib_nova = mudanca_data.tributacao_nova %}
          {% set tarefas_sem_responsavel = mudanca_data.tarefas_sem_responsavel %}
          
          <div class="mudanca-card">
            <div class="card-header-mudanca">
              <div class="empresa-info-mudanca">
                <h3><i class="fas fa-building"></i> {{ empresa.nome }}</h3>
                <p class="empresa-codigo"><i class="fas fa-barcode"></i> C√≥digo: {{ empresa.codigo }}</p>
              </div>
              <div class="tributacao-info">
                <span class="badge badge-old">{{ trib_anterior.nome if trib_anterior else 'N/A' }}</span>
                <i class="fas fa-arrow-right"></i>
                <span class="badge badge-new">{{ trib_nova.nome }}</span>
              </div>
            </div>
            
            <div class="card-body-mudanca">
              <div class="info-row">
                <span><i class="fas fa-calendar"></i> {{ mudanca.data_mudanca.strftime('%d/%m/%Y') }}</span>
                <span class="status-badge status-{{ mudanca.status }}">{{ mudanca.status.title() }}</span>
              </div>
              
              <div class="motivo-mudanca">
                <strong>Motivo:</strong> {{ mudanca.motivo }}
              </div>
              
              <div class="tarefas-preview">
                <strong><i class="fas fa-tasks"></i> {{ tarefas_sem_responsavel|length }} tarefa(s) sem respons√°vel</strong>
              </div>
              
              <div class="card-actions">
                <button class="btn btn-primary" onclick="abrirModal({{ mudanca.id }})">
                  <i class="fas fa-link"></i> Vincular Respons√°veis
                </button>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <div class="empty-message">
        <i class="fas fa-check-circle"></i>
        <h3>Nenhuma mudan√ßa pendente</h3>
        <p>Todas as mudan√ßas de tributa√ß√£o foram processadas.</p>
      </div>
    {% endif %}
  </div>
</section>

<!-- Modal de Vincula√ß√£o -->
<div id="modalVinculacao" class="modal-overlay">
  <div class="modal-box">
    <div class="modal-header-custom">
      <h3><i class="fas fa-link"></i> Vincular Respons√°veis</h3>
      <button class="btn-close-modal" onclick="fecharModal()">&times;</button>
    </div>
    
    <div class="modal-body-custom" id="modalBody">
      <div class="loading-spinner">
        <i class="fas fa-spinner fa-spin"></i> Carregando...
      </div>
    </div>
  </div>
</div>

<style>
/* Container das mudan√ßas - Layout vertical */
.mudancas-container {
  display: flex;
  flex-direction: column;
  gap: 20px;
  margin-top: 20px;
}

.mudanca-card {
  background: var(--bg-card);
  border-radius: var(--radius);
  box-shadow: var(--shadow-md);
  overflow: hidden;
  border-left: 5px solid var(--primary-color);
  transition: transform 0.2s, box-shadow 0.2s;
  border: 1px solid var(--border-color);
}

.mudanca-card:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-lg);
  background: var(--bg-hover);
}

.card-header-mudanca {
  background: linear-gradient(135deg, var(--bg-card) 0%, var(--bg-card) 100%);
  padding: 20px;
  border-bottom: 2px solid var(--primary-color);
}

.empresa-info-mudanca h3 {
  margin: 0 0 5px 0;
  color: var(--primary-color);
  font-size: 1.25rem;
  font-weight: 600;
}

.empresa-codigo {
  margin: 0;
  color: var(--text-muted);
  font-size: 0.9rem;
}

.tributacao-info {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-top: 12px;
}

.badge {
  padding: 6px 14px;
  border-radius: 20px;
  font-size: 0.85rem;
  font-weight: 600;
}

.badge-old {
  background: rgba(255, 107, 107, 0.2);
  color: var(--danger-color);
  border: 1px solid var(--danger-color);
}

.badge-new {
  background: rgba(75, 181, 67, 0.2);
  color: var(--success-color);
  border: 1px solid var(--success-color);
}

.card-body-mudanca {
  padding: 20px;
}

.info-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
  font-size: 0.9rem;
  color: var(--text-muted);
}

.status-badge {
  padding: 5px 14px;
  border-radius: 15px;
  font-size: 0.8rem;
  font-weight: 600;
  text-transform: uppercase;
}

.status-pendente {
  background: rgba(255, 217, 61, 0.2);
  color: var(--warning-color);
  border: 1px solid var(--warning-color);
}

.status-em_revisao {
  background: rgba(158, 182, 216, 0.2);
  color: var(--primary-color);
  border: 1px solid var(--primary-color);
}

.motivo-mudanca {
  padding: 12px;
  background: var(--bg-secondary);
  border-radius: 6px;
  margin-bottom: 15px;
  font-size: 0.9rem;
  border-left: 3px solid var(--primary-color);
  color: var(--text-secondary);
}

.tarefas-preview {
  margin-bottom: 15px;
  color: var(--text-primary);
  font-weight: 500;
}

.card-actions {
  display: flex;
  gap: 10px;
}

.btn {
  padding: 10px 20px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-size: 0.95rem;
  font-weight: 500;
  transition: all 0.3s;
  display: inline-flex;
  align-items: center;
  gap: 8px;
}

.btn-primary {
  background: var(--primary-color);
  color: var(--text-primary);
}

.btn-primary:hover {
  background: var(--primary-dark);
  box-shadow: var(--shadow-glow);
}

.btn-success {
  background: var(--success-color);
  color: var(--text-primary);
}

.btn-success:hover {
  opacity: 0.9;
  box-shadow: 0 4px 12px rgba(75, 181, 67, 0.3);
}

.btn-secondary {
  background: var(--secondary-color);
  color: var(--text-primary);
}

.btn-secondary:hover {
  opacity: 0.9;
}

.empty-message {
  text-align: center;
  padding: 60px 20px;
  color: var(--text-muted);
}

.empty-message i {
  font-size: 4rem;
  color: var(--success-color);
  margin-bottom: 20px;
}

/* === MODAL === */
.modal-overlay {
  display: none;
  position: fixed;
  z-index: 9999;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.6);
  align-items: center;
  justify-content: center;
}

.modal-overlay.show {
  display: flex !important;
}

.modal-box {
  background: var(--bg-card);
  border-radius: var(--radius-lg);
  width: 90%;
  max-width: 900px;
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: var(--shadow-lg);
  animation: slideIn 0.3s ease;
  border-top: 5px solid var(--primary-color);
  border: 1px solid var(--border-color);
}

@keyframes slideIn {
  from {
    transform: translateY(-50px);
    opacity: 0;
  }
  to {
    transform: translateY(0);
    opacity: 1;
  }
}

.modal-header-custom {
  background: linear-gradient(135deg, var(--primary-dark), var(--primary-color));
  color: var(--text-primary);
  padding: 20px 25px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-radius: var(--radius-lg) var(--radius-lg) 0 0;
}

.modal-header-custom h3 {
  margin: 0;
  font-size: 1.3rem;
  font-weight: 600;
}

.btn-close-modal {
  background: rgba(255, 255, 255, 0.2);
  border: none;
  color: var(--text-primary);
  font-size: 1.8rem;
  cursor: pointer;
  line-height: 1;
  padding: 5px 12px;
  border-radius: 50%;
  width: 40px;
  height: 40px;
  transition: all 0.3s;
}

.btn-close-modal:hover {
  background: rgba(255, 255, 255, 0.3);
  transform: rotate(90deg);
}

.modal-body-custom {
  padding: 30px;
}

.loading-spinner {
  text-align: center;
  padding: 40px;
  font-size: 1.2rem;
  color: var(--primary-color);
}

.loading-spinner i {
  font-size: 2rem;
  margin-bottom: 15px;
}

.empresa-header-modal {
  background: var(--bg-secondary);
  padding: 20px;
  border-radius: var(--radius);
  margin-bottom: 25px;
  border-left: 4px solid var(--primary-color);
  border: 1px solid var(--border-color);
}

.empresa-header-modal h4 {
  margin: 0 0 10px 0;
  color: var(--primary-color);
  font-weight: 600;
}

.empresa-header-modal p {
  color: var(--text-secondary);
}

.tarefa-vinculacao {
  background: var(--bg-secondary);
  padding: 15px;
  border-radius: var(--radius);
  margin-bottom: 15px;
  border-left: 4px solid var(--primary-color);
  transition: all 0.2s;
  border: 1px solid var(--border-color);
}

.tarefa-vinculacao:hover {
  box-shadow: var(--shadow-md);
  background: var(--bg-hover);
}

.tarefa-vinculacao-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 10px;
}

.tarefa-nome-modal {
  font-weight: 600;
  color: var(--text-primary);
  font-size: 1.05rem;
}

.tarefa-meta {
  font-size: 0.85rem;
  color: var(--text-muted);
  margin-top: 5px;
}

.tarefa-select-group {
  margin-top: 12px;
  position: relative;
}

.tarefa-select-group label {
  display: block;
  margin-bottom: 8px;
  font-weight: 600;
  color: var(--text-primary);
}

.tarefa-select-group input {
  width: 100%;
  padding: 10px 12px;
  border: 2px solid var(--border-color);
  border-radius: var(--radius);
  font-size: 0.95rem;
  background: var(--bg-primary);
  color: var(--text-primary);
  transition: all 0.2s;
}

.tarefa-select-group input:focus {
  outline: none;
  border-color: var(--primary-color);
  box-shadow: 0 0 0 3px rgba(158, 182, 216, 0.2);
}

.nao-vincular-option {
  background: rgba(255, 107, 107, 0.2);
  border: 2px solid var(--danger-color);
  color: var(--danger-color);
  padding: 10px 15px;
  border-radius: var(--radius);
  margin-bottom: 10px;
  cursor: pointer;
  font-weight: 600;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  gap: 8px;
}

.nao-vincular-option:hover {
  background: rgba(255, 107, 107, 0.3);
  transform: translateX(2px);
}

.nao-vincular-option.selected {
  background: var(--danger-color);
  color: var(--text-primary);
}

.v2-search-results {
  position: absolute;
  z-index: 1000;
  background: var(--bg-card);
  border: 2px solid var(--primary-color);
  border-radius: var(--radius);
  max-height: 300px;
  overflow-y: auto;
  box-shadow: var(--shadow-lg);
  margin-top: 5px;
  width: calc(100% - 4px);
  left: 0;
  top: 100%;
}

.v2-search-item {
  padding: 12px 15px;
  cursor: pointer;
  border-bottom: 1px solid var(--border-color);
  transition: background 0.2s;
}

.v2-search-item:hover {
  background: var(--bg-hover);
}

.v2-search-item:last-child {
  border-bottom: none;
}

.v2-search-item strong {
  color: var(--text-primary);
  display: block;
  margin-bottom: 4px;
}

.v2-search-item div {
  font-size: 0.85rem;
  color: var(--text-muted);
}

.v2-empty {
  padding: 20px;
  text-align: center;
  color: var(--text-muted);
}

.v2-loading {
  padding: 20px;
  text-align: center;
  color: var(--primary-color);
}

.responsavel-selecionado {
  margin-top: 10px;
  padding: 12px 15px;
  background: var(--bg-secondary);
  border: 2px solid var(--primary-color);
  border-radius: var(--radius);
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 10px;
}

.responsavel-selecionado span {
  color: var(--primary-color);
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 8px;
}

.responsavel-selecionado button {
  background: var(--danger-color);
  color: var(--text-primary);
  border: none;
  padding: 5px 10px;
  border-radius: 4px;
  cursor: pointer;
  font-size: 0.85rem;
  transition: all 0.2s;
}

.responsavel-selecionado button:hover {
  opacity: 0.9;
}

.modal-actions {
  display: flex;
  gap: 10px;
  justify-content: flex-end;
  margin-top: 25px;
  padding-top: 20px;
  border-top: 2px solid var(--cor-primaria-clara);
}

.alert-info {
  background: rgba(158, 182, 216, 0.2);
  border: 1px solid var(--primary-color);
  color: var(--primary-color);
  padding: 15px;
  border-radius: var(--radius);
  margin-bottom: 20px;
}

.alert-warning {
  background: rgba(255, 217, 61, 0.2);
  border: 1px solid var(--warning-color);
  color: var(--warning-color);
  padding: 12px 15px;
  border-radius: var(--radius);
  margin-top: 15px;
  font-size: 0.9rem;
}

.alert-warning i {
  margin-right: 8px;
}

@media (max-width: 768px) {
  .modal-box {
    width: 95%;
    max-height: 95vh;
  }
}
</style>

<script>
console.log('‚úÖ Script de Mudan√ßas de Tributa√ß√£o carregado');

let mudancaAtualId = null;

function abrirModal(mudancaId) {
  console.log('üîµ Abrindo modal para mudan√ßa ID:', mudancaId);
  mudancaAtualId = mudancaId;
  
  // Limpar sele√ß√µes anteriores
  funcionariosPorTarefa = {};
  
  const modal = document.getElementById('modalVinculacao');
  const modalBody = document.getElementById('modalBody');
  
  // Mostrar modal com loading
  modal.classList.add('show');
  modalBody.innerHTML = '<div class="loading-spinner"><i class="fas fa-spinner fa-spin"></i><br>Carregando tarefas...</div>';
  
  // Buscar dados da API
  fetch(`/gerenciamento/api/mudanca-tributacao/${mudancaId}/tarefas`)
    .then(response => response.json())
    .then(data => {
      console.log('üìä Dados recebidos:', data);
      
      if (!data.success) {
        alert('Erro: ' + data.message);
        fecharModal();
        return;
      }
      
      // Renderizar conte√∫do do modal
      let html = `
        <div class="empresa-header-modal">
          <h4><i class="fas fa-building"></i> ${data.empresa.nome}</h4>
          <p><strong>Nova Tributa√ß√£o:</strong> ${data.tributacao_nova.nome}</p>
        </div>
        
        <div class="alert-warning">
          <i class="fas fa-info-circle"></i>
          <strong>Importante:</strong> Selecione um respons√°vel para cada tarefa ou escolha "N√£o vincular" para tarefas que n√£o ser√£o executadas nesta empresa.
        </div>
      `;
      
      if (data.tarefas && data.tarefas.length > 0) {
        data.tarefas.forEach(tarefa => {
          html += `
            <div class="tarefa-vinculacao">
              <div class="tarefa-vinculacao-header">
                <div>
                  <div class="tarefa-nome-modal">${tarefa.nome}</div>
                  <div class="tarefa-meta">
                    <span><i class="fas fa-tag"></i> ${tarefa.tipo}</span> | 
                    <span><i class="fas fa-sitemap"></i> ${tarefa.setor}</span>
                  </div>
                </div>
              </div>
              
              <div class="tarefa-select-group">
                <label for="search-${tarefa.relacionamento_id}">Respons√°vel:</label>
                
                <div class="nao-vincular-option" onclick="selecionarNaoVincular(${tarefa.relacionamento_id})">
                  <i class="fas fa-times-circle"></i> N√£o vincular esta tarefa
                </div>
                
                <input 
                  type="text" 
                  id="search-${tarefa.relacionamento_id}" 
                  class="responsavel-search" 
                  data-rel-id="${tarefa.relacionamento_id}"
                  placeholder="Digite o nome do respons√°vel..."
                  autocomplete="off"
                >
                <div id="results-${tarefa.relacionamento_id}" class="v2-search-results" style="display: none;"></div>
                <div id="selecionado-${tarefa.relacionamento_id}" class="responsavel-selecionado" style="display: none;"></div>
              </div>
            </div>
          `;
        });
        
        html += `
          <div class="modal-actions">
            <button class="btn btn-success" onclick="salvarVinculacoes()">
              <i class="fas fa-save"></i> Salvar Vincula√ß√µes
            </button>
            <button class="btn btn-secondary" onclick="fecharModal()">
              <i class="fas fa-times"></i> Cancelar
            </button>
          </div>
        `;
      } else {
        html += `
          <div class="alert-info">
            <i class="fas fa-info-circle"></i>
            Todas as tarefas j√° possuem respons√°veis definidos.
          </div>
          <div class="modal-actions">
            <button class="btn btn-secondary" onclick="fecharModal()">Fechar</button>
          </div>
        `;
      }
      
      modalBody.innerHTML = html;
      
      // Carregar funcion√°rios nos selects
      carregarFuncionarios();
    })
    .catch(error => {
      console.error('‚ùå Erro ao carregar:', error);
      alert('Erro ao carregar tarefas: ' + error);
      fecharModal();
    });
}

let todosFuncionarios = [];
let funcionariosPorTarefa = {};

function carregarFuncionarios() {
  console.log('üì• Carregando funcion√°rios...');
  
  fetch('/gerenciamento/api/colaboradores')
    .then(response => response.json())
    .then(data => {
      console.log('üë• Colaboradores recebidos:', data);
      
      if (data.success) {
        todosFuncionarios = data.usuarios || data.colaboradores || [];
        console.log(`‚úÖ ${todosFuncionarios.length} funcion√°rios carregados`);
        
        // Configurar busca para cada input
        document.querySelectorAll('.responsavel-search').forEach(input => {
          configurarBuscaResponsavel(input);
        });
      } else {
        console.error('‚ùå API retornou erro:', data.message);
      }
    })
    .catch(error => {
      console.error('‚ùå Erro ao carregar funcion√°rios:', error);
    });
}

function configurarBuscaResponsavel(input) {
  const relId = input.dataset.relId;
  const resultsDiv = document.getElementById(`results-${relId}`);
  let timeout;
  
  input.addEventListener('input', function(e) {
    const query = e.target.value.trim().toLowerCase();
    
    clearTimeout(timeout);
    
    if (query.length < 1) {
      if (resultsDiv) resultsDiv.style.display = 'none';
      return;
    }
    
    timeout = setTimeout(() => {
      filtrarFuncionarios(query, relId);
    }, 300);
  });
  
  // Fechar resultados ao perder foco (mas n√£o se clicar nos resultados)
  input.addEventListener('blur', function() {
    setTimeout(() => {
      if (resultsDiv && !resultsDiv.matches(':hover') && !resultsDiv.contains(document.activeElement)) {
        resultsDiv.style.display = 'none';
      }
    }, 200);
  });
}

function filtrarFuncionarios(query, relId) {
  const resultsDiv = document.getElementById(`results-${relId}`);
  if (!resultsDiv) return;
  
  const filtered = todosFuncionarios.filter(f => 
    f.nome.toLowerCase().includes(query)
  );
  
  if (filtered.length === 0) {
    resultsDiv.innerHTML = '<div class="v2-empty">Nenhum funcion√°rio encontrado</div>';
    resultsDiv.style.display = 'block';
    return;
  }
  
  resultsDiv.innerHTML = filtered.map(f => `
    <div class="v2-search-item" onmousedown="event.preventDefault(); selecionarResponsavel(${relId}, ${f.id}, '${f.nome.replace(/'/g, "\\'")}', '${f.setor || 'N/A'}')">
      <strong>${f.nome}</strong>
      <div>${f.setor || 'Sem setor'} ‚Ä¢ ${f.tipo || 'N/A'}</div>
    </div>
  `).join('');
  
  resultsDiv.style.display = 'block';
}

function selecionarResponsavel(relId, funcionarioId, nome, setor) {
  console.log('‚úÖ Respons√°vel selecionado:', { relId, funcionarioId, nome });
  
  // Armazenar sele√ß√£o
  if (!funcionariosPorTarefa[relId]) {
    funcionariosPorTarefa[relId] = {};
  }
  funcionariosPorTarefa[relId].id = funcionarioId;
  funcionariosPorTarefa[relId].nome = nome;
  funcionariosPorTarefa[relId].setor = setor;
  
  // Esconder input e resultados
  const input = document.getElementById(`search-${relId}`);
  const resultsDiv = document.getElementById(`results-${relId}`);
  const selecionadoDiv = document.getElementById(`selecionado-${relId}`);
  
  if (input) input.style.display = 'none';
  if (resultsDiv) resultsDiv.style.display = 'none';
  
  // Mostrar selecionado
  if (selecionadoDiv) {
    selecionadoDiv.innerHTML = `
      <span><i class="fas fa-check-circle"></i> ${nome} (${setor})</span>
      <button onclick="removerResponsavel(${relId})" title="Remover">
        <i class="fas fa-times"></i>
      </button>
    `;
    selecionadoDiv.style.display = 'flex';
  }
  
  // Remover sele√ß√£o de "n√£o vincular" se houver
  const naoVincular = input?.closest('.tarefa-select-group')?.querySelector('.nao-vincular-option');
  if (naoVincular) {
    naoVincular.classList.remove('selected');
  }
}

function selecionarNaoVincular(relId) {
  console.log('‚ùå N√£o vincular tarefa:', relId);
  
  // Armazenar sele√ß√£o
  if (!funcionariosPorTarefa[relId]) {
    funcionariosPorTarefa[relId] = {};
  }
  funcionariosPorTarefa[relId].id = -1;
  funcionariosPorTarefa[relId].nome = 'N√£o vincular';
  
  // Esconder input e resultados
  const input = document.getElementById(`search-${relId}`);
  const resultsDiv = document.getElementById(`results-${relId}`);
  const selecionadoDiv = document.getElementById(`selecionado-${relId}`);
  
  if (input) {
    input.style.display = 'none';
    input.value = '';
  }
  if (resultsDiv) resultsDiv.style.display = 'none';
  
  // Mostrar selecionado
  if (selecionadoDiv) {
    selecionadoDiv.innerHTML = `
      <span style="color: var(--cor-perigo);"><i class="fas fa-times-circle"></i> N√£o vincular esta tarefa</span>
      <button onclick="removerResponsavel(${relId})" title="Remover">
        <i class="fas fa-times"></i>
      </button>
    `;
    selecionadoDiv.style.display = 'flex';
  }
  
  // Marcar op√ß√£o como selecionada
  const naoVincular = input?.closest('.tarefa-select-group')?.querySelector('.nao-vincular-option');
  if (naoVincular) {
    naoVincular.classList.add('selected');
  }
}

function removerResponsavel(relId) {
  console.log('üóëÔ∏è Removendo respons√°vel:', relId);
  
  // Limpar sele√ß√£o
  delete funcionariosPorTarefa[relId];
  
  // Mostrar input novamente
  const input = document.getElementById(`search-${relId}`);
  const resultsDiv = document.getElementById(`results-${relId}`);
  const selecionadoDiv = document.getElementById(`selecionado-${relId}`);
  
  if (input) {
    input.style.display = 'block';
    input.value = '';
  }
  if (resultsDiv) resultsDiv.style.display = 'none';
  if (selecionadoDiv) selecionadoDiv.style.display = 'none';
  
  // Remover sele√ß√£o de "n√£o vincular"
  const naoVincular = input?.closest('.tarefa-select-group')?.querySelector('.nao-vincular-option');
  if (naoVincular) {
    naoVincular.classList.remove('selected');
  }
}

function salvarVinculacoes() {
  console.log('üíæ Salvando vincula√ß√µes...');
  
  const vinculacoes = [];
  const naoVincular = []; // Tarefas que n√£o ser√£o vinculadas
  
  let semSelecao = 0;
  
  // Processar todas as sele√ß√µes armazenadas
  Object.keys(funcionariosPorTarefa).forEach(relIdStr => {
    const relId = parseInt(relIdStr);
    const selecao = funcionariosPorTarefa[relIdStr];
    
    if (!selecao || !selecao.id) {
      semSelecao++;
      return;
    }
    
    if (selecao.id === -1) {
      // Marcar para desativar
      naoVincular.push(relId);
    } else {
      // Vincular ao respons√°vel
      vinculacoes.push({
        relacionamento_id: relId,
        responsavel_id: selecao.id
      });
    }
  });
  
  // Verificar se h√° tarefas sem sele√ß√£o
  const totalTarefas = document.querySelectorAll('.tarefa-vinculacao').length;
  const totalSelecionadas = vinculacoes.length + naoVincular.length;
  
  if (totalSelecionadas === 0) {
    alert('‚ùå Selecione pelo menos uma a√ß√£o para cada tarefa (vincular ou n√£o vincular)!');
    return;
  }
  
  if (totalSelecionadas < totalTarefas) {
    if (!confirm(`‚ö†Ô∏è Voc√™ selecionou a√ß√µes para ${totalSelecionadas} de ${totalTarefas} tarefas. Deseja continuar mesmo assim?`)) {
      return;
    }
  }
  
  console.log('üì¶ Enviando:', { vinculacoes, naoVincular, mudanca_id: mudancaAtualId });
  
  // Enviar vincula√ß√µes normais
  const promises = [];
  
  if (vinculacoes.length > 0) {
    promises.push(
      fetch('/gerenciamento/api/atualizar-responsavel-relacionamentos', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
          relacionamentos: vinculacoes,
          mudanca_id: mudancaAtualId
        })
      }).then(r => r.json())
    );
  }
  
  // Enviar tarefas para desativar
  if (naoVincular.length > 0) {
    promises.push(
      fetch('/gerenciamento/api/desativar-tarefas', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
          relacionamentos_ids: naoVincular,
          mudanca_id: mudancaAtualId
        })
      }).then(r => r.json())
    );
  }
  
  // Verificar se h√° promises para executar
  if (promises.length === 0) {
    alert('‚ùå Nenhuma a√ß√£o selecionada!');
    return;
  }
  
  Promise.all(promises)
    .then(results => {
      console.log('‚úÖ Respostas recebidas:', results);
      
      const mensagens = [];
      let todasSucesso = true;
      
      results.forEach((data, index) => {
        console.log(`üìä Resultado ${index + 1}:`, data);
        if (data.success) {
          mensagens.push(data.message);
          console.log(`‚úÖ Sucesso: ${data.message}`);
        } else {
          todasSucesso = false;
          mensagens.push('‚ùå Erro: ' + data.message);
          console.error(`‚ùå Erro: ${data.message}`);
        }
      });
      
      // Verificar se pelo menos uma opera√ß√£o foi bem-sucedida
      if (!todasSucesso) {
        alert('‚ö†Ô∏è Algumas opera√ß√µes falharam:\n' + mensagens.join('\n'));
      }
      
      // Fechar modal primeiro
      fecharModal();
      
      // Se todas as opera√ß√µes foram bem-sucedidas, fazer uma verifica√ß√£o final
      if (todasSucesso && mudancaAtualId) {
        console.log('üîÑ Fazendo verifica√ß√£o final...');
        // Fazer uma requisi√ß√£o final para verificar e concluir a mudan√ßa se necess√°rio
        fetch('/gerenciamento/api/verificar-concluir-mudanca', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ mudanca_id: mudancaAtualId })
        })
        .then(r => r.json())
        .then(data => {
          console.log('‚úÖ Verifica√ß√£o final conclu√≠da:', data);
          
          // Aguardar um pouco antes de redirecionar para garantir que o commit foi feito
          setTimeout(() => {
            window.location.href = '/gerenciamento/mudancas-tributacao';
          }, 500);
        })
        .catch(error => {
          console.error('‚ùå Erro na verifica√ß√£o final:', error);
          // Mesmo com erro, fazer redirect ap√≥s um delay
          setTimeout(() => {
            window.location.href = '/gerenciamento/mudancas-tributacao';
          }, 500);
        });
      } else {
        // Se houve erro, fazer redirect ap√≥s um delay
        setTimeout(() => {
          window.location.href = '/gerenciamento/mudancas-tributacao';
        }, 500);
      }
    })
    .catch(error => {
      console.error('‚ùå Erro ao processar requisi√ß√µes:', error);
      alert('Erro ao salvar: ' + error);
      fecharModal();
    });
}

function fecharModal() {
  console.log('‚úñÔ∏è Fechando modal');
  document.getElementById('modalVinculacao').classList.remove('show');
  mudancaAtualId = null;
  
  // Limpar sele√ß√µes
  funcionariosPorTarefa = {};
  todosFuncionarios = [];
}

// Fechar modal ao clicar fora
document.addEventListener('click', function(event) {
  const modal = document.getElementById('modalVinculacao');
  if (event.target === modal) {
    fecharModal();
  }
});
</script>
{% endblock %}
