{% extends "base.html" %}

{% block title %}Painel do Supervisor{% endblock %}

{% block content %}
<section id="supervisor" class="tab-content active dashboard-section">
  <div class="dashboard-header">
    <h1><i class="fas fa-user-shield"></i> Painel do Supervisor</h1>
    <p>Gerenciamento de empresas, tributa√ß√£o e checklists</p>
  <div class="header-actions">
    <a href="/supervisor/empresas" class="btn btn-primary" style="pointer-events: auto !important; z-index: 9999 !important;">
      <i class="fas fa-building"></i> Empresas
    </a>
    <a href="/supervisor/checklists" class="btn btn-success" style="pointer-events: auto !important; z-index: 9999 !important;">
      <i class="fas fa-tasks"></i> Checklists
    </a>
    <a href="/supervisor/templates" class="btn btn-info" style="pointer-events: auto !important; z-index: 9999 !important;">
      <i class="fas fa-clipboard-list"></i> Templates
    </a>
  </div>
  </div>

  <!-- M√©tricas -->
  <div class="dashboard-metrics">
    <div class="metric-card">
      <div class="metric-icon">
        <i class="fas fa-building"></i>
      </div>
      <div class="metric-content">
        <h3>{{ total_empresas }}</h3>
        <p>Empresas Ativas</p>
      </div>
    </div>
    
    <div class="metric-card">
      <div class="metric-icon">
        <i class="fas fa-tasks"></i>
      </div>
      <div class="metric-content">
        <h3>{{ total_checklists }}</h3>
        <p>Checklists Criados</p>
      </div>
    </div>
    
    <div class="metric-card">
      <div class="metric-icon">
        <i class="fas fa-users"></i>
      </div>
      <div class="metric-content">
        <h3>{{ total_usuarios }}</h3>
        <p>Usu√°rios Ativos</p>
      </div>
    </div>
  </div>

  <!-- Empresas Recentes -->
  <div class="dashboard-table">
    <h3><i class="fas fa-building"></i> Empresas Recentes</h3>
    <div class="table-responsive">
      <table class="table">
        <thead>
          <tr>
            <th>C√≥digo</th>
            <th>Nome</th>
            <th>Tributa√ß√£o</th>
            <th>Criada em</th>
            <th>A√ß√µes</th>
          </tr>
        </thead>
        <tbody>
          {% for empresa in empresas_recentes %}
          <tr>
            <td>{{ empresa.codigo }}</td>
            <td>{{ empresa.nome }}</td>
            <td>
              {% if empresa.tributacao %}
                {% if empresa.tributacao.nome == 'Simples Nacional' %}
                  <span class="badge badge-simples-nacional">{{ empresa.tributacao.nome }}</span>
                {% elif empresa.tributacao.nome == 'Regime Normal' %}
                  <span class="badge badge-regime-normal">{{ empresa.tributacao.nome }}</span>
                {% else %}
                  <span class="badge badge-info">{{ empresa.tributacao.nome }}</span>
                {% endif %}
              {% else %}
                <span class="badge badge-secondary">Sem tributa√ß√£o</span>
              {% endif %}
            </td>
            <td>{{ empresa.criado_em.strftime('%d/%m/%Y') if empresa.criado_em else 'N/A' }}</td>
            <td>
              <button class="btn btn-sm btn-warning" onclick="alterarTributacao({{ empresa.id }}, '{{ empresa.tributacao.nome if empresa.tributacao else '' }}')">
                <i class="fas fa-edit"></i> Tributa√ß√£o
              </button>
            </td>
          </tr>
          {% else %}
          <tr>
            <td colspan="5" class="text-center">Nenhuma empresa encontrada</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Checklists Recentes -->
  <div class="dashboard-table">
    <h3><i class="fas fa-tasks"></i> Checklists Recentes</h3>
    <div class="table-responsive">
      <table class="table">
        <thead>
          <tr>
            <th>Nome</th>
            <th>Empresa</th>
            <th>Itens</th>
            <th>Criado em</th>
            <th>A√ß√µes</th>
          </tr>
        </thead>
        <tbody>
          {% for checklist in checklists_recentes %}
          <tr>
            <td>{{ checklist.nome }}</td>
            <td>{{ checklist.empresa.nome }}</td>
            <td>{{ checklist.itens|length }} itens</td>
            <td>{{ checklist.criado_em.strftime('%d/%m/%Y') if checklist.criado_em else 'N/A' }}</td>
            <td>
              <a href="/supervisor/checklists/{{ checklist.id }}" class="btn btn-sm btn-info">
                <i class="fas fa-eye"></i> Visualizar
              </a>
            </td>
          </tr>
          {% else %}
          <tr>
            <td colspan="5" class="text-center">Nenhum checklist encontrado</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</section>

<script>
// Debug para painel do supervisor
console.log('üîß Carregando painel do supervisor...');

document.addEventListener('DOMContentLoaded', function() {
  console.log('üìã Verificando bot√µes do painel do supervisor...');
  
  // Verificar se os bot√µes existem
  const btnEmpresas = document.querySelector('a[href="/supervisor/empresas"]');
  const btnChecklists = document.querySelector('a[href="/supervisor/checklists"]');
  const btnTemplates = document.querySelector('a[href="/supervisor/templates"]');
  
  console.log('üè¢ Bot√£o Empresas:', btnEmpresas ? '‚úÖ Encontrado' : '‚ùå N√£o encontrado');
  console.log('üìã Bot√£o Checklists:', btnChecklists ? '‚úÖ Encontrado' : '‚ùå N√£o encontrado');
  console.log('üìù Bot√£o Templates:', btnTemplates ? '‚úÖ Encontrado' : '‚ùå N√£o encontrado');
  
  if (btnEmpresas) {
    console.log('   - Texto:', btnEmpresas.textContent.trim());
    console.log('   - Href:', btnEmpresas.href);
    console.log('   - Classes:', btnEmpresas.className);
    console.log('   - Display:', getComputedStyle(btnEmpresas).display);
    console.log('   - Visibility:', getComputedStyle(btnEmpresas).visibility);
    console.log('   - Z-index:', getComputedStyle(btnEmpresas).zIndex);
    console.log('   - Pointer-events:', getComputedStyle(btnEmpresas).pointerEvents);
  }
  
  // Adicionar listener de debug para o bot√£o de empresas
  if (btnEmpresas) {
    btnEmpresas.addEventListener('click', function(e) {
      console.log('üñ±Ô∏è Bot√£o Empresas clicado!');
      console.log('   - Evento:', e);
      console.log('   - Target:', e.target);
    });
  }
  
  // Verificar se h√° elementos sobrepondo
  const headerActions = document.querySelector('.header-actions');
  if (headerActions) {
    console.log('üì¶ Container header-actions:', headerActions ? '‚úÖ Encontrado' : '‚ùå N√£o encontrado');
    console.log('   - Display:', getComputedStyle(headerActions).display);
    console.log('   - Position:', getComputedStyle(headerActions).position);
    console.log('   - Z-index:', getComputedStyle(headerActions).zIndex);
  }
  
  console.log('‚úÖ Verifica√ß√£o do painel do supervisor conclu√≠da');
});
</script>

<!-- Modal para alterar tributa√ß√£o -->
<div id="modalAlterarTributacao" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3><i class="fas fa-edit"></i> Alterar Tributa√ß√£o</h3>
      <span class="close" onclick="closeModal('modalAlterarTributacao')">&times;</span>
    </div>
    <div class="modal-body">
      <form id="formAlterarTributacao">
        <input type="hidden" id="empresaIdTributacao" name="empresa_id">
        
        <div class="form-group">
          <label for="tributacaoAtual">Tributa√ß√£o Atual:</label>
          <input type="text" id="tributacaoAtual" class="form-control" readonly>
        </div>
        
        <div class="form-group">
          <label for="novaTributacao">Nova Tributa√ß√£o:</label>
          <select id="novaTributacao" name="tributacao_id" class="form-control">
            <option value="">Selecione uma tributa√ß√£o</option>
            <option value="1">Simples Nacional</option>
            <option value="2">Regime Normal</option>
          </select>
        </div>
        
        <div class="form-actions">
          <button type="button" class="btn btn-secondary" onclick="closeModal('modalAlterarTributacao')">Cancelar</button>
          <button type="submit" class="btn btn-primary">Alterar Tributa√ß√£o</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
// Fun√ß√£o para alterar tributa√ß√£o
function alterarTributacao(empresaId, tributacaoAtual) {
  document.getElementById('empresaIdTributacao').value = empresaId;
  document.getElementById('tributacaoAtual').value = tributacaoAtual || 'Sem tributa√ß√£o';
  document.getElementById('novaTributacao').value = '';
  showModal('modalAlterarTributacao');
}

// Formul√°rio de alterar tributa√ß√£o
document.getElementById('formAlterarTributacao').addEventListener('submit', function(e) {
  e.preventDefault();
  
  const empresaId = document.getElementById('empresaIdTributacao').value;
  const tributacaoId = document.getElementById('novaTributacao').value;
  
  fetch(`/supervisor/empresas/${empresaId}/tributacao`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    credentials: 'same-origin',
    body: JSON.stringify({
      tributacao_id: tributacaoId || null
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      showFeedback('Tributa√ß√£o alterada com sucesso!', 'success');
      closeModal('modalAlterarTributacao');
      // Recarregar p√°gina ap√≥s 1 segundo
      setTimeout(() => {
        window.location.reload();
      }, 1000);
    } else {
      showFeedback(data.message || 'Erro ao alterar tributa√ß√£o', 'error');
    }
  })
  .catch(error => {
    console.error('Erro:', error);
    showFeedback('Erro ao alterar tributa√ß√£o', 'error');
  });
});
</script>
{% endblock %}
