{% extends "base.html" %}

{% block title %}Gerenciamento - Sistema DP & Contabilidade{% endblock %}

{% block content %}
<section class="dashboard-section">
  <div class="dashboard-header">
    <h1><i class="fas fa-chart-line"></i> Painel do Gerente</h1>
    <p>Acompanhe o andamento das tarefas por setor, per√≠odo e empresa</p>
    
    <!-- Notifica√ß√£o de Mudan√ßas de Tributa√ß√£o -->
    {% if mudancas_pendentes and mudancas_pendentes > 0 %}
      <div class="notification-badge">
        <a href="/gerenciamento/mudancas-tributacao" class="notification-link">
          <i class="fas fa-exchange-alt"></i>
          <span class="notification-text">
            {{ mudancas_pendentes }} mudan√ßa(s) de tributa√ß√£o pendente(s)
          </span>
          <span class="notification-count">{{ mudancas_pendentes }}</span>
        </a>
      </div>
    {% endif %}
  </div>

  <!-- Container de Feedback -->
  <div id="feedback-container" style="display: none;"></div>

  <!-- Filtros -->
  <form id="filtroGerente" class="dashboard-filters">
    <div class="form-row">
      <div class="form-group">
        <label for="periodo">Per√≠odo (MM/AAAA)</label>
        <input type="text" id="periodo" name="periodo" value="{{ periodo_atual if periodo_atual else get_previous_period() }}" 
               placeholder="Ex: 01/2025" required pattern="[0-9]{2}/[0-9]{4}" 
               title="Digite o per√≠odo no formato MM/AAAA">
        <small class="info-text">Formato: MM/AAAA (ex: 01/2025)</small>
      </div>
      <div class="form-group">
        <label for="empresa">Empresa</label>
        <div class="empresa-search-container multiple-selection">
          <input type="text" id="empresa-search" placeholder="Digite para buscar empresa..." autocomplete="off">
          <div id="empresa-results" class="search-results" style="display: none;"></div>
          <input type="hidden" id="empresa_ids" name="empresa_ids" value="{{ empresa_atual or '' }}">
          <div id="empresa-selected" class="selected-items-container">
            {% if empresa_atual %}
              {% for e in empresas or [] %}
                {% if e.id == empresa_atual %}
                  <div class="selected-item">
                    <span class="selected-item-text">{{ e.nome }}</span>
                    <button type="button" class="selected-item-remove" onclick="removeEmpresa({{ e.id }}, '{{ e.nome }}')">&times;</button>
                  </div>
                {% endif %}
              {% endfor %}
            {% else %}
              <div class="selected-item">
                <span class="selected-item-text">Todas as empresas</span>
              </div>
            {% endif %}
          </div>
        </div>
      </div>
      <div class="form-group">
        <label for="colaborador">Colaborador (opcional)</label>
        <div class="colaborador-search-container multiple-selection">
          <input type="text" id="colaborador-search" placeholder="Digite para buscar colaborador..." autocomplete="off">
          <div id="colaborador-results" class="search-results" style="display: none;"></div>
          <input type="hidden" id="colaborador_id" name="colaborador_id" value="">
          <div id="colaborador-selected" class="selected-items-container">
            <div class="selected-item">
              <span class="selected-item-text">Todos os colaboradores</span>
            </div>
          </div>
        </div>
      </div>
      <div class="form-group">
        <label for="tarefa">Tarefa (opcional)</label>
        <div class="tarefa-search-container multiple-selection">
          <input type="text" id="tarefa-search" placeholder="Digite para buscar tarefa..." autocomplete="off">
          <div id="tarefa-results" class="search-results" style="display: none;"></div>
          <input type="hidden" id="tarefa_id" name="tarefa_id" value="">
          <div id="tarefa-selected" class="selected-items-container">
            <div class="selected-item">
              <span class="selected-item-text">Todas as tarefas</span>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="form-actions">
      <button type="button" class="btn btn-primary" onclick="applyFilters()"><i class="fas fa-filter"></i> Aplicar</button>
      <button type="button" class="btn btn-secondary" onclick="clearAllFilters()"><i class="fas fa-times"></i> Limpar</button>
    </div>
  </form>

  <!-- M√©tricas -->
  <div class="dashboard-metrics">
    <div class="metric-card">
      <div class="metric-icon pendentes">
        <i class="fas fa-clock"></i>
      </div>
      <div class="metric-content">
        <div class="metric-value" id="metric-pendentes">{{ resumo.pendentes }}</div>
        <div class="metric-label">Pendentes</div>
        <div class="metric-description">Aguardando a√ß√£o</div>
      </div>
    </div>
    
    <div class="metric-card">
      <div class="metric-icon fazendo">
        <i class="fas fa-play"></i>
      </div>
      <div class="metric-content">
        <div class="metric-value" id="metric-fazendo">{{ resumo.fazendo }}</div>
        <div class="metric-label">Em Andamento</div>
        <div class="metric-description">No per√≠odo selecionado</div>
      </div>
    </div>
    
    <div class="metric-card">
      <div class="metric-icon concluidas">
        <i class="fas fa-check-circle"></i>
      </div>
      <div class="metric-content">
        <div class="metric-value" id="metric-concluidas">{{ resumo.concluidas }}</div>
        <div class="metric-label">Conclu√≠das</div>
        <div class="metric-description">Finalizadas</div>
      </div>
    </div>
    
    <div class="metric-card">
      <div class="metric-icon taxa-conclusao">
        <i class="fas fa-percentage"></i>
      </div>
      <div class="metric-content">
        <div class="metric-value" id="metric-taxa-conclusao">{{ "%.0f"|format(taxa_conclusao) }}%</div>
        <div class="metric-label">Taxa de Conclus√£o</div>
        <div class="metric-description">Efici√™ncia do setor/empresa</div>
      </div>
    </div>
  </div>

  <!-- Tabelas de Vis√£o -->
  <div class="dashboard-tables">
    <!-- Vis√£o por Empresa -->
    <div class="table-container">
      <h3>Vis√£o por Empresa</h3>
      <div class="table-responsive">
        <table class="table">
          <thead>
            <tr>
              <th>Empresa</th>
              <th>Pendentes</th>
              <th>Em Andamento</th>
              <th>Conclu√≠das</th>
              <th>Conclus√£o</th>
            </tr>
          </thead>
          <tbody id="empresas-table-body">
            {% for empresa in empresas_resumo %}
            <tr>
              <td>{{ empresa.nome }}</td>
              <td>{{ empresa.pendentes }}</td>
              <td>{{ empresa.fazendo }}</td>
              <td>{{ empresa.concluidas }}</td>
              <td>{{ empresa.taxa_conclusao }}%</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- Vis√£o por Respons√°vel -->
    <div class="table-container">
      <h3>Vis√£o por Respons√°vel</h3>
      <div class="table-responsive">
        <table class="table">
          <thead>
            <tr>
              <th>Respons√°vel</th>
              <th>Empresa</th>
              <th>Tarefa</th>
              <th>Status</th>
              <th>Per√≠odo</th>
            </tr>
          </thead>
          <tbody id="responsaveis-table-body">
            {% for responsavel in responsaveis_tarefas %}
            <tr>
              <td>{{ responsavel.usuario_nome }}</td>
              <td>{{ responsavel.empresa_nome }}</td>
              <td>{{ responsavel.tarefa_nome }}</td>
              <td>
                {% if responsavel.status == 'concluida' %}
                  <span class="status-badge status-active">Conclu√≠da</span>
                {% elif responsavel.status == 'retificada' %}
                  <span class="status-badge status-warning">Retificada ({{ responsavel.contador_retificacoes }}x)</span>
                {% elif responsavel.status == 'pendente' %}
                  <span class="status-badge status-pending">Pendente</span>
                {% else %}
                  <span class="status-badge status-inactive">Em Andamento</span>
                {% endif %}
              </td>
              <td>{{ responsavel.periodo_label|br_period }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- Tarefas Anuais -->
    <div class="table-container" id="tarefas-anuais-section" style="display: none;">
      <h3><i class="fas fa-calendar-alt"></i> Tarefas Anuais</h3>
      <p class="info-text">Tarefas que podem ser conclu√≠das em qualquer data do ano</p>
      <div class="table-responsive">
        <table class="table">
          <thead>
            <tr>
              <th>Respons√°vel</th>
              <th>Empresa</th>
              <th>Tarefa</th>
              <th>Status</th>
              <th>Ano</th>
            </tr>
          </thead>
          <tbody id="tarefas-anuais-table-body">
            <!-- Tarefas anuais ser√£o carregadas via JavaScript -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- Novo Painel de Tarefas Integrado -->
    <div class="table-container">
      <div class="panel-header">
        <h3><i class="fas fa-tasks"></i> Gerenciamento de Tarefas</h3>
        <div class="panel-actions">
          <button class="btn btn-success btn-sm" onclick="abrirModalNovaTarefa()">
            <i class="fas fa-plus"></i> Nova Tarefa
          </button>
          <button class="btn btn-primary btn-sm" onclick="abrirModalVincularResponsavel()">
            <i class="fas fa-link"></i> Vincular Respons√°vel
          </button>
        </div>
      </div>
      <div class="table-responsive">
        <table class="table">
          <thead>
            <tr>
              <th>Nome</th>
              <th>Tipo</th>
              <th>Setor</th>
              <th>Tributa√ß√£o</th>
              <th>A√ß√µes</th>
            </tr>
          </thead>
          <tbody id="tarefas-gerenciamento-body">
            <tr>
              <td colspan="5" style="text-align: center; padding: 30px;">
                <i class="fas fa-spinner fa-spin"></i> Carregando tarefas...
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</section>

<!-- Modal Nova Tarefa Integrado -->
<div class="modal fade" id="modalNovaTarefa" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fas fa-plus"></i> Nova Tarefa</h5>
        <button type="button" class="btn-close" onclick="fecharModalNovaTarefa()"></button>
      </div>
      <div class="modal-body">
        <form id="formNovaTarefa">
          <div class="mb-3">
            <label for="nova-tarefa-nome" class="form-label">Nome da Tarefa *</label>
            <input type="text" class="form-control" id="nova-tarefa-nome" required>
          </div>
          <div class="mb-3">
            <label for="nova-tarefa-tipo" class="form-label">Tipo *</label>
            <select class="form-control" id="nova-tarefa-tipo" required>
              <option value="">Selecione o tipo</option>
              <option value="Mensal">Mensal</option>
              <option value="Anual">Anual</option>
              <option value="Semanal">Semanal</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="nova-tarefa-setor" class="form-label">Setor *</label>
            <select class="form-control" id="nova-tarefa-setor" required>
              <option value="">Selecione o setor</option>
              <!-- Ser√° preenchido via JavaScript -->
            </select>
          </div>
          <div class="mb-3">
            <label for="nova-tarefa-tributacao" class="form-label">Tributa√ß√£o</label>
            <select class="form-control" id="nova-tarefa-tributacao">
              <option value="">Deixe vazio para tarefa comum</option>
              <!-- Ser√° preenchido via JavaScript -->
            </select>
          </div>
          <div class="mb-3">
            <label for="nova-tarefa-descricao" class="form-label">Descri√ß√£o</label>
            <textarea class="form-control" id="nova-tarefa-descricao" rows="3"></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="fecharModalNovaTarefa()">Cancelar</button>
        <button type="button" class="btn btn-primary" onclick="salvarNovaTarefa()">Criar Tarefa</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Vincular Respons√°vel Integrado -->
<div class="modal fade" id="modalVincularResponsavelIntegrado" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fas fa-link"></i> Vincular Respons√°vel</h5>
        <button type="button" class="btn-close" onclick="fecharModalVincularResponsavelIntegrado()"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label for="busca-empresa-vincular" class="form-label">1. Buscar Empresa *</label>
          <input type="text" class="form-control" id="busca-empresa-vincular" 
                 placeholder="Digite o nome da empresa..." autocomplete="off">
          <div id="resultados-empresa-vincular" class="search-results" style="display: none;"></div>
          <input type="hidden" id="empresa-selecionada-id" value="">
          <div id="empresa-selecionada-info" class="mt-2" style="display: none;">
            <span class="badge bg-primary"></span>
          </div>
        </div>
        
        <div class="mb-3">
          <label class="form-label">2. Tarefas Dispon√≠veis</label>
          <div id="tarefas-disponiveis" style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; border-radius: 4px;">
            <p class="text-muted">Selecione uma empresa primeiro para ver as tarefas dispon√≠veis.</p>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="fecharModalVincularResponsavelIntegrado()">Cancelar</button>
        <button type="button" class="btn btn-primary" onclick="confirmarVinculacaoIntegrada()">Vincular</button>
      </div>
    </div>
  </div>
</div>

<!-- Modais removidos - funcionalidades integradas ao novo painel de tarefas -->

<script>
// ===== INICIALIZA√á√ÉO SIMPLIFICADA =====
document.addEventListener('DOMContentLoaded', function() {
  console.log('üöÄ Painel do gerente inicializado - funcionalidades integradas ao novo painel de tarefas');
  // carregarTarefasGerenciamento(); // COMENTADO - Use o novo sistema V2 em /tarefas-v2/
  carregarDadosModais();
  console.log('‚ÑπÔ∏è Para atribuir tarefas, clique em "Atribuir Tarefas" no menu lateral ou no bot√£o verde acima');
});

// ===== FUN√á√ïES DO NOVO PAINEL DE TAREFAS =====

// Carregar tarefas no painel integrado
function carregarTarefasGerenciamento() {
  console.log('üìã Carregando tarefas do gerenciamento...');
  
  fetch('/tarefas-melhoradas/api/tarefas', {
    credentials: 'same-origin'
  })
  .then(response => response.json())
  .then(data => {
    console.log('üì• Tarefas recebidas:', data);
    if (data.success && data.tarefas) {
      mostrarTarefasGerenciamento(data.tarefas);
    } else {
      document.getElementById('tarefas-gerenciamento-body').innerHTML = 
        '<tr><td colspan="5" style="text-align: center; padding: 30px; color: #b8c2d3;">Nenhuma tarefa encontrada</td></tr>';
    }
  })
  .catch(error => {
    console.error('‚ùå Erro ao carregar tarefas:', error);
    document.getElementById('tarefas-gerenciamento-body').innerHTML = 
      '<tr><td colspan="5" style="text-align: center; padding: 30px; color: #ff6b6b;">Erro ao carregar tarefas</td></tr>';
  });
}

function mostrarTarefasGerenciamento(tarefas) {
  const tbody = document.getElementById('tarefas-gerenciamento-body');
  
  if (tarefas.length === 0) {
    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 30px; color: #b8c2d3;">Nenhuma tarefa encontrada</td></tr>';
    return;
  }
  
  tbody.innerHTML = tarefas.map(tarefa => `
    <tr>
      <td>${tarefa.nome}</td>
      <td><span class="badge badge-info">${tarefa.tipo}</span></td>
      <td>${tarefa.setor || 'N/A'}</td>
      <td>${tarefa.tributacao || 'Comum'}</td>
      <td>
        <button class="btn btn-sm btn-warning" onclick="editarTarefa(${tarefa.id})">
          <i class="fas fa-edit"></i> Editar
        </button>
        <button class="btn btn-sm btn-danger" onclick="excluirTarefa(${tarefa.id})">
          <i class="fas fa-trash"></i> Excluir
        </button>
      </td>
    </tr>
  `).join('');
}

// ===== MODAL NOVA TAREFA =====
function abrirModalNovaTarefa() {
  console.log('üìù Abrindo modal nova tarefa...');
  carregarDadosModais();
  showModal('modalNovaTarefa');
}

function fecharModalNovaTarefa() {
  closeModal('modalNovaTarefa');
  document.getElementById('formNovaTarefa').reset();
}

function salvarNovaTarefa() {
  console.log('üíæ Salvando nova tarefa...');
  
  const nome = document.getElementById('nova-tarefa-nome').value;
  const tipo = document.getElementById('nova-tarefa-tipo').value;
  const setor = document.getElementById('nova-tarefa-setor').value;
  const tributacao = document.getElementById('nova-tarefa-tributacao').value;
  const descricao = document.getElementById('nova-tarefa-descricao').value;
  
  if (!nome || !tipo || !setor) {
    alert('Preencha os campos obrigat√≥rios: Nome, Tipo e Setor');
    return;
  }
  
  const dados = {
    nome: nome,
    tipo: tipo,
    setor_id: parseInt(setor),
    tributacao_id: tributacao ? parseInt(tributacao) : null,
    descricao: descricao,
    tarefa_comum: tributacao ? false : true
  };
  
  console.log('üì§ Enviando dados:', dados);
  
  fetch('/tarefas-melhoradas/api/tarefas', {
    method: 'POST',
    credentials: 'same-origin',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(dados)
  })
  .then(response => response.json())
  .then(data => {
    console.log('üì• Resposta:', data);
    if (data.success) {
      alert('‚úÖ Tarefa criada com sucesso!');
      fecharModalNovaTarefa();
      carregarTarefasGerenciamento();
    } else {
      alert('‚ùå Erro: ' + data.message);
    }
  })
  .catch(error => {
    console.error('‚ùå Erro:', error);
    alert('‚ùå Erro ao criar tarefa');
  });
}

// ===== MODAL VINCULAR RESPONS√ÅVEL =====
function abrirModalVincularResponsavel() {
  console.log('üìù Abrindo modal vincular respons√°vel...');
  showModal('modalVincularResponsavelIntegrado');
  configurarBuscaEmpresa();
}

function fecharModalVincularResponsavelIntegrado() {
  closeModal('modalVincularResponsavelIntegrado');
  document.getElementById('busca-empresa-vincular').value = '';
  document.getElementById('empresa-selecionada-id').value = '';
  document.getElementById('empresa-selecionada-info').style.display = 'none';
  document.getElementById('resultados-empresa-vincular').style.display = 'none';
  document.getElementById('tarefas-disponiveis').innerHTML = '<p class="text-muted">Selecione uma empresa primeiro para ver as tarefas dispon√≠veis.</p>';
}

function configurarBuscaEmpresa() {
  const input = document.getElementById('busca-empresa-vincular');
  const resultados = document.getElementById('resultados-empresa-vincular');
  let timeout;
  
  input.addEventListener('input', function() {
    const query = this.value.trim();
    
    clearTimeout(timeout);
    if (query.length < 2) {
      resultados.style.display = 'none';
      return;
    }
    
    timeout = setTimeout(() => {
      buscarEmpresasVinculacao(query);
    }, 300);
  });
}

function buscarEmpresasVinculacao(query) {
  console.log('üîç Buscando empresas para vincula√ß√£o:', query);
  
  fetch(`/tarefas-melhoradas/api/empresas?search=${encodeURIComponent(query)}`, {
    credentials: 'same-origin'
  })
  .then(response => response.json())
  .then(data => {
    console.log('üì• Empresas encontradas:', data);
    mostrarEmpresasVinculacao(data.empresas || []);
  })
  .catch(error => {
    console.error('‚ùå Erro ao buscar empresas:', error);
  });
}

function mostrarEmpresasVinculacao(empresas) {
  const div = document.getElementById('resultados-empresa-vincular');
  
  if (empresas.length === 0) {
    div.innerHTML = '<div class="search-result-item">Nenhuma empresa encontrada</div>';
  } else {
    div.innerHTML = empresas.map(empresa => `
      <div class="search-result-item" onclick="selecionarEmpresaVinculacao(${empresa.id}, '${empresa.nome}')">
        <strong>${empresa.nome}</strong><br>
        <small>C√≥digo: ${empresa.codigo}</small>
      </div>
    `).join('');
  }
  div.style.display = 'block';
}

function selecionarEmpresaVinculacao(id, nome) {
  console.log('‚úÖ Empresa selecionada para vincula√ß√£o:', id, nome);
  
  document.getElementById('empresa-selecionada-id').value = id;
  document.getElementById('empresa-selecionada-info').querySelector('.badge').textContent = nome;
  document.getElementById('empresa-selecionada-info').style.display = 'block';
  document.getElementById('resultados-empresa-vincular').style.display = 'none';
  document.getElementById('busca-empresa-vincular').value = '';
  
  // Carregar tarefas dispon√≠veis para esta empresa
  carregarTarefasDisponiveis(id);
}

function carregarTarefasDisponiveis(empresaId) {
  console.log('üìã Carregando tarefas dispon√≠veis para empresa:', empresaId);
  
  fetch(`/tarefas-melhoradas/api/tarefas?empresa_id=${empresaId}`, {
    credentials: 'same-origin'
  })
  .then(response => response.json())
  .then(data => {
    console.log('üì• Tarefas dispon√≠veis:', data);
    if (data.success && data.tarefas) {
      mostrarTarefasDisponiveis(data.tarefas);
    } else {
      document.getElementById('tarefas-disponiveis').innerHTML = '<p class="text-muted">Nenhuma tarefa dispon√≠vel para vincula√ß√£o.</p>';
    }
  })
  .catch(error => {
    console.error('‚ùå Erro ao carregar tarefas dispon√≠veis:', error);
    document.getElementById('tarefas-disponiveis').innerHTML = '<p class="text-danger">Erro ao carregar tarefas.</p>';
  });
}

function mostrarTarefasDisponiveis(tarefas) {
  const div = document.getElementById('tarefas-disponiveis');
  
  if (tarefas.length === 0) {
    div.innerHTML = '<p class="text-muted">Nenhuma tarefa dispon√≠vel para vincula√ß√£o.</p>';
    return;
  }
  
  div.innerHTML = tarefas.map(tarefa => `
    <div class="form-check">
      <input class="form-check-input" type="checkbox" value="${tarefa.id}" id="tarefa-vincular-${tarefa.id}">
      <label class="form-check-label" for="tarefa-vincular-${tarefa.id}">
        ${tarefa.nome} (${tarefa.tipo}) - ${tarefa.setor || 'N/A'}
      </label>
    </div>
  `).join('');
}

function confirmarVinculacaoIntegrada() {
  console.log('üíæ Confirmando vincula√ß√£o...');
  
  const empresaId = document.getElementById('empresa-selecionada-id').value;
  
  if (!empresaId) {
    alert('Selecione uma empresa primeiro');
    return;
  }
  
  const tarefasSelecionadas = [];
  const checkboxes = document.querySelectorAll('#tarefas-disponiveis input[type="checkbox"]:checked');
  checkboxes.forEach(checkbox => {
    tarefasSelecionadas.push(parseInt(checkbox.value));
  });
  
  if (tarefasSelecionadas.length === 0) {
    alert('Selecione pelo menos uma tarefa para vincular');
    return;
  }
  
  console.log('üì§ Vinculando tarefas:', { empresaId, tarefasSelecionadas });
  alert('Funcionalidade de vincula√ß√£o ser√° implementada em breve');
}

// ===== CARREGAMENTO DE DADOS =====
function carregarDadosModais() {
  // Carregar setores para o modal de nova tarefa
  fetch('/gerenciamento/api/setores')
    .then(response => response.json())
    .then(data => {
      const select = document.getElementById('nova-tarefa-setor');
      if (select && data.success) {
        select.innerHTML = '<option value="">Selecione o setor</option>';
        data.setores.forEach(setor => {
          const option = document.createElement('option');
          option.value = setor.id;
          option.textContent = setor.nome;
          select.appendChild(option);
        });
      }
    })
    .catch(error => console.error('‚ùå Erro ao carregar setores:', error));
  
  // Carregar tributa√ß√µes para o modal de nova tarefa
  fetch('/gerenciamento/api/tributacoes')
    .then(response => response.json())
    .then(data => {
      const select = document.getElementById('nova-tarefa-tributacao');
      if (select && data.success) {
        select.innerHTML = '<option value="">Deixe vazio para tarefa comum</option>';
        data.tributacoes.forEach(tributacao => {
          const option = document.createElement('option');
          option.value = tributacao.id;
          option.textContent = tributacao.nome;
          select.appendChild(option);
        });
      }
    })
    .catch(error => console.error('‚ùå Erro ao carregar tributa√ß√µes:', error));
}

// ===== FUN√á√ïES AUXILIARES =====
function editarTarefa(id) {
  console.log('‚úèÔ∏è Editando tarefa:', id);
  alert('Funcionalidade de edi√ß√£o ser√° implementada em breve');
}

function excluirTarefa(id) {
  console.log('üóëÔ∏è Excluindo tarefa:', id);
  if (confirm('Tem certeza que deseja excluir esta tarefa?')) {
    alert('Funcionalidade de exclus√£o ser√° implementada em breve');
  }
}
</script>

<!-- JavaScript centralizado no script.js -->
{% endblock %}

<style>
/* Estilos para notifica√ß√£o de mudan√ßas de tributa√ß√£o */
.notification-badge {
  margin-top: 15px;
  animation: pulse 2s infinite;
}

.notification-link {
  display: inline-flex;
  align-items: center;
  gap: 10px;
  background: #e74c3c;
  color: white;
  padding: 12px 20px;
  border-radius: 8px;
  text-decoration: none;
  font-weight: 500;
  box-shadow: 0 4px 12px rgba(231, 76, 60, 0.3);
  transition: all 0.3s ease;
}

.notification-link:hover {
  background: #c0392b;
  transform: translateY(-2px);
  box-shadow: 0 6px 16px rgba(231, 76, 60, 0.4);
  color: white;
  text-decoration: none;
}

.notification-text {
  font-size: 0.95rem;
}

.notification-count {
  background: white;
  color: #e74c3c;
  padding: 4px 8px;
  border-radius: 12px;
  font-weight: 700;
  font-size: 0.85rem;
  min-width: 24px;
  text-align: center;
}

@keyframes pulse {
  0% {
    box-shadow: 0 4px 12px rgba(231, 76, 60, 0.3);
  }
  50% {
    box-shadow: 0 4px 12px rgba(231, 76, 60, 0.6);
  }
  100% {
    box-shadow: 0 4px 12px rgba(231, 76, 60, 0.3);
  }
}

@media (max-width: 768px) {
  .notification-link {
    flex-direction: column;
    text-align: center;
    gap: 8px;
  }
  
  .notification-text {
    font-size: 0.9rem;
  }
}
</style>

