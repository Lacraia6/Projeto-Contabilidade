{% extends "base.html" %}

{% block title %}Gerenciamento - Sistema DP & Contabilidade{% endblock %}

{% block content %}
<section class="gerenciamento-section">
  <div class="section-header">
    <h1><i class="fas fa-chart-line"></i> Painel do Gerente</h1>
    <p>Acompanhe o andamento das tarefas por setor, período e empresa</p>
  </div>

  <!-- Container de Feedback -->
  <div id="feedback-container" style="display: none;"></div>

  <!-- Filtros -->
  <form id="filtroGerente" class="dashboard-filters">
    <div class="form-row">
      <div class="form-group">
        <label for="periodo">Período (MM/AAAA)</label>
        <input type="text" id="periodo" name="periodo" value="{{ periodo_atual|br_period if periodo_atual else '{{ get_previous_period() }}' }}" 
               placeholder="Ex: 01/2025" required pattern="[0-9]{2}/[0-9]{4}" 
               title="Digite o período no formato MM/AAAA">
        <small class="info-text">Formato: MM/AAAA (ex: 01/2025)</small>
      </div>
      <div class="form-group">
        <label for="empresa">Empresa</label>
        <div class="empresa-search-container multiple-selection">
          <input type="text" id="empresa-search" placeholder="Digite para buscar empresa..." autocomplete="off">
          <div id="empresa-results" class="search-results" style="display: none;"></div>
          <input type="hidden" id="empresa_ids" name="empresa_ids" value="{{ empresa_atual or '' }}">
          <div id="empresa-selected" class="selected-items-container">
            {% if empresa_atual %}
              {% for e in empresas or [] %}
                {% if e.id == empresa_atual %}
                  <div class="selected-item">
                    <span class="selected-item-text">{{ e.nome }}</span>
                    <button type="button" class="selected-item-remove" onclick="removeEmpresa({{ e.id }}, '{{ e.nome }}')">&times;</button>
                  </div>
                {% endif %}
              {% endfor %}
            {% else %}
              <div class="selected-item">
                <span class="selected-item-text">Todas as empresas</span>
              </div>
            {% endif %}
          </div>
        </div>
      </div>
      <div class="form-group">
        <label for="colaborador">Colaborador (opcional)</label>
        <div class="colaborador-search-container">
          <input type="text" id="colaborador-search" placeholder="Digite para buscar colaborador..." autocomplete="off">
          <div id="colaborador-results" class="search-results" style="display: none;"></div>
          <input type="hidden" id="colaborador_id" name="colaborador_id" value="">
          <div id="colaborador-selected" class="selected-item">
            <span class="selected-item-text">Todos os colaboradores</span>
          </div>
        </div>
      </div>
      <div class="form-group">
        <label for="tarefa">Tarefa (opcional)</label>
        <div class="tarefa-search-container">
          <input type="text" id="tarefa-search" placeholder="Digite para buscar tarefa..." autocomplete="off">
          <div id="tarefa-results" class="search-results" style="display: none;"></div>
          <input type="hidden" id="tarefa_id" name="tarefa_id" value="">
          <div id="tarefa-selected" class="selected-item">
            <span class="selected-item-text">Todas as tarefas</span>
          </div>
        </div>
      </div>
    </div>
    <div class="form-actions">
      <button type="button" class="btn btn-primary" onclick="applyFilters()"><i class="fas fa-filter"></i> Aplicar</button>
      <button type="button" class="btn btn-secondary" onclick="clearAllFilters()"><i class="fas fa-times"></i> Limpar</button>
    </div>
  </form>

  <!-- Métricas -->
  <div class="dashboard-metrics">
    <div class="metric-card">
      <div class="metric-icon">
        <i class="fas fa-clock"></i>
      </div>
      <div class="metric-content">
        <div class="metric-value" id="metric-pendentes">{{ resumo.pendentes }}</div>
        <div class="metric-label">Pendentes</div>
        <div class="metric-description">Aguardando ação</div>
      </div>
    </div>
    
    <div class="metric-card">
      <div class="metric-icon">
        <i class="fas fa-play"></i>
      </div>
      <div class="metric-content">
        <div class="metric-value" id="metric-fazendo">{{ resumo.fazendo }}</div>
        <div class="metric-label">Em Andamento</div>
        <div class="metric-description">No período selecionado</div>
      </div>
    </div>
    
    <div class="metric-card">
      <div class="metric-icon">
        <i class="fas fa-check-circle"></i>
      </div>
      <div class="metric-content">
        <div class="metric-value" id="metric-concluidas">{{ resumo.concluidas }}</div>
        <div class="metric-label">Concluídas</div>
        <div class="metric-description">Finalizadas</div>
      </div>
    </div>
    
    <div class="metric-card">
      <div class="metric-icon">
        <i class="fas fa-percentage"></i>
      </div>
      <div class="metric-content">
        <div class="metric-value" id="metric-taxa-conclusao">{{ "%.0f"|format(taxa_conclusao) }}%</div>
        <div class="metric-label">Taxa de Conclusão</div>
        <div class="metric-description">Eficiência do setor/empresa</div>
      </div>
    </div>
  </div>

  <!-- Tabelas de Visão -->
  <div class="dashboard-tables">
    <!-- Visão por Empresa -->
    <div class="table-container">
      <h3>Visão por Empresa</h3>
      <div class="table-responsive">
        <table class="table">
          <thead>
            <tr>
              <th>Empresa</th>
              <th>Pendentes</th>
              <th>Em Andamento</th>
              <th>Concluídas</th>
              <th>Conclusão</th>
            </tr>
          </thead>
          <tbody id="empresas-table-body">
            {% for empresa in empresas_resumo %}
            <tr>
              <td>{{ empresa.nome }}</td>
              <td>{{ empresa.pendentes }}</td>
              <td>{{ empresa.fazendo }}</td>
              <td>{{ empresa.concluidas }}</td>
              <td>{{ empresa.taxa_conclusao }}%</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- Visão por Responsável -->
    <div class="table-container">
      <h3>Visão por Responsável</h3>
      <div class="table-responsive">
        <table class="table">
          <thead>
            <tr>
              <th>Responsável</th>
              <th>Empresa</th>
              <th>Tarefa</th>
              <th>Status</th>
              <th>Período</th>
            </tr>
          </thead>
          <tbody id="responsaveis-table-body">
            {% for responsavel in responsaveis_tarefas %}
            <tr>
              <td>{{ responsavel.nome }}</td>
              <td>{{ responsavel.empresa_nome }}</td>
              <td>{{ responsavel.tarefa_nome }}</td>
              <td>
                {% if responsavel.status == 'concluida' %}
                  <span class="status-badge status-active">Concluída</span>
                {% elif responsavel.status == 'retificada' %}
                  <span class="status-badge status-warning">Retificada ({{ responsavel.contador_retificacoes }}x)</span>
                {% elif responsavel.status == 'pendente' %}
                  <span class="status-badge status-pending">Pendente</span>
                {% else %}
                  <span class="status-badge status-inactive">Em Andamento</span>
                {% endif %}
              </td>
              <td>{{ responsavel.periodo_label }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</section>

<!-- JavaScript centralizado no script.js -->
{% endblock %}

