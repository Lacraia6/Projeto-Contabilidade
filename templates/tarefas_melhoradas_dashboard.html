{% extends "base.html" %}

{% block title %}Sistema Melhorado de Tarefas{% endblock %}

{% block content %}
<section id="tarefas-melhoradas" class="tab-content active">
  <div class="page-header">
    <h1><i class="fas fa-tasks"></i> Sistema Melhorado de Tarefas</h1>
    <p>Gerencie empresas, tributa√ß√£o e tarefas de forma inteligente</p>
    {% if usuario_logado.tipo == 'gerente' %}
    <div class="alert alert-info">
      <i class="fas fa-info-circle"></i> 
      <strong>Filtro por Setor:</strong> Voc√™ est√° visualizando apenas as tarefas do seu setor: 
      <span class="badge badge-primary">{{ usuario_logado.setor.nome if usuario_logado.setor else 'N√£o definido' }}</span>
    </div>
    {% endif %}
  </div>

  <!-- Resumo -->
  <div class="content-card">
    <div class="card-header">
      <h3><i class="fas fa-chart-bar"></i> Resumo do Sistema</h3>
    </div>
    <div class="dashboard-grid" style="grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));">
      <div class="metric-card">
        <div class="metric-icon contas"><i class="fas fa-building"></i></div>
        <div class="metric-content">
          <h3>Empresas Ativas</h3>
          <div class="metric-value">{{ total_empresas }}</div>
          <div class="metric-change neutral"><i class="fas fa-globe"></i> Total</div>
        </div>
      </div>
      <div class="metric-card">
        <div class="metric-icon pendentes"><i class="fas fa-clipboard-list"></i></div>
        <div class="metric-content">
          <h3>Tarefas Globais</h3>
          <div class="metric-value">{{ total_tarefas }}</div>
          <div class="metric-change warning"><i class="fas fa-tasks"></i> Modelos</div>
        </div>
      </div>
      <div class="metric-card">
        <div class="metric-icon concluidas"><i class="fas fa-link"></i></div>
        <div class="metric-content">
          <h3>Vincula√ß√µes Ativas</h3>
          <div class="metric-value">{{ total_vinculacoes }}</div>
          <div class="metric-change success"><i class="fas fa-check"></i> Ativas</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Abas de Navega√ß√£o -->
  <div class="content-card">
    <div class="card-header">
      <h3><i class="fas fa-cogs"></i> Gerenciamento</h3>
      <div class="card-actions">
        <button type="button" id="btnAbaEmpresas" class="btn btn-primary" style="pointer-events: auto !important; z-index: 99999 !important; cursor: pointer !important; position: relative !important;">
          <i class="fas fa-building"></i> Empresas
        </button>
        <button type="button" id="btnAbaTarefas" class="btn btn-success" style="pointer-events: auto !important; z-index: 99999 !important; cursor: pointer !important; position: relative !important;">
          <i class="fas fa-tasks"></i> Tarefas
        </button>
        <button type="button" id="btnAbaResponsaveis" class="btn btn-info" style="pointer-events: auto !important; z-index: 99999 !important; cursor: pointer !important; position: relative !important;">
          <i class="fas fa-users"></i> Respons√°veis
        </button>
      </div>
    </div>

    <!-- Aba Empresas -->
    <div id="tab-empresas" class="tab-content active">
      <div class="row">
        <div class="col-md-6">
          <h4><i class="fas fa-list"></i> Lista de Empresas</h4>
          <div class="table-responsive">
            <table class="table table-striped">
              <thead>
                <tr>
                  <th>Empresa</th>
                  <th>Tributa√ß√£o</th>
                  <th>Tarefas</th>
                  <th>A√ß√µes</th>
                </tr>
              </thead>
              <tbody id="empresas-list">
                {% for empresa in empresas %}
                <tr data-empresa-id="{{ empresa.id }}">
                  <td>
                    <strong>{{ empresa.nome }}</strong><br>
                    <small class="text-muted">{{ empresa.codigo }}</small>
                  </td>
                  <td>
                    <span class="badge badge-{{ 'success' if empresa.tributacao.nome == 'Simples Nacional' else 'primary' }}">
                      {{ empresa.tributacao.nome }}
                    </span>
                  </td>
                  <td>
                    <span class="badge badge-info" id="tarefas-count-{{ empresa.id }}">Carregando...</span>
                  </td>
                  <td>
                    <button class="btn btn-sm btn-primary" onclick="verEmpresa({{ empresa.id }})">
                      <i class="fas fa-eye"></i> Ver
                    </button>
                    <button class="btn btn-sm btn-warning" onclick="alterarTributacao({{ empresa.id }})">
                      <i class="fas fa-exchange-alt"></i> Alterar
                    </button>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
        <div class="col-md-6">
          <div id="empresa-detalhes" class="hidden">
            <h4><i class="fas fa-info-circle"></i> Detalhes da Empresa</h4>
            <div id="empresa-info"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Aba Tarefas -->
    <div id="tab-tarefas" class="tab-content hidden">
      <div class="content-card">
        <div class="card-header">
          <h3><i class="fas fa-tasks"></i> Tarefas do Setor</h3>
          <div class="header-actions">
            <button class="btn btn-success" id="btnNovaTarefa">
              <i class="fas fa-plus"></i> Nova Tarefa
            </button>
          </div>
        </div>
        
        <div class="card-body">
          <!-- Estat√≠sticas -->
          <div class="row mb-4">
            <div class="col-md-4">
              <div class="metric-card">
                <div class="metric-icon"><i class="fas fa-tasks"></i></div>
                <div class="metric-content">
                  <h3 id="total-tarefas-setor">0</h3>
                  <p>Tarefas do Setor</p>
                </div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="metric-card">
                <div class="metric-icon"><i class="fas fa-link"></i></div>
                <div class="metric-content">
                  <h3 id="total-vinculacoes">0</h3>
                  <p>Vincula√ß√µes Ativas</p>
                </div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="metric-card">
                <div class="metric-icon"><i class="fas fa-users"></i></div>
                <div class="metric-content">
                  <h3 id="total-responsaveis">0</h3>
                  <p>Respons√°veis</p>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Lista de tarefas -->
          <div class="table-responsive">
            <table class="table table-striped">
              <thead>
                <tr>
                  <th>Nome</th>
                  <th>Tipo</th>
                  <th>Setor</th>
                  <th>Tarefa Comum</th>
                  <th>A√ß√µes</th>
                </tr>
              </thead>
              <tbody id="tarefas-tbody">
                <!-- Tarefas ser√£o carregadas via JavaScript -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Aba Respons√°veis -->
    <div id="tab-responsaveis" class="tab-content hidden">
      <div class="content-card">
        <div class="card-header">
          <h3><i class="fas fa-users"></i> Respons√°veis</h3>
          <div class="header-actions">
            <button class="btn btn-primary" onclick="testarAberturaModal()">
              <i class="fas fa-link"></i> Vincular Respons√°vel
            </button>
          </div>
        </div>
        
        <div class="card-body">
          <!-- Busca de respons√°veis -->
          <div class="row mb-3">
            <div class="col-md-6">
              <label for="busca-responsaveis">Buscar Respons√°veis:</label>
              <div class="search-container">
                <input type="text" id="busca-responsaveis" class="form-control" placeholder="Digite o nome do respons√°vel...">
                <div id="resultados-busca-responsaveis" class="search-results"></div>
              </div>
            </div>
            <div class="col-md-3">
              <label for="filtro-setor-responsaveis">Filtrar por Setor:</label>
              <select id="filtro-setor-responsaveis" class="form-control" onchange="filtrarResponsaveis()">
                <option value="">Todos os Setores</option>
                {% for setor in setores %}
                <option value="{{ setor.id }}">{{ setor.nome }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-3">
              <label for="filtro-tributacao-responsaveis">Filtrar por Tributa√ß√£o:</label>
              <select id="filtro-tributacao-responsaveis" class="form-control" onchange="filtrarResponsaveis()">
                <option value="">Todas as Tributa√ß√µes</option>
                {% for tributacao in tributacoes %}
                <option value="{{ tributacao.id }}">{{ tributacao.nome }}</option>
                {% endfor %}
              </select>
            </div>
          </div>
          
          <!-- Lista de respons√°veis -->
          <div class="table-responsive">
            <table class="table table-striped">
              <thead>
                <tr>
                  <th>Respons√°vel</th>
                  <th>Setor</th>
                  <th>Tributa√ß√£o</th>
                  <th>Tarefas Vinculadas</th>
                  <th>Status</th>
                  <th>A√ß√µes</th>
                </tr>
              </thead>
              <tbody id="responsaveis-tbody">
                <!-- Ser√° preenchido via JavaScript -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Modal para Alterar Tributa√ß√£o -->
<div class="modal fade" id="modalAlterarTributacao" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content modal-standard">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="fas fa-exchange-alt"></i> Alterar Tributa√ß√£o
        </h5>
        <button type="button" class="close" onclick="fecharModalAlterarTributacao()">
          <span>&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div id="alterar-tributacao-content">
          <!-- Ser√° preenchido via JavaScript -->
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="fecharModalAlterarTributacao()">Cancelar</button>
        <button type="button" class="btn btn-primary" id="confirmar-alteracao">
          <i class="fas fa-check"></i> Confirmar Altera√ß√£o
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal para Ver Empresa -->
<div class="modal fade" id="modalVerEmpresa" tabindex="-1">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="fas fa-building"></i> Detalhes da Empresa
        </h5>
        <button type="button" class="close" onclick="fecharModalVerEmpresa()">
          <span>&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div id="empresa-detalhes-content">
          <!-- Ser√° preenchido via JavaScript -->
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="fecharModalVerEmpresa()">Fechar</button>
      </div>
    </div>
  </div>
</div>

<script>
// Vari√°veis globais
let empresaSelecionada = null;
let novaTributacaoId = null;

// Inicializa√ß√£o
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Inicializando sistema melhorado de tarefas...');
    
    // Debug: Verificar se elementos existem
    const modal = document.getElementById('modalVincularResponsavel');
    const empresaInput = document.getElementById('empresa-search-vincular');
    const resultsDiv = document.getElementById('empresa-results-vincular');
    
    console.log('üîç DEBUG - Elementos encontrados:');
    console.log('üì± Modal:', modal ? 'SIM' : 'N√ÉO');
    console.log('üîç Input empresa:', empresaInput ? 'SIM' : 'N√ÉO');
    console.log('üìä Results div:', resultsDiv ? 'SIM' : 'N√ÉO');
    
    if (modal) {
        console.log('üì± Modal classes:', modal.className);
        console.log('üì± Modal style:', modal.style.cssText);
    }
    
    // Configurar bot√µes das abas com IDs espec√≠ficos
    const btnAbaEmpresas = document.getElementById('btnAbaEmpresas');
    const btnAbaTarefas = document.getElementById('btnAbaTarefas');
    const btnAbaResponsaveis = document.getElementById('btnAbaResponsaveis');
    
    console.log('üîç DEBUG - Bot√µes das abas:');
    console.log('üì± Bot√£o Empresas:', btnAbaEmpresas ? 'SIM' : 'N√ÉO');
    console.log('üì± Bot√£o Tarefas:', btnAbaTarefas ? 'SIM' : 'N√ÉO');
    console.log('üì± Bot√£o Respons√°veis:', btnAbaResponsaveis ? 'SIM' : 'N√ÉO');
    
    if (btnAbaEmpresas) {
        btnAbaEmpresas.addEventListener('click', function(e) {
            console.log('üñ±Ô∏è CLIQUE DETECTADO: Empresas');
            e.preventDefault();
            e.stopPropagation();
            showTab('empresas');
        });
        console.log('‚úÖ Event listener configurado: Empresas');
    }
    
    if (btnAbaTarefas) {
        btnAbaTarefas.addEventListener('click', function(e) {
            console.log('üñ±Ô∏è CLIQUE DETECTADO: Tarefas');
            e.preventDefault();
            e.stopPropagation();
            showTab('tarefas');
        });
        console.log('‚úÖ Event listener configurado: Tarefas');
    }
    
    if (btnAbaResponsaveis) {
        btnAbaResponsaveis.addEventListener('click', function(e) {
            console.log('üñ±Ô∏è CLIQUE DETECTADO: Respons√°veis');
            e.preventDefault();
            e.stopPropagation();
            showTab('responsaveis');
        });
        console.log('‚úÖ Event listener configurado: Respons√°veis');
    }
    
    console.log('‚úÖ Todos os event listeners configurados');
    
    // Configurar bot√£o "Nova Tarefa"
    const btnNovaTarefa = document.getElementById('btnNovaTarefa');
    if (btnNovaTarefa) {
        btnNovaTarefa.addEventListener('click', function(e) {
            console.log('üñ±Ô∏è CLIQUE: Nova Tarefa');
            e.preventDefault();
            e.stopPropagation();
            mostrarModalCriarTarefa();
        });
        console.log('‚úÖ Bot√£o Nova Tarefa configurado');
    }
    
    // Carregar dados iniciais
    carregarEmpresas();
    carregarTarefas();
    carregarResponsaveis();
    carregarUsuarios();
    
    // Configurar formul√°rio de respons√°vel (se existir)
    const responsavelForm = document.getElementById('responsavel-form');
    if (responsavelForm) {
        responsavelForm.addEventListener('submit', salvarResponsavelPadrao);
    }
    
    // Configurar sistema de busca
    configurarBuscaTarefas();
    
    // Configurar fechamento de modais
    configurarFechamentoModais();
    
    // For√ßar clicabilidade dos bot√µes
    forcarClicabilidadeBotoes();
    
    // Configurar comportamento do checkbox "Tarefa Comum"
    configurarCheckboxTarefaComum();
    
    console.log('‚úÖ Sistema melhorado de tarefas inicializado!');
});

// For√ßar clicabilidade dos bot√µes
function forcarClicabilidadeBotoes() {
    // For√ßar clicabilidade em todos os bot√µes
    const botoes = document.querySelectorAll('button, .btn, input[type="button"], input[type="submit"]');
    botoes.forEach(botao => {
        botao.style.pointerEvents = 'auto';
        botao.style.cursor = 'pointer';
        botao.style.zIndex = '9999';
        botao.style.position = 'relative';
        
        // Remover data-dismiss se existir
        if (botao.hasAttribute('data-dismiss')) {
            botao.removeAttribute('data-dismiss');
        }
    });
    
    console.log(`‚úÖ For√ßada clicabilidade em ${botoes.length} bot√µes`);
}

// Configurar comportamento do checkbox "Tarefa Comum"
function configurarCheckboxTarefaComum() {
    const checkbox = document.getElementById('tarefa-comum');
    const selectTributacao = document.getElementById('tarefa-tributacao');
    
    if (checkbox && selectTributacao) {
        checkbox.addEventListener('change', function() {
            if (this.checked) {
                // Se tarefa comum est√° marcada, desabilitar e limpar tributa√ß√£o
                selectTributacao.disabled = true;
                selectTributacao.value = '';
                selectTributacao.style.opacity = '0.5';
                console.log('‚úÖ Tarefa Comum selecionada - Tributa√ß√£o desabilitada');
            } else {
                // Se tarefa comum n√£o est√° marcada, habilitar tributa√ß√£o
                selectTributacao.disabled = false;
                selectTributacao.style.opacity = '1';
                console.log('‚úÖ Tarefa espec√≠fica selecionada - Tributa√ß√£o habilitada');
            }
        });
        
        // Configurar estado inicial
        if (checkbox.checked) {
            selectTributacao.disabled = true;
            selectTributacao.value = '';
            selectTributacao.style.opacity = '0.5';
        }
    }
}

// Configurar fechamento de modais
function configurarFechamentoModais() {
    // Fechar modais ao clicar no backdrop
    document.addEventListener('click', function(event) {
        if (event.target.classList.contains('modal-backdrop')) {
            // Fechar todos os modais abertos
            fecharModalCriarTarefa();
            fecharModalVincularResponsavel();
            fecharModalAlterarTributacao();
            fecharModalVerEmpresa();
        }
    });
    
    // Fechar modais ao pressionar ESC
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            fecharModalCriarTarefa();
            fecharModalVincularResponsavel();
            fecharModalAlterarTributacao();
            fecharModalVerEmpresa();
        }
    });
}

// Fun√ß√µes de navega√ß√£o
function showTab(tabName) {
    console.log(`üîÑ MUDANDO PARA ABA: ${tabName}`);
    
    // Verificar se a aba existe
    const targetTab = document.getElementById(`tab-${tabName}`);
    console.log(`üì± Aba alvo encontrada:`, targetTab ? 'SIM' : 'N√ÉO');
    
    if (!targetTab) {
        console.error(`‚ùå Aba '${tabName}' n√£o encontrada!`);
        return;
    }
    
    // PRIMEIRO: Remover active de TODAS as abas
    const allTabs = document.querySelectorAll('#tab-empresas, #tab-tarefas, #tab-responsaveis');
    console.log(`üì± Total de abas: ${allTabs.length}`);
    
    allTabs.forEach((tab, index) => {
        const tabId = tab.id;
        const wasActive = tab.classList.contains('active');
        
        // Remover active
        tab.classList.remove('active');
        
        // Adicionar hidden
        if (!tab.classList.contains('hidden')) {
            tab.classList.add('hidden');
        }
        
        // FOR√áAR display none via JavaScript
        tab.style.display = 'none';
        
        console.log(`üì± Aba ${index} (${tabId}): Era ativa=${wasActive}, Agora ativa=${tab.classList.contains('active')}, Hidden=${tab.classList.contains('hidden')}, Display=${tab.style.display}`);
    });
    
    // SEGUNDO: Ativar apenas a aba selecionada
    console.log(`üì± Ativando aba: tab-${tabName}`);
    targetTab.classList.remove('hidden');
    targetTab.classList.add('active');
    
    // For√ßar display via JavaScript tamb√©m
    targetTab.style.display = 'block';
    
    console.log(`üì± Aba alvo final:`);
    console.log(`   - Hidden: ${targetTab.classList.contains('hidden')}`);
    console.log(`   - Active: ${targetTab.classList.contains('active')}`);
    console.log(`   - Style display: ${targetTab.style.display}`);
    console.log(`   - Computed display: ${window.getComputedStyle(targetTab).display}`);
    console.log(`‚úÖ Mudan√ßa conclu√≠da`);
    
    // Verificar outras abas
    allTabs.forEach((tab, index) => {
        if (tab.id !== `tab-${tabName}`) {
            const display = window.getComputedStyle(tab).display;
            console.log(`üì± Aba ${index} (${tab.id}) display: ${display}`);
            if (display !== 'none') {
                console.warn(`‚ö†Ô∏è ATEN√á√ÉO: Aba ${tab.id} ainda est√° vis√≠vel!`);
            }
        }
    });
}

// Fun√ß√µes de empresas
async function carregarEmpresas() {
    try {
        console.log('üìä Carregando dados das empresas...');
        
        for (const row of document.querySelectorAll('#empresas-list tr[data-empresa-id]')) {
            const empresaId = row.dataset.empresaId;
            
            const response = await fetch(`/tarefas-melhoradas/api/empresa/${empresaId}`);
            const data = await response.json();
            
            if (data.success) {
                const countBadge = document.getElementById(`tarefas-count-${empresaId}`);
                if (countBadge) {
                    countBadge.textContent = `${data.empresa.tarefas_ativas} tarefas`;
                }
            }
        }
        
        console.log('‚úÖ Dados das empresas carregados!');
    } catch (error) {
        console.error('‚ùå Erro ao carregar empresas:', error);
    }
}

async function verEmpresa(empresaId) {
    try {
        console.log(`üëÅÔ∏è Visualizando empresa ${empresaId}...`);
        
        const response = await fetch(`/tarefas-melhoradas/api/empresa/${empresaId}/tarefas`);
        const data = await response.json();
        
        if (data.success) {
            empresaSelecionada = empresaId;
            mostrarDetalhesEmpresa(data.tarefas);
            mostrarModalVerEmpresa();
        } else {
            showAlertModal(data.message, 'error', 'Erro');
        }
    } catch (error) {
        console.error('‚ùå Erro ao carregar empresa:', error);
        showAlertModal('Erro', 'Erro ao carregar dados da empresa', 'error');
    }
}

function mostrarDetalhesEmpresa(tarefas) {
    const content = document.getElementById('empresa-detalhes-content');
    
    let html = `
        <div class="row">
            <div class="col-md-6">
                <h5><i class="fas fa-tasks"></i> Tarefas Ativas (${tarefas.ativas.length})</h5>
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Tarefa</th>
                                <th>Tipo</th>
                                <th>Respons√°vel</th>
                            </tr>
                        </thead>
                        <tbody>
    `;
    
    tarefas.ativas.forEach(tarefa => {
        html += `
            <tr>
                <td>${tarefa.nome}</td>
                <td><span class="badge badge-info">${tarefa.tipo}</span></td>
                <td>${tarefa.responsavel.nome}</td>
            </tr>
        `;
    });
    
    html += `
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="col-md-6">
                <h5><i class="fas fa-history"></i> Tarefas Hist√≥ricas (${tarefas.historicas.length})</h5>
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Tarefa</th>
                                <th>Tipo</th>
                                <th>Respons√°vel</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
    `;
    
    tarefas.historicas.forEach(tarefa => {
        html += `
            <tr>
                <td>${tarefa.nome}</td>
                <td><span class="badge badge-info">${tarefa.tipo}</span></td>
                <td>${tarefa.responsavel.nome}</td>
                <td><span class="badge badge-secondary">Hist√≥rico</span></td>
            </tr>
        `;
    });
    
    html += `
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    `;
    
    content.innerHTML = html;
}

async function alterarTributacao(empresaId) {
    try {
        console.log(`üîÑ Alterando tributa√ß√£o da empresa ${empresaId}...`);
        
        empresaSelecionada = empresaId;
        
        // Carregar dados da empresa
        const response = await fetch(`/tarefas-melhoradas/api/empresa/${empresaId}`);
        const data = await response.json();
        
        if (data.success) {
            mostrarWizardAlteracao(data.empresa);
            mostrarModalAlterarTributacao();
        } else {
            showAlertModal(data.message, 'error', 'Erro');
        }
    } catch (error) {
        console.error('‚ùå Erro ao alterar tributa√ß√£o:', error);
        showAlertModal('Erro', 'Erro ao carregar dados da empresa', 'error');
    }
}

function mostrarWizardAlteracao(empresa) {
    const content = document.getElementById('alterar-tributacao-content');
    
    let html = `
        <div class="wizard-step active" id="step-1">
            <h5><i class="fas fa-info-circle"></i> Passo 1: Informa√ß√µes da Empresa</h5>
            <div class="alert alert-info">
                <strong>Empresa:</strong> ${empresa.nome}<br>
                <strong>Tributa√ß√£o Atual:</strong> ${empresa.tributacao_atual ? empresa.tributacao_atual.nome : 'N√£o definida'}<br>
                <strong>Tarefas Ativas:</strong> ${empresa.tarefas_ativas}
            </div>
        </div>
        
        <div class="wizard-step hidden" id="step-2">
            <h5><i class="fas fa-exchange-alt"></i> Passo 2: Nova Tributa√ß√£o</h5>
            <div class="form-group">
                <label>Selecione a nova tributa√ß√£o:</label>
                <select class="form-control" id="nova-tributacao" onchange="carregarTarefasNovaTributacao()">
                    <option value="">Selecione uma tributa√ß√£o</option>
                    {% for tributacao in tributacoes %}
                    <option value="{{ tributacao.id }}">{{ tributacao.nome }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
        
        <div class="wizard-step hidden" id="step-3">
            <h5><i class="fas fa-tasks"></i> Passo 3: Configurar Respons√°veis</h5>
            <div id="tarefas-nova-tributacao">
                <!-- Ser√° preenchido via JavaScript -->
            </div>
        </div>
        
        <div class="wizard-step hidden" id="step-4">
            <h5><i class="fas fa-check"></i> Passo 4: Confirma√ß√£o</h5>
            <div id="resumo-alteracao">
                <!-- Ser√° preenchido via JavaScript -->
            </div>
        </div>
        
        <div class="wizard-navigation mt-3">
            <button type="button" class="btn btn-secondary" onclick="anteriorPasso()" id="btn-anterior" disabled>
                <i class="fas fa-arrow-left"></i> Anterior
            </button>
            <button type="button" class="btn btn-primary" onclick="proximoPasso()" id="btn-proximo">
                Pr√≥ximo <i class="fas fa-arrow-right"></i>
            </button>
        </div>
    `;
    
    content.innerHTML = html;
}

let passoAtual = 1;
const totalPassos = 4;

function proximoPasso() {
    if (passoAtual < totalPassos) {
        // Validar passo atual
        if (validarPasso(passoAtual)) {
            document.getElementById(`step-${passoAtual}`).classList.add('hidden');
            passoAtual++;
            document.getElementById(`step-${passoAtual}`).classList.remove('hidden');
            
            // Atualizar bot√µes
            document.getElementById('btn-anterior').disabled = false;
            if (passoAtual === totalPassos) {
                document.getElementById('btn-proximo').style.display = 'none';
                document.getElementById('confirmar-alteracao').style.display = 'inline-block';
            }
        }
    }
}

function anteriorPasso() {
    if (passoAtual > 1) {
        document.getElementById(`step-${passoAtual}`).classList.add('hidden');
        passoAtual--;
        document.getElementById(`step-${passoAtual}`).classList.remove('hidden');
        
        // Atualizar bot√µes
        if (passoAtual === 1) {
            document.getElementById('btn-anterior').disabled = true;
        }
        document.getElementById('btn-proximo').style.display = 'inline-block';
        document.getElementById('confirmar-alteracao').style.display = 'none';
    }
}

function validarPasso(passo) {
    switch (passo) {
        case 2:
            const novaTributacao = document.getElementById('nova-tributacao').value;
            if (!novaTributacao) {
                showAlertModal('Erro', 'Selecione uma tributa√ß√£o', 'error');
                return false;
            }
            novaTributacaoId = novaTributacao;
            return true;
        case 3:
            // Validar se pelo menos um respons√°vel foi selecionado
            return true;
        default:
            return true;
    }
}

async function carregarTarefasNovaTributacao() {
    try {
        const tributacaoId = document.getElementById('nova-tributacao').value;
        if (!tributacaoId) return;
        
        const response = await fetch(`/tarefas-melhoradas/api/tributacao/${tributacaoId}/tarefas`);
        const data = await response.json();
        
        if (data.success) {
            mostrarTarefasNovaTributacao(data.tarefas);
        }
    } catch (error) {
        console.error('‚ùå Erro ao carregar tarefas:', error);
    }
}

function mostrarTarefasNovaTributacao(tarefas) {
    const container = document.getElementById('tarefas-nova-tributacao');
    
    let html = `
        <div class="alert alert-info">
            <strong>${tarefas.length} tarefas</strong> ser√£o vinculadas √† empresa.
        </div>
        <div class="table-responsive">
            <table class="table table-sm">
                <thead>
                    <tr>
                        <th>Tarefa</th>
                        <th>Tipo</th>
                        <th>Respons√°vel</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    tarefas.forEach(tarefa => {
        html += `
            <tr>
                <td>${tarefa.nome}</td>
                <td><span class="badge badge-info">${tarefa.tipo}</span></td>
                <td>
                    <select class="form-control form-control-sm" data-tarefa-id="${tarefa.id}">
                        <option value="">Selecione um respons√°vel</option>
                        <!-- Ser√° preenchido com usu√°rios -->
                    </select>
                </td>
            </tr>
        `;
    });
    
    html += `
                </tbody>
            </table>
        </div>
    `;
    
    container.innerHTML = html;
    
    // Carregar usu√°rios nos selects
    carregarUsuariosNosSelects();
}

async function carregarUsuariosNosSelects() {
    try {
        const response = await fetch('/api/usuarios');
        const data = await response.json();
        
        if (data.success) {
            const selects = document.querySelectorAll('select[data-tarefa-id]');
            selects.forEach(select => {
                data.usuarios.forEach(usuario => {
                    const option = document.createElement('option');
                    option.value = usuario.id;
                    option.textContent = usuario.nome;
                    select.appendChild(option);
                });
            });
        }
    } catch (error) {
        console.error('‚ùå Erro ao carregar usu√°rios:', error);
    }
}

// ===== FUN√á√ïES DA ABA TAREFAS (NOVA VERS√ÉO LIMPA) =====

// Carregar tarefas do setor
async function carregarTarefas() {
    try {
        console.log('üìã Carregando tarefas do setor...');
        
        const response = await fetch('/tarefas-melhoradas/api/tarefas', {
            credentials: 'same-origin',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            }
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        console.log('üìä Tarefas recebidas:', data);
        
        if (data.success && data.tarefas) {
            mostrarTarefas(data.tarefas);
            atualizarEstatisticasTarefas(data.tarefas.length);
        } else {
            mostrarTarefas([]);
        }
        
        console.log('‚úÖ Tarefas carregadas com sucesso!');
    } catch (error) {
        console.error('‚ùå Erro ao carregar tarefas:', error);
        mostrarTarefas([]);
    }
}

function mostrarTarefas(tarefas) {
    console.log('üìã Mostrando', tarefas.length, 'tarefas');
    
    const tbody = document.getElementById('tarefas-tbody');
    if (!tbody) {
        console.error('‚ùå Tbody n√£o encontrado!');
        return;
    }
    
    if (tarefas.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center">Nenhuma tarefa encontrada</td></tr>';
        return;
    }
    
    const html = tarefas.map(tarefa => `
        <tr>
            <td>${tarefa.nome}</td>
            <td><span class="badge badge-info">${tarefa.tipo}</span></td>
            <td>${tarefa.setor || 'N/A'}</td>
            <td>
                ${tarefa.tarefa_comum ? 
                    '<span class="badge badge-success">Sim</span>' : 
                    '<span class="badge badge-secondary">N√£o</span>'
                }
            </td>
            <td>
                <button class="btn btn-sm btn-info" onclick="editarTarefa(${tarefa.id})">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="btn btn-sm btn-danger" onclick="confirmarExclusaoTarefa(${tarefa.id}, '${tarefa.nome}')">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        </tr>
    `).join('');
    
    tbody.innerHTML = html;
    console.log('‚úÖ Tarefas exibidas na tabela');
}

function atualizarEstatisticasTarefas(total) {
    const totalElement = document.getElementById('total-tarefas-setor');
    if (totalElement) {
        totalElement.textContent = total;
    }
}

function mostrarTarefasBackend() {
    const tbody = document.getElementById('tarefas-tbody');
    if (!tbody) return;
    
    let html = '';
    
    // Os dados ser√£o carregados via API
    // C√≥digo Jinja2 removido para evitar conflitos JavaScript
    
    if (html) {
        tbody.innerHTML = html;
    } else {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center">Nenhuma tarefa encontrada</td></tr>';
    }
}

async function filtrarTarefas() {
    const tributacaoId = document.getElementById('tributacao-filter').value;
    console.log(`üîç Filtrando tarefas por tributa√ß√£o: ${tributacaoId}`);
    
    try {
        if (tributacaoId) {
            // Carregar tarefas da tributa√ß√£o espec√≠fica
            const response = await fetch(`/tarefas-melhoradas/api/tributacao/${tributacaoId}/tarefas`);
            const data = await response.json();
            
            if (data.success) {
                mostrarTarefasFiltradas(data.tarefas);
            } else {
                console.error('Erro ao filtrar tarefas:', data.message);
            }
        } else {
            // Mostrar todas as tarefas (recarregar)
            carregarTarefas();
        }
    } catch (error) {
        console.error('‚ùå Erro ao filtrar tarefas:', error);
    }
}

function mostrarTarefasFiltradas(tarefas) {
    const tbody = document.getElementById('tarefas-tbody');
    if (!tbody) return;
    
    let html = '';
    tarefas.forEach(tarefa => {
        html += `
            <tr>
                <td>${tarefa.nome}</td>
                <td><span class="badge badge-info">${tarefa.tipo}</span></td>
                <td>N/A</td>
                <td>
                    ${tarefa.tarefa_comum ? 
                        '<span class="badge badge-success">Sim</span>' : 
                        '<span class="badge badge-secondary">N√£o</span>'
                    }
                </td>
                <td>
                    ${tarefa.obrigatoria ? 
                        '<span class="badge badge-primary">Obrigat√≥ria</span>' : 
                        '<span class="badge badge-warning">Opcional</span>'
                    }
                </td>
            </tr>
        `;
    });
    
    if (html) {
        tbody.innerHTML = html;
    } else {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center">Nenhuma tarefa encontrada para esta tributa√ß√£o</td></tr>';
    }
}

// Fun√ß√µes de busca
function configurarBuscaTarefas() {
    const input = document.getElementById('busca-tarefas');
    const resultados = document.getElementById('resultados-busca-tarefas');
    
    if (!input || !resultados) return;
    
    let timeoutId;
    
    input.addEventListener('input', function() {
        clearTimeout(timeoutId);
        const query = this.value.trim();
        
        if (query.length < 2) {
            resultados.style.display = 'none';
            return;
        }
        
        timeoutId = setTimeout(() => {
            buscarTarefas(query);
        }, 300);
    });
    
    // Esconder resultados ao clicar fora
    document.addEventListener('click', function(e) {
        if (!input.contains(e.target) && !resultados.contains(e.target)) {
            resultados.style.display = 'none';
        }
    });
}

async function buscarTarefas(query) {
    console.log('üîç Buscando tarefas com query:', query);
    
    if (query.length < 2) {
        const resultados = document.getElementById('resultados-busca-tarefas');
        if (resultados) {
            resultados.style.display = 'none';
            resultados.classList.remove('show');
        }
        return;
    }
    
    try {
        console.log('üåê Fazendo requisi√ß√£o para:', `/tarefas-melhoradas/api/tarefas/buscar?q=${encodeURIComponent(query)}`);
        const response = await fetch(`/tarefas-melhoradas/api/tarefas/buscar?q=${encodeURIComponent(query)}`, {
            credentials: 'same-origin',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            }
        });
        console.log('üì° Response status:', response.status);
        console.log('üì° Response ok:', response.ok);
        console.log('üì° Response headers:', response.headers);
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        console.log('üìä Dados recebidos:', data);
        console.log('üìä Tipo dos dados:', typeof data);
        console.log('üìä Success:', data.success);
        console.log('üìä Tarefas:', data.tarefas);
        
        if (data.success) {
            console.log('‚úÖ Busca bem-sucedida, tarefas encontradas:', data.tarefas ? data.tarefas.length : 0);
            if (data.tarefas && data.tarefas.length > 0) {
                console.log('üìã Tarefas encontradas:', data.tarefas);
                mostrarResultadosBusca(data.tarefas, 'resultados-busca-tarefas');
            } else {
                console.log('‚ö†Ô∏è Nenhuma tarefa encontrada');
                mostrarResultadosBusca([], 'resultados-busca-tarefas');
            }
        } else {
            console.error('‚ùå Erro na busca:', data.message);
            mostrarResultadosBusca([], 'resultados-busca-tarefas');
        }
    } catch (error) {
        console.error('‚ùå Erro na busca:', error);
        mostrarResultadosBusca([], 'resultados-busca-tarefas');
    }
}

function mostrarResultadosBusca(items, containerId) {
    console.log('üéØ Mostrando resultados para container:', containerId, 'items:', items);
    console.log('üéØ Items type:', typeof items);
    console.log('üéØ Items length:', items ? items.length : 'undefined');
    
    const container = document.getElementById(containerId);
    if (!container) {
        console.error('‚ùå Container n√£o encontrado:', containerId);
        console.error('‚ùå Tentando encontrar elementos com ID similar...');
        const allElements = document.querySelectorAll('[id*="resultados"]');
        console.log('‚ùå Elementos encontrados:', allElements);
        return;
    }
    
    console.log('‚úÖ Container encontrado:', container);
    console.log('‚úÖ Container classes:', container.className);
    
    let html = '';
    if (items && items.length > 0) {
        console.log('üìã Gerando HTML para', items.length, 'itens');
        items.forEach((item, index) => {
            console.log(`üìã Item ${index}:`, item);
            html += `<div class="search-item-standard" onclick="selecionarItem('${item.nome}', ${item.id})">${item.nome}</div>`;
        });
    } else {
        console.log('‚ö†Ô∏è Nenhum item encontrado, mostrando mensagem padr√£o');
        html = '<div class="search-item-standard">Nenhuma tarefa encontrada</div>';
    }
    
    console.log('üìù HTML gerado:', html);
    container.innerHTML = html;
    container.style.display = 'block';
    container.classList.add('show');
    
    console.log('‚úÖ Resultados exibidos no container:', containerId);
    console.log('‚úÖ Container display:', container.style.display);
    console.log('‚úÖ Container classes:', container.className);
    console.log('‚úÖ Container visibility:', window.getComputedStyle(container).visibility);
    console.log('‚úÖ Container z-index:', window.getComputedStyle(container).zIndex);
}

function selecionarItem(nome, id) {
    console.log('üéØ Item selecionado:', nome, id);
    
    // Preencher o campo de busca com o nome selecionado
    const input = document.getElementById('busca-tarefas');
    if (input) {
        input.value = nome;
    }
    
    // Esconder resultados
    const resultados = document.getElementById('resultados-busca-tarefas');
    if (resultados) {
        resultados.style.display = 'none';
    }
    
    // Filtrar a lista de tarefas para mostrar apenas a selecionada
    filtrarTarefasPorNome(nome);
}

function filtrarTarefasPorNome(nome) {
    console.log('üîç Filtrando tarefas por nome:', nome);
    
    const tbody = document.querySelector('#lista-tarefas tbody');
    if (!tbody) return;
    
    const linhas = tbody.querySelectorAll('tr');
    let visiveis = 0;
    
    linhas.forEach(linha => {
        const nomeTarefa = linha.querySelector('td:first-child')?.textContent?.toLowerCase() || '';
        const nomeBusca = nome.toLowerCase();
        
        if (nomeTarefa.includes(nomeBusca)) {
            linha.style.display = '';
            visiveis++;
        } else {
            linha.style.display = 'none';
        }
    });
    
    console.log(`‚úÖ Mostrando ${visiveis} tarefas de ${linhas.length}`);
}

// Fun√ß√µes de cria√ß√£o de tarefas
function mostrarModalCriarTarefa() {
    const modal = document.getElementById('modalCriarTarefa');
    if (modal) {
        modal.style.display = 'flex';
        modal.classList.add('show');
        modal.setAttribute('aria-hidden', 'false');
        // Adicionar backdrop
        const backdrop = document.createElement('div');
        backdrop.className = 'modal-backdrop fade show';
        backdrop.id = 'modalCriarTarefa-backdrop';
        document.body.appendChild(backdrop);
    }
}

function fecharModalCriarTarefa() {
    const modal = document.getElementById('modalCriarTarefa');
    if (modal) {
        modal.style.display = 'none';
        modal.classList.remove('show');
        modal.setAttribute('aria-hidden', 'true');
        // Remover backdrop
        const backdrop = document.getElementById('modalCriarTarefa-backdrop');
        if (backdrop) {
            backdrop.remove();
        }
    }
}

async function criarTarefa() {
    const nome = document.getElementById('tarefa-nome').value;
    const tipo = document.getElementById('tarefa-tipo').value;
    const setor = document.getElementById('tarefa-setor').value;
    const tributacao = document.getElementById('tarefa-tributacao').value;
    const descricao = document.getElementById('tarefa-descricao').value;
    const comum = document.getElementById('tarefa-comum').checked;
    
    console.log('üìù Dados do formul√°rio:', {
        nome, tipo, setor, tributacao, descricao, comum
    });
    
    // Valida√ß√£o b√°sica
    if (!nome || !tipo || !setor) {
        console.log('‚ùå Campos b√°sicos obrigat√≥rios faltando:', {
            nome: !!nome, tipo: !!tipo, setor: !!setor
        });
        showAlertModal('Preencha nome, tipo e setor', 'error', 'Erro');
        return;
    }
    
    // Se n√£o for tarefa comum, tributa√ß√£o √© obrigat√≥ria
    if (!comum && !tributacao) {
        console.log('‚ùå Tributa√ß√£o obrigat√≥ria para tarefas espec√≠ficas:', {
            comum: comum, tributacao: !!tributacao
        });
        showAlertModal('Selecione uma tributa√ß√£o ou marque como Tarefa Comum', 'error', 'Erro');
        return;
    }
    
    try {
        const dadosParaEnviar = {
            nome: nome,
            tipo: tipo,
            setor_id: setor,
            tributacao_id: tributacao,
            descricao: descricao,
            tarefa_comum: comum
        };
        
        console.log('üì§ Enviando dados para API:', dadosParaEnviar);
        
        const response = await fetch('/tarefas-melhoradas/api/tarefas', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(dadosParaEnviar)
        });
        
        console.log('üì° Response status:', response.status);
        
        const data = await response.json();
        console.log('üìä Response data:', data);
        
        if (data.success) {
            showAlertModal('Tarefa criada com sucesso!', 'success', 'Sucesso');
            fecharModalCriarTarefa();
            carregarTarefas(); // Recarregar lista
            limparFormularioTarefa();
        } else {
            console.error('‚ùå Erro na cria√ß√£o da tarefa:', data.message);
            showAlertModal(`Erro ao criar tarefa: ${data.message || 'Erro desconhecido'}`, 'error', 'Erro');
        }
    } catch (error) {
        console.error('‚ùå Erro na requisi√ß√£o:', error);
        showAlertModal(`Erro de conex√£o: ${error.message || 'Erro desconhecido'}`, 'error', 'Erro');
    }
}

function limparFormularioTarefa() {
    document.getElementById('form-criar-tarefa').reset();
    
    // Reconfigurar o estado do checkbox "Tarefa Comum"
    const checkbox = document.getElementById('tarefa-comum');
    const selectTributacao = document.getElementById('tarefa-tributacao');
    
    if (checkbox && selectTributacao) {
        if (checkbox.checked) {
            selectTributacao.disabled = true;
            selectTributacao.style.opacity = '0.5';
        } else {
            selectTributacao.disabled = false;
            selectTributacao.style.opacity = '1';
        }
    }
}

function editarTarefa(id) {
    console.log('Editar tarefa:', id);
    // Implementar edi√ß√£o
}

function excluirTarefa(id) {
    showConfirmModal(
        'Confirmar Exclus√£o',
        'Tem certeza que deseja excluir esta tarefa?',
        async () => {
            try {
                const response = await fetch(`/tarefas-melhoradas/api/tarefas/${id}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showAlertModal('Tarefa exclu√≠da com sucesso!', 'success', 'Sucesso');
                    carregarTarefas();
                } else {
                    showAlertModal(data.message, 'error', 'Erro');
                }
            } catch (error) {
                console.error('Erro ao excluir tarefa:', error);
                showAlertModal('Erro', 'Erro ao excluir tarefa', 'error');
            }
        }
    );
}

function limparFiltros() {
    document.getElementById('tributacao-filter').value = '';
    document.getElementById('setor-filter').value = '';
    document.getElementById('busca-tarefas').value = '';
    carregarTarefas();
}

// Fun√ß√µes de respons√°veis
async function carregarResponsaveis() {
    try {
        console.log('üë• Carregando respons√°veis...');
        
        const response = await fetch('/tarefas-melhoradas/api/responsaveis-padrao');
        const data = await response.json();
        
        if (data.success) {
            mostrarResponsaveis(data.responsaveis);
        }
    } catch (error) {
        console.error('‚ùå Erro ao carregar respons√°veis:', error);
    }
}

function mostrarResponsaveis(responsaveis) {
    const tbody = document.getElementById('responsaveis-tbody');
    
    let html = '';
    responsaveis.forEach(resp => {
        html += `
            <tr>
                <td>${resp.setor.nome}</td>
                <td>${resp.tributacao.nome}</td>
                <td>${resp.responsavel.nome}</td>
                <td>
                    <button class="btn btn-sm btn-danger" onclick="removerResponsavel(${resp.id})">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `;
    });
    
    tbody.innerHTML = html;
}

async function carregarUsuarios() {
    try {
        const response = await fetch('/api/usuarios');
        const data = await response.json();
        
        if (data.success) {
            const select = document.getElementById('responsavel-select');
            if (select) {
                data.usuarios.forEach(usuario => {
                    const option = document.createElement('option');
                    option.value = usuario.id;
                    option.textContent = usuario.nome;
                    select.appendChild(option);
                });
                console.log('‚úÖ Usu√°rios carregados no select');
            } else {
                console.log('‚ö†Ô∏è Select responsavel-select n√£o encontrado');
            }
        }
    } catch (error) {
        console.error('‚ùå Erro ao carregar usu√°rios:', error);
    }
}

async function salvarResponsavelPadrao(event) {
    event.preventDefault();
    
    try {
        const formData = {
            setor_id: document.getElementById('setor-select').value,
            tributacao_id: document.getElementById('tributacao-select').value,
            responsavel_id: document.getElementById('responsavel-select').value
        };
        
        const response = await fetch('/tarefas-melhoradas/api/responsaveis-padrao', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData)
        });
        
        const data = await response.json();
        
        if (data.success) {
            showAlertModal(data.message, 'success', 'Sucesso');
            document.getElementById('responsavel-form').reset();
            carregarResponsaveis();
        } else {
            showAlertModal(data.message, 'error', 'Erro');
        }
    } catch (error) {
        console.error('‚ùå Erro ao salvar respons√°vel:', error);
        showAlertModal('Erro', 'Erro ao salvar respons√°vel padr√£o', 'error');
    }
}

// Confirma√ß√£o de altera√ß√£o de tributa√ß√£o
document.getElementById('confirmar-alteracao').addEventListener('click', async function() {
    try {
        console.log('‚úÖ Confirmando altera√ß√£o de tributa√ß√£o...');
        
        // Coletar respons√°veis selecionados
        const responsaveis = {};
        const selects = document.querySelectorAll('select[data-tarefa-id]');
        selects.forEach(select => {
            if (select.value) {
                responsaveis[select.dataset.tarefaId] = select.value;
            }
        });
        
        const response = await fetch(`/tarefas-melhoradas/api/empresa/${empresaSelecionada}/alterar-tributacao`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                tributacao_id: novaTributacaoId,
                responsaveis: responsaveis,
                motivo: 'Mudan√ßa de tributa√ß√£o via sistema melhorado'
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showAlertModal(data.message, 'success', 'Sucesso');
            fecharModalAlterarTributacao();
            carregarEmpresas(); // Recarregar dados
        } else {
            showAlertModal(data.message, 'error', 'Erro');
        }
    } catch (error) {
        console.error('‚ùå Erro ao confirmar altera√ß√£o:', error);
        showAlertModal('Erro', 'Erro ao alterar tributa√ß√£o', 'error');
    }
});

// Fun√ß√£o de teste para abertura do modal
function testarAberturaModal() {
    console.log('üß™ TESTE - Tentando abrir modal...');
    
    // Verificar se elementos existem
    const modal = document.getElementById('modalVincularResponsavel');
    const empresaInput = document.getElementById('empresa-search-vincular');
    const resultsDiv = document.getElementById('empresa-results-vincular');
    
    console.log('üîç Elementos encontrados:');
    console.log('üì± Modal:', modal ? 'SIM' : 'N√ÉO');
    console.log('üîç Input empresa:', empresaInput ? 'SIM' : 'N√ÉO');
    console.log('üìä Results div:', resultsDiv ? 'SIM' : 'N√ÉO');
    
    if (!modal) {
        console.error('‚ùå Modal n√£o encontrado! Verificando DOM...');
        const allModals = document.querySelectorAll('.modal');
        console.log('üì± Todos os modais encontrados:', allModals.length);
        allModals.forEach((m, i) => {
            console.log(`üì± Modal ${i}:`, m.id, m.className);
        });
        return;
    }
    
    if (!empresaInput) {
        console.error('‚ùå Input empresa n√£o encontrado!');
        return;
    }
    
    if (!resultsDiv) {
        console.error('‚ùå Results div n√£o encontrado!');
        return;
    }
    
    console.log('‚úÖ Todos os elementos encontrados, abrindo modal...');
    
    // Teste direto de busca
    console.log('üß™ Testando busca direta...');
    const empresasTeste = [
        { id: 1, nome: 'Empresa Alfa', codigo: 'ALFA' },
        { id: 2, nome: 'AL Comercio Varejista', codigo: '667' }
    ];
    
    // Reutilizar resultsDiv j√° declarado
    if (resultsDiv) {
        resultsDiv.innerHTML = empresasTeste.map(empresa => `
            <div class="search-item-standard" onclick="selecionarEmpresaVinculacao(${empresa.id}, '${empresa.nome}')">
                <div class="search-item-primary-standard">${empresa.nome}</div>
                <div class="search-item-secondary-standard">${empresa.codigo || ''}</div>
            </div>
        `).join('');
        
        console.log('üéØ HTML criado:', resultsDiv.innerHTML);
        console.log('üéØ Exibindo results div...');
        resultsDiv.classList.add('show');
        resultsDiv.style.display = 'block';
        resultsDiv.style.visibility = 'visible';
        resultsDiv.style.opacity = '1';
        
        console.log('üìä Results display:', resultsDiv.style.display);
        console.log('üìä Results classes:', resultsDiv.className);
        console.log('üìä Results computed display:', window.getComputedStyle(resultsDiv).display);
        console.log('üìä Results computed visibility:', window.getComputedStyle(resultsDiv).visibility);
        console.log('üìä Results computed opacity:', window.getComputedStyle(resultsDiv).opacity);
        console.log('üìä Results computed z-index:', window.getComputedStyle(resultsDiv).zIndex);
    }
    
    mostrarModalVincularResponsavel();
}

// Fun√ß√µes de vincula√ß√£o de respons√°veis
function mostrarModalVincularResponsavel() {
    console.log('üöÄ Abrindo modal de vincula√ß√£o...');
    const modal = document.getElementById('modalVincularResponsavel');
    console.log('üì± Modal encontrado:', modal);
    
    if (modal) {
        // Remover backdrop existente
        const existingBackdrop = document.getElementById('modalVincularResponsavel-backdrop');
        if (existingBackdrop) {
            existingBackdrop.remove();
        }
        
        // Adicionar backdrop
        const backdrop = document.createElement('div');
        backdrop.className = 'modal-backdrop fade show';
        backdrop.id = 'modalVincularResponsavel-backdrop';
        backdrop.style.zIndex = '1040';
        document.body.appendChild(backdrop);
        
        // Mostrar modal
        modal.style.display = 'flex';
        modal.style.alignItems = 'center';
        modal.style.justifyContent = 'center';
        modal.style.zIndex = '1050';
        modal.classList.add('show');
        modal.setAttribute('aria-hidden', 'false');
        
        console.log('‚úÖ Modal aberto');
        
        // Configurar sistema de busca
        setTimeout(() => {
            configurarBuscaVinculacao();
            debugModalVinculacao();
        }, 100);
    } else {
        console.error('‚ùå Modal n√£o encontrado!');
    }
}

function fecharModalVincularResponsavel() {
    console.log('üö™ Fechando modal de vincula√ß√£o...');
    const modal = document.getElementById('modalVincularResponsavel');
    
    if (modal) {
        modal.style.display = 'none';
        modal.classList.remove('show');
        modal.setAttribute('aria-hidden', 'true');
        
        // Remover backdrop
        const backdrop = document.getElementById('modalVincularResponsavel-backdrop');
        if (backdrop) {
            backdrop.remove();
        }
        
        limparModalVinculacao();
        console.log('‚úÖ Modal fechado');
    }
}

// Fun√ß√£o de debug para o modal de vincula√ß√£o
function debugModalVinculacao() {
    console.log('üîç DEBUG - Modal de Vincula√ß√£o:');
    
    const modal = document.getElementById('modalVincularResponsavel');
    const empresaInput = document.getElementById('empresa-search-vincular');
    const resultsDiv = document.getElementById('empresa-results-vincular');
    
    console.log('üì± Modal:', modal);
    console.log('üì± Modal display:', modal ? modal.style.display : 'N/A');
    console.log('üì± Modal classes:', modal ? modal.className : 'N/A');
    
    console.log('üîç Input empresa:', empresaInput);
    console.log('üîç Input value:', empresaInput ? empresaInput.value : 'N/A');
    
    console.log('üìä Results div:', resultsDiv);
    console.log('üìä Results display:', resultsDiv ? resultsDiv.style.display : 'N/A');
    console.log('üìä Results classes:', resultsDiv ? resultsDiv.className : 'N/A');
    
    // Teste de busca autom√°tica
    if (empresaInput && resultsDiv) {
        console.log('üß™ Testando busca autom√°tica...');
        empresaInput.value = 'AL';
        empresaInput.dispatchEvent(new Event('input', { bubbles: true }));
    }
}

// Configurar sistema de busca para vincula√ß√£o
function configurarBuscaVinculacao() {
    console.log('üîß Configurando busca de vincula√ß√£o...');
    
    // Configurar busca de empresa
    const empresaInput = document.getElementById('empresa-search-vincular');
    console.log('üìù Input empresa encontrado:', empresaInput);
    
    if (empresaInput) {
        // Remover event listeners existentes
        empresaInput.removeEventListener('input', empresaInput._inputHandler);
        
        // Criar novo handler
        empresaInput._inputHandler = function() {
            const query = this.value.trim();
            console.log('üîç Buscando empresas com query:', query);
            if (query.length >= 2) {
                buscarEmpresasVinculacao(query);
            } else {
                const resultsDiv = document.getElementById('empresa-results-vincular');
                if (resultsDiv) {
                    resultsDiv.classList.remove('show');
                    resultsDiv.style.display = 'none';
                }
            }
        };
        
        empresaInput.addEventListener('input', empresaInput._inputHandler);
        console.log('‚úÖ Event listener configurado para empresa');
    } else {
        console.error('‚ùå Input empresa n√£o encontrado!');
    }

    // Configurar busca de tarefas
    const tarefaInput = document.getElementById('tarefa-search-vincular');
    if (tarefaInput) {
        tarefaInput.addEventListener('input', function() {
            const query = this.value.trim();
            const empresaId = document.getElementById('empresa_id_vincular').value;
            if (query.length >= 2 && empresaId) {
                buscarTarefasVinculacao(query, empresaId);
            } else {
                document.getElementById('tarefa-results-vincular').style.display = 'none';
            }
        });
    }

    // Configurar busca de respons√°vel
    const responsavelInput = document.getElementById('responsavel-search-vincular');
    if (responsavelInput) {
        responsavelInput.addEventListener('input', function() {
            const query = this.value.trim();
            if (query.length >= 2) {
                buscarResponsaveisVinculacao(query);
            } else {
                document.getElementById('responsavel-results-vincular').style.display = 'none';
            }
        });
    }
}

// Buscar empresas para vincula√ß√£o
function buscarEmpresasVinculacao(query) {
    console.log('üåê Fazendo requisi√ß√£o para empresas com query:', query);
    
    const url = `/tarefas-melhoradas/api/empresas?search=${encodeURIComponent(query)}`;
    console.log('üîó URL:', url);
    
    fetch(url, {
        credentials: 'same-origin',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
        .then(response => {
            console.log('üì° Empresas response status:', response.status);
            console.log('üì° Empresas response headers:', response.headers);
            return response.json();
        })
        .then(data => {
            console.log('üìä Empresas data recebida:', data);
            console.log('üìä Empresas encontradas:', data.empresas ? data.empresas.length : 0);
            
            if (data.empresas) {
                mostrarResultadosEmpresasVinculacao(data.empresas);
            } else {
                console.warn('‚ö†Ô∏è Nenhuma empresa encontrada nos dados');
                mostrarResultadosEmpresasVinculacao([]);
            }
        })
        .catch(error => {
            console.error('‚ùå Erro ao buscar empresas:', error);
            console.error('‚ùå Stack trace:', error.stack);
        });
}

// Mostrar resultados de empresas para vincula√ß√£o
function mostrarResultadosEmpresasVinculacao(empresas) {
    console.log('üéØ Mostrando resultados de empresas:', empresas);
    
    const resultsDiv = document.getElementById('empresa-results-vincular');
    console.log('üéØ Results div encontrado:', resultsDiv);
    
    if (!resultsDiv) {
        console.error('‚ùå Results div n√£o encontrado!');
        return;
    }

    if (empresas.length === 0) {
        console.log('üìù Nenhuma empresa encontrada, mostrando mensagem');
        resultsDiv.innerHTML = '<div class="search-item-standard">Nenhuma empresa encontrada</div>';
    } else {
        console.log('üìù Criando HTML para', empresas.length, 'empresas');
        resultsDiv.innerHTML = empresas.map(empresa => `
            <div class="search-item-standard" onclick="selecionarEmpresaVinculacao(${empresa.id}, '${empresa.nome}')">
                <div class="search-item-primary-standard">${empresa.nome}</div>
                <div class="search-item-secondary-standard">${empresa.codigo || ''}</div>
            </div>
        `).join('');
    }
    
    console.log('üéØ Exibindo results div');
    resultsDiv.classList.add('show');
    resultsDiv.style.display = 'block';
    resultsDiv.style.visibility = 'visible';
    resultsDiv.style.opacity = '1';
    console.log('üéØ Results div display:', resultsDiv.style.display);
    console.log('üéØ Results div classes:', resultsDiv.className);
    console.log('üéØ Results div visibility:', window.getComputedStyle(resultsDiv).visibility);
    console.log('üéØ Results div computed display:', window.getComputedStyle(resultsDiv).display);
}

// Selecionar empresa para vincula√ß√£o
function selecionarEmpresaVinculacao(id, nome) {
    const hiddenInput = document.getElementById('empresa_id_vincular');
    const selectedDiv = document.getElementById('empresa-selected-vincular');
    const input = document.getElementById('empresa-search-vincular');
    const resultsDiv = document.getElementById('empresa-results-vincular');

    // Atualizar campos
    hiddenInput.value = id;
    input.value = '';
    resultsDiv.classList.remove('show');
    resultsDiv.style.display = 'none';
    
    // Atualizar visualiza√ß√£o
    selectedDiv.innerHTML = `
        <div class="selected-item-standard">
            <span class="selected-item-text-standard">${nome}</span>
            <button type="button" class="selected-item-remove-standard" onclick="removerEmpresaVinculacao()">&times;</button>
        </div>
    `;
    
    // Mostrar passo de tarefas
    document.getElementById('passo-tarefas').style.display = 'block';
    atualizarBotaoConfirmar();
}

// Remover empresa selecionada
function removerEmpresaVinculacao() {
    document.getElementById('empresa_id_vincular').value = '';
    document.getElementById('empresa-selected-vincular').innerHTML = `
        <div class="selected-item-standard">
            <span class="selected-item-text-standard">Nenhuma empresa selecionada</span>
        </div>
    `;
    document.getElementById('passo-tarefas').style.display = 'none';
    document.getElementById('passo-responsavel').style.display = 'none';
    atualizarBotaoConfirmar();
}

// Buscar tarefas para vincula√ß√£o (filtrando por empresa e j√° vinculadas)
function buscarTarefasVinculacao(query, empresaId) {
    fetch(`/tarefas-melhoradas/api/tarefas/buscar?q=${encodeURIComponent(query)}&empresa_id=${empresaId}`, {
        credentials: 'same-origin',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
        .then(response => {
            console.log('Tarefas vinculacao response status:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('Tarefas vinculacao data:', data);
            if (data.success && data.tarefas) {
                mostrarResultadosTarefasVinculacao(data.tarefas);
            }
        })
        .catch(error => {
            console.error('Erro ao buscar tarefas:', error);
        });
}

// Mostrar resultados de tarefas para vincula√ß√£o
function mostrarResultadosTarefasVinculacao(tarefas) {
    const resultsDiv = document.getElementById('tarefa-results-vincular');
    if (!resultsDiv) return;

    if (tarefas.length === 0) {
        resultsDiv.innerHTML = '<div class="search-item-standard">Nenhuma tarefa encontrada</div>';
    } else {
        resultsDiv.innerHTML = tarefas.map(tarefa => `
            <div class="search-item-standard" onclick="selecionarTarefaVinculacao(${tarefa.id}, '${tarefa.nome}')">
                <div class="search-item-primary-standard">${tarefa.nome}</div>
                <div class="search-item-secondary-standard">${tarefa.tipo} - ${tarefa.setor_nome}</div>
            </div>
        `).join('');
    }
    
    resultsDiv.style.display = 'block';
}

// Selecionar tarefa para vincula√ß√£o
function selecionarTarefaVinculacao(id, nome) {
    const hiddenInput = document.getElementById('tarefa_ids_vincular');
    const selectedDiv = document.getElementById('tarefa-selected-vincular');
    const input = document.getElementById('tarefa-search-vincular');
    const resultsDiv = document.getElementById('tarefa-results-vincular');

    // Obter tarefas j√° selecionadas
    let selectedIds = [];
    if (hiddenInput.value) {
        selectedIds = hiddenInput.value.split(',').map(id => parseInt(id.trim())).filter(id => !isNaN(id));
    }

    // Adicionar se n√£o estiver j√° selecionada
    if (!selectedIds.includes(id)) {
        selectedIds.push(id);
        hiddenInput.value = selectedIds.join(',');

        // Atualizar visualiza√ß√£o
        const newItem = document.createElement('div');
        newItem.className = 'selected-item-standard';
        newItem.innerHTML = `
            <span class="selected-item-text-standard">${nome}</span>
            <button type="button" class="selected-item-remove-standard" onclick="removerTarefaVinculacao(${id})">&times;</button>
        `;
        
        if (selectedDiv.children.length === 1 && selectedDiv.children[0].textContent.includes('Nenhuma')) {
            selectedDiv.innerHTML = '';
        }
        selectedDiv.appendChild(newItem);
    }

    input.value = '';
    resultsDiv.style.display = 'none';
    
    // Mostrar passo de respons√°vel
    document.getElementById('passo-responsavel').style.display = 'block';
    atualizarBotaoConfirmar();
}

// Remover tarefa selecionada
function removerTarefaVinculacao(id) {
    const hiddenInput = document.getElementById('tarefa_ids_vincular');
    let selectedIds = [];
    if (hiddenInput.value) {
        selectedIds = hiddenInput.value.split(',').map(id => parseInt(id.trim())).filter(id => !isNaN(id));
    }
    
    selectedIds = selectedIds.filter(taskId => taskId !== id);
    hiddenInput.value = selectedIds.join(',');
    
    // Remover visualmente
    const selectedDiv = document.getElementById('tarefa-selected-vincular');
    const items = selectedDiv.querySelectorAll('.selected-item');
    items.forEach(item => {
        if (item.querySelector('button').onclick.toString().includes(id)) {
            item.remove();
        }
    });
    
    if (selectedIds.length === 0) {
        selectedDiv.innerHTML = `
            <div class="selected-item-standard">
                <span class="selected-item-text-standard">Nenhuma tarefa selecionada</span>
            </div>
        `;
        document.getElementById('passo-responsavel').style.display = 'none';
    }
    
    atualizarBotaoConfirmar();
}

// Buscar respons√°veis para vincula√ß√£o
function buscarResponsaveisVinculacao(query) {
    fetch(`/api/usuarios?search=${encodeURIComponent(query)}`, {
        credentials: 'same-origin',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
        .then(response => {
            console.log('Responsaveis response status:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('Responsaveis data:', data);
            if (data.success && data.usuarios) {
                // Filtrar apenas colaboradores (usu√°rios normais)
                const colaboradores = data.usuarios.filter(user => user.tipo === 'normal');
                mostrarResultadosResponsaveisVinculacao(colaboradores);
            }
        })
        .catch(error => {
            console.error('Erro ao buscar respons√°veis:', error);
        });
}

// Mostrar resultados de respons√°veis para vincula√ß√£o
function mostrarResultadosResponsaveisVinculacao(responsaveis) {
    const resultsDiv = document.getElementById('responsavel-results-vincular');
    if (!resultsDiv) return;

    if (responsaveis.length === 0) {
        resultsDiv.innerHTML = '<div class="search-item-standard">Nenhum respons√°vel encontrado</div>';
    } else {
        resultsDiv.innerHTML = responsaveis.map(responsavel => `
            <div class="search-item-standard" onclick="selecionarResponsavelVinculacao(${responsavel.id}, '${responsavel.nome}')">
                <div class="search-item-primary-standard">${responsavel.nome}</div>
                <div class="search-item-secondary-standard">${responsavel.tipo || 'Colaborador'}</div>
            </div>
        `).join('');
    }
    
    resultsDiv.style.display = 'block';
}

// Selecionar respons√°vel para vincula√ß√£o
function selecionarResponsavelVinculacao(id, nome) {
    const hiddenInput = document.getElementById('responsavel_id_vincular');
    const selectedDiv = document.getElementById('responsavel-selected-vincular');
    const input = document.getElementById('responsavel-search-vincular');
    const resultsDiv = document.getElementById('responsavel-results-vincular');

    // Atualizar campos
    hiddenInput.value = id;
    input.value = '';
    resultsDiv.style.display = 'none';
    
    // Atualizar visualiza√ß√£o
    selectedDiv.innerHTML = `
        <div class="selected-item-standard">
            <span class="selected-item-text-standard">${nome}</span>
            <button type="button" class="selected-item-remove-standard" onclick="removerResponsavelVinculacao()">&times;</button>
        </div>
    `;
    
    atualizarBotaoConfirmar();
}

// Remover respons√°vel selecionado
function removerResponsavelVinculacao() {
    document.getElementById('responsavel_id_vincular').value = '';
    document.getElementById('responsavel-selected-vincular').innerHTML = `
        <div class="selected-item-standard">
            <span class="selected-item-text-standard">Nenhum respons√°vel selecionado</span>
        </div>
    `;
    atualizarBotaoConfirmar();
}

// Atualizar estado do bot√£o confirmar
function atualizarBotaoConfirmar() {
    const empresaId = document.getElementById('empresa_id_vincular').value;
    const tarefaIds = document.getElementById('tarefa_ids_vincular').value;
    const responsavelId = document.getElementById('responsavel_id_vincular').value;
    const btn = document.getElementById('btnConfirmarVinculacao');
    
    if (empresaId && tarefaIds && responsavelId) {
        btn.disabled = false;
    } else {
        btn.disabled = true;
    }
}

// Limpar modal de vincula√ß√£o
function limparModalVinculacao() {
    document.getElementById('empresa_id_vincular').value = '';
    document.getElementById('tarefa_ids_vincular').value = '';
    document.getElementById('responsavel_id_vincular').value = '';
    
    document.getElementById('empresa-selected-vincular').innerHTML = `
        <div class="selected-item-standard">
            <span class="selected-item-text-standard">Nenhuma empresa selecionada</span>
        </div>
    `;
    
    document.getElementById('tarefa-selected-vincular').innerHTML = `
        <div class="selected-item-standard">
            <span class="selected-item-text-standard">Nenhuma tarefa selecionada</span>
        </div>
    `;
    
    document.getElementById('responsavel-selected-vincular').innerHTML = `
        <div class="selected-item-standard">
            <span class="selected-item-text-standard">Nenhum respons√°vel selecionado</span>
        </div>
    `;
    
    document.getElementById('passo-tarefas').style.display = 'none';
    document.getElementById('passo-responsavel').style.display = 'none';
    document.getElementById('btnConfirmarVinculacao').disabled = true;
}

function fecharModalAlterarTributacao() {
    const modal = document.getElementById('modalAlterarTributacao');
    if (modal) {
        modal.style.display = 'none';
        modal.classList.remove('show');
        modal.setAttribute('aria-hidden', 'true');
        // Remover backdrop
        const backdrop = document.getElementById('modalAlterarTributacao-backdrop');
        if (backdrop) {
            backdrop.remove();
        }
    }
}

function fecharModalVerEmpresa() {
    const modal = document.getElementById('modalVerEmpresa');
    if (modal) {
        modal.style.display = 'none';
        modal.classList.remove('show');
        modal.setAttribute('aria-hidden', 'true');
        // Remover backdrop
        const backdrop = document.getElementById('modalVerEmpresa-backdrop');
        if (backdrop) {
            backdrop.remove();
        }
    }
}

function mostrarModalVerEmpresa() {
    const modal = document.getElementById('modalVerEmpresa');
    if (modal) {
        modal.style.display = 'flex';
        modal.classList.add('show');
        modal.setAttribute('aria-hidden', 'false');
        // Adicionar backdrop
        const backdrop = document.createElement('div');
        backdrop.className = 'modal-backdrop fade show';
        backdrop.id = 'modalVerEmpresa-backdrop';
        document.body.appendChild(backdrop);
    }
}

function mostrarModalAlterarTributacao() {
    const modal = document.getElementById('modalAlterarTributacao');
    if (modal) {
        modal.style.display = 'flex';
        modal.classList.add('show');
        modal.setAttribute('aria-hidden', 'false');
        // Adicionar backdrop
        const backdrop = document.createElement('div');
        backdrop.className = 'modal-backdrop fade show';
        backdrop.id = 'modalAlterarTributacao-backdrop';
        document.body.appendChild(backdrop);
    }
}

function configurarBuscaResponsavelModal() {
    const input = document.getElementById('busca-responsavel-modal');
    const resultados = document.getElementById('resultados-busca-responsavel-modal');
    
    if (!input || !resultados) return;
    
    let timeoutId;
    
    input.addEventListener('input', function() {
        clearTimeout(timeoutId);
        const query = this.value.trim();
        
        if (query.length < 2) {
            resultados.style.display = 'none';
            return;
        }
        
        timeoutId = setTimeout(() => {
            buscarResponsaveisModal(query);
        }, 300);
    });
}

async function buscarResponsaveisModal(query) {
    try {
        const response = await fetch(`/api/usuarios?q=${encodeURIComponent(query)}`);
        const data = await response.json();
        
        if (data.success) {
            mostrarResultadosBuscaResponsavel(data.usuarios);
        }
    } catch (error) {
        console.error('Erro na busca de respons√°veis:', error);
    }
}

function mostrarResultadosBuscaResponsavel(usuarios) {
    const container = document.getElementById('resultados-busca-responsavel-modal');
    if (!container) return;
    
    let html = '';
    usuarios.forEach(usuario => {
        html += `<div class="search-item" onclick="selecionarResponsavel(${usuario.id}, '${usuario.nome}')">${usuario.nome}</div>`;
    });
    
    container.innerHTML = html;
    container.style.display = html ? 'block' : 'none';
}

function selecionarResponsavel(id, nome) {
    const container = document.getElementById('responsavel-selecionado');
    const info = document.getElementById('responsavel-info');
    
    if (container && info) {
        info.innerHTML = `${nome}`;
        container.classList.remove('hidden');
        
        // Esconder resultados da busca
        document.getElementById('resultados-busca-responsavel-modal').style.display = 'none';
        document.getElementById('busca-responsavel-modal').value = nome;
        
        // Armazenar ID do respons√°vel selecionado
        window.responsavelSelecionadoId = id;
    }
}

async function carregarTarefasModal() {
    try {
        const response = await fetch('/tarefas-melhoradas/api/tarefas');
        const data = await response.json();
        
        if (data.success) {
            mostrarTarefasModal(data.tarefas);
        }
    } catch (error) {
        console.error('Erro ao carregar tarefas para modal:', error);
        // Fallback para dados do backend
        mostrarTarefasModalBackend();
    }
}

function mostrarTarefasModal(tarefas) {
    const container = document.getElementById('lista-tarefas-modal');
    if (!container) return;
    
    let html = '';
    tarefas.forEach(tarefa => {
        html += `
            <div class="task-item">
                <input type="checkbox" class="task-checkbox" id="task-${tarefa.id}" value="${tarefa.id}">
                <div class="task-info">
                    <strong>${tarefa.nome}</strong>
                    <div class="task-type">${tarefa.tipo} - ${tarefa.setor || 'N/A'}</div>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

function mostrarTarefasModalBackend() {
    const container = document.getElementById('lista-tarefas-modal');
    if (!container) return;
    
    let html = '';
    
    // Os dados ser√£o carregados via API
    // C√≥digo Jinja2 removido para evitar conflitos JavaScript
    
    container.innerHTML = html;
}

async function confirmarVinculacao() {
    if (!window.responsavelSelecionadoId) {
        showAlertModal('Erro', 'Selecione um respons√°vel primeiro', 'error');
        return;
    }
    
    const tarefasSelecionadas = [];
    document.querySelectorAll('#lista-tarefas-modal input[type="checkbox"]:checked').forEach(checkbox => {
        tarefasSelecionadas.push(parseInt(checkbox.value));
    });
    
    if (tarefasSelecionadas.length === 0) {
        showAlertModal('Erro', 'Selecione pelo menos uma tarefa', 'error');
        return;
    }
    
    try {
        const response = await fetch('/tarefas-melhoradas/api/vincular-responsavel', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                responsavel_id: window.responsavelSelecionadoId,
                tarefas: tarefasSelecionadas
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showAlertModal('Respons√°vel vinculado com sucesso!', 'success', 'Sucesso');
            fecharModalVincularResponsavel();
            carregarResponsaveis();
        } else {
            showAlertModal(data.message, 'error', 'Erro');
        }
    } catch (error) {
        console.error('Erro ao vincular respons√°vel:', error);
        showAlertModal('Erro', 'Erro ao vincular respons√°vel', 'error');
    }
}

function limparModalVinculacao() {
    document.getElementById('busca-responsavel-modal').value = '';
    document.getElementById('responsavel-selecionado').classList.add('hidden');
    document.querySelectorAll('#lista-tarefas-modal input[type="checkbox"]').forEach(checkbox => {
        checkbox.checked = false;
    });
    window.responsavelSelecionadoId = null;
}

function filtrarResponsaveis() {
    // Implementar filtro de respons√°veis
    carregarResponsaveis();
}
</script>

<!-- Modal para Criar Tarefa (VERS√ÉO NOVA E LIMPA) -->
<div class="modal modal-standard" id="modalCriarTarefa" tabindex="-1" style="display: none;">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="fas fa-plus"></i> Nova Tarefa
        </h5>
        <button type="button" class="close" onclick="fecharModalCriarTarefa()">
          <span>&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <form id="form-criar-tarefa">
          <div class="row">
            <div class="col-md-6">
              <div class="form-group">
                <label for="tarefa-nome">Nome da Tarefa *</label>
                <input type="text" id="tarefa-nome" class="form-control" required>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-group">
                <label for="tarefa-tipo">Tipo *</label>
                <select id="tarefa-tipo" class="form-control" required>
                  <option value="">Selecione o tipo</option>
                  <option value="Mensal">Mensal</option>
                  <option value="Trimestral">Trimestral</option>
                  <option value="Anual">Anual</option>
                  <option value="Sazonal">Sazonal</option>
                </select>
              </div>
            </div>
          </div>
          
          <div class="row">
            <div class="col-md-6">
              <div class="form-group">
                <label for="tarefa-setor">Setor *</label>
                <select id="tarefa-setor" class="form-control" required>
                  <option value="">Selecione o setor</option>
                  {% for setor in setores %}
                  <option value="{{ setor.id }}">{{ setor.nome }}</option>
                  {% endfor %}
                </select>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-group">
                <label for="tarefa-tributacao">Tributa√ß√£o *</label>
                <select id="tarefa-tributacao" class="form-control" required>
                  <option value="">Selecione a tributa√ß√£o</option>
                  {% for tributacao in tributacoes %}
                  <option value="{{ tributacao.id }}">{{ tributacao.nome }}</option>
                  {% endfor %}
                </select>
              </div>
            </div>
          </div>
          
          <div class="form-group">
            <label for="tarefa-descricao">Descri√ß√£o</label>
            <textarea id="tarefa-descricao" class="form-control" rows="3"></textarea>
          </div>
          
          <div class="row">
            <div class="col-md-6">
              <div class="form-check">
                <input type="checkbox" id="tarefa-comum" class="form-check-input">
                <label for="tarefa-comum" class="form-check-label">
                  Tarefa Comum (aplica a ambas tributa√ß√µes)
                </label>
              </div>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="fecharModalCriarTarefa()">Cancelar</button>
        <button type="button" class="btn btn-success" onclick="criarTarefa()">
          <i class="fas fa-save"></i> Criar Tarefa
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal para Vincular Respons√°vel -->
<div class="modal modal-standard" id="modalVincularResponsavel" tabindex="-1" style="display: none;">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="fas fa-link"></i> Vincular Respons√°vel
        </h5>
        <button type="button" class="btn-close" onclick="fecharModalVincularResponsavel()">
          <span>&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <!-- Passo 1: Selecionar Empresa -->
        <div class="mb-4">
          <h6><i class="fas fa-building"></i> Passo 1: Selecionar Empresa</h6>
          <div class="search-container">
            <input type="text" id="empresa-search-vincular" class="search-input-standard" placeholder="Digite para buscar empresa..." autocomplete="off">
            <div id="empresa-results-vincular" class="search-results-standard" style="display: none;"></div>
            <input type="hidden" id="empresa_id_vincular" name="empresa_id" value="">
            <div id="empresa-selected-vincular" class="selected-items-container-standard">
              <div class="selected-item-standard">
                <span class="selected-item-text-standard">Nenhuma empresa selecionada</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Passo 2: Selecionar Tarefas (aparece ap√≥s selecionar empresa) -->
        <div class="mb-4" id="passo-tarefas" style="display: none;">
          <h6><i class="fas fa-tasks"></i> Passo 2: Selecionar Tarefas</h6>
          <div class="search-container">
            <input type="text" id="tarefa-search-vincular" class="search-input-standard" placeholder="Digite para buscar tarefa..." autocomplete="off">
            <div id="tarefa-results-vincular" class="search-results-standard" style="display: none;"></div>
            <input type="hidden" id="tarefa_ids_vincular" name="tarefa_ids" value="">
            <div id="tarefa-selected-vincular" class="selected-items-container-standard">
              <div class="selected-item-standard">
                <span class="selected-item-text-standard">Nenhuma tarefa selecionada</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Passo 3: Selecionar Respons√°vel (aparece ap√≥s selecionar tarefas) -->
        <div class="mb-4" id="passo-responsavel" style="display: none;">
          <h6><i class="fas fa-user"></i> Passo 3: Selecionar Respons√°vel</h6>
          <div class="search-container">
            <input type="text" id="responsavel-search-vincular" class="search-input-standard" placeholder="Digite para buscar respons√°vel..." autocomplete="off">
            <div id="responsavel-results-vincular" class="search-results-standard" style="display: none;"></div>
            <input type="hidden" id="responsavel_id_vincular" name="responsavel_id" value="">
            <div id="responsavel-selected-vincular" class="selected-items-container-standard">
              <div class="selected-item-standard">
                <span class="selected-item-text-standard">Nenhum respons√°vel selecionado</span>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="fecharModalVincularResponsavel()">Cancelar</button>
        <button type="button" class="btn btn-primary" onclick="confirmarVinculacao()" id="btnConfirmarVinculacao" disabled>
          <i class="fas fa-link"></i> Vincular
        </button>
      </div>
    </div>
  </div>
</div>

<style>
.wizard-step {
    padding: 20px;
    border: 1px solid #ddd;
    border-radius: 8px;
    margin-bottom: 20px;
}

.wizard-step.active {
    border-color: #007bff;
    background-color: #f8f9fa;
}

.wizard-navigation {
    text-align: center;
    padding: 20px;
    border-top: 1px solid #ddd;
}

.hidden {
    display: none !important;
}

.table-responsive {
    max-height: 400px;
    overflow-y: auto;
}

/* Sistema de busca */
.search-container {
    position: relative;
}

.search-results {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 1px solid #ddd;
    border-top: none;
    max-height: 200px;
    overflow-y: auto;
    z-index: 1000;
    display: none;
}

.search-results .search-item {
    padding: 8px 12px;
    cursor: pointer;
    border-bottom: 1px solid #eee;
}

.search-results .search-item:hover {
    background-color: #f8f9fa;
}

.search-results .search-item:last-child {
    border-bottom: none;
}

.search-results .search-item.selected {
    background-color: #007bff;
    color: white;
}

/* Checkbox personalizado para tarefas */
.task-checkbox {
    margin-right: 8px;
}

.task-item {
    padding: 8px;
    border-bottom: 1px solid #eee;
    display: flex;
    align-items: center;
}

.task-item:last-child {
    border-bottom: none;
}

.task-item:hover {
    background-color: #f8f9fa;
}

.task-info {
    flex: 1;
}

.task-type {
    font-size: 0.8em;
    color: #666;
}
</style>
{% endblock %}
